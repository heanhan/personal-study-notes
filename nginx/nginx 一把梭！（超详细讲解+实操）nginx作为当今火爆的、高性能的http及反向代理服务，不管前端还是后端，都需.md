å‰è¨€ï¼š
===

nginxä½œä¸ºå½“ä»Šç«çˆ†çš„ã€é«˜æ€§èƒ½çš„httpåŠåå‘ä»£ç†æœåŠ¡ï¼Œä¸ç®¡å‰ç«¯è¿˜æ˜¯åç«¯ï¼Œéƒ½éœ€è¦å…¨é¢å»äº†è§£ï¼Œå­¦ä¹ ï¼Œå®æ“ã€‚ä¸€å¥è¯ï¼šææ‡‚nginxå¦‚ä½•ä½¿ç”¨ä»¥åŠå·¥ä½œé€»è¾‘å¯¹äºç¨‹åºå‘˜æ¥è¯´æ˜¯å¿…ä¸å¯å°‘çš„ï¼

æˆ‘ä»¬çœ‹çœ‹æœ¬æ–‡çš„å¤§çº² å…ˆäº†è§£ä¸€ä¸‹æœ¬æ–‡éƒ½è®²äº†å“ªäº›ä¸œè¥¿ï¼Œå¤§çº²å¦‚ä¸‹ï¼š

1.  nginxä»‹ç»
2.  nginxå®‰è£…
3.  nginxç›®å½•ä¸€è§ˆ
4.  nginx.confæ–‡ä»¶è§£è¯»
5.  locationè·¯ç”±åŒ¹é…è§„åˆ™
6.  åå‘ä»£ç†
7.  è´Ÿè½½å‡è¡¡
8.  åŠ¨é™åˆ†ç¦»
9.  è·¨åŸŸ
10.  ç¼“å­˜
11.  é»‘ç™½åå•
12.  nginxé™æµ
13.  httpsé…ç½®
14.  å‹ç¼©
15.  å…¶ä»–ä¸€äº›å¸¸ç”¨æŒ‡ä»¤ä¸è¯´æ˜
16.  é‡è¯•ç­–ç•¥
17.  æœ€åæ€»ç»“

**ä¸€äº›è¯´æ˜ï¼š**

1.  ç³»ç»Ÿï¼š centos7
2.  æœ¬æ–‡ä½¿ç”¨nginxç‰ˆæœ¬ï¼šnginx/1.24.0
3.  å…³äºnginxå¦‚ä½•å®‰è£…ï¼ˆæœ¬æ–‡ä¸å†èµ˜è¿°ï¼‰ï¼Œå‚è€ƒä¹‹å‰æˆ‘çš„ä¸€ç¯‡æ–‡ç« ï¼š[Centos7ä¸­å®‰è£…nginx](https://juejin.cn/post/7293176193322729510 "https://juejin.cn/post/7293176193322729510")
4.  åœ¨å­¦ä¹ nginxå‰ï¼Œæœ€å¥½éœ€è¦çŸ¥é“æˆ–è€…äº†è§£äº‹ä»¶é©±åŠ¨æ€æƒ³ä»¥åŠå‡ ç§å¸¸è§å¤šè·¯å¤ç”¨I/Oæ¨¡å‹å’ŒReactoræ¨¡å¼ï¼Œè¿™æ ·ä½ æ‰èƒ½ä»åº•å±‚ æ›´æ·±åˆ»çš„ç†è§£nginxçš„æ¶æ„è®¾è®¡

1ã€nginx ä»‹ç»
==========

ä¸ºäº†æœ‰ä¸€ä¸ªå…¨é¢çš„è®¤çŸ¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹nginxçš„æ¶æ„ä»¥åŠä¸€äº›ç‰¹ç‚¹ã€‚

1.1ã€nginx ç‰¹ç‚¹
------------

1.  å¤„ç†å“åº”è¯·æ±‚å¿«ï¼ˆå¼‚æ­¥éé˜»å¡I/Oï¼Œé›¶æ‹·è´ï¼Œmmapï¼Œç¼“å­˜æœºåˆ¶ï¼‰
2.  æ‰©å±•æ€§å¥½ï¼ˆæ¨¡å—åŒ–è®¾è®¡ï¼‰
3.  å†…å­˜æ¶ˆè€—ä½ï¼ˆå¼‚æ­¥éé˜»å¡ï¼Œå¤šé˜¶æ®µå¤„ç†ï¼‰
4.  å…·æœ‰å¾ˆé«˜çš„å¯é æ€§ï¼ˆæ— æ•°æ¬¡çš„ç”Ÿäº§éªŒè¯ï¼Œå¾ˆå¤šå¤´éƒ¨å…¬å¸éƒ½åœ¨ç”¨ï¼‰
5.  çƒ­éƒ¨ç½²
6.  é«˜å¹¶å‘è¿æ¥ï¼ˆäº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼Œå¤šè¿›ç¨‹æœºåˆ¶ï¼‰
7.  è‡ªç”±çš„BSDè®¸å¯åè®®ï¼ˆå¯ä»¥è‡ªå·±ä¿®æ”¹ä»£ç åå‘å¸ƒï¼ŒåŒ…å®¹æ€§æå¼ºï¼‰

1.2ã€nginx æ¶æ„
------------

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2db0016998d447f1bf0c657454180238~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1986&h=1182&s=483033&e=png&b=f4f4f4) ä»ä¸Šè¾¹è¿™å¼ å›¾ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€è§ˆnginxçš„æ¶æ„è®¾è®¡ï¼Œé¦–å…ˆæˆ‘ä»¬å¯ä»¥ç›´è§‚å¾—å‡º`nginxçš„å‡ å¤§ç‰¹ç‚¹ï¼š`

1.  **äº‹ä»¶é©±åŠ¨&å¼‚æ­¥éé˜»å¡ï¼š**
    
    > æœ¬è´¨æ¥è¯´ï¼Œ**äº‹ä»¶é©±åŠ¨æ˜¯ä¸€ç§æ€æƒ³ï¼ˆäº‹å®ä¸Šå®ƒä¸ä»…ä»…å±€é™äºç¼–ç¨‹ï¼‰** ï¼Œäº‹ä»¶é©±åŠ¨æ€æƒ³æ˜¯å®ç° **å¼‚æ­¥éé˜»å¡ç‰¹æ€§** çš„ä¸€ä¸ªé‡è¦æ‰‹æ®µã€‚å¯¹äºwebæœåŠ¡å™¨æ¥è¯´ï¼Œé€ æˆæ€§èƒ½æ‹‰èƒ¯ä¸æ”¯æŒé«˜å¹¶å‘çš„å¸¸è§åŸå› å°±æ˜¯ç”±äºä½¿ç”¨äº†ä¼ ç»Ÿçš„I/Oæ¨¡å‹é€ æˆåœ¨`å†…æ ¸æ²¡æœ‰å¯è¯»/å¯å†™äº‹ä»¶ï¼ˆæˆ–è€…è¯´æ²¡æœ‰æ•°æ®å¯ä¾›ç”¨æˆ·è¿›ç¨‹è¯»å†™ï¼‰æ—¶`ï¼Œ**ç”¨æˆ·çº¿ç¨‹** `ä¸€ç›´åœ¨ç­‰å¾…`ï¼ˆå…¶ä»–äº‹æƒ…å•¥ä¹Ÿå¹²ä¸äº†å°±æ˜¯å¹²ç­‰ç­‰å¾…å†…æ ¸ä¸Šçš„æ•°æ®å¯è¯»/å¯å†™ï¼‰ï¼Œè¿™æ ·çš„è¯å…¶å®æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼ˆps:çº¿ç¨‹åœ¨Linuxç³»ç»Ÿä¹Ÿæ˜¯è¿›ç¨‹ï¼‰å¯¹åº”ä¸€ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚æ˜¯æ— é™çš„ï¼Œè€Œçº¿ç¨‹æ˜¯æœ‰é™çš„ä»è€Œä¹Ÿå°±å½¢æˆäº†å¹¶å‘ç“¶é¢ˆã€‚è€Œå¤§ä½¬ä»¬ä¸ºäº†è§£å†³æ­¤ç±»é—®é¢˜ï¼Œè¿ç”¨äº†äº‹ä»¶é©±åŠ¨æ€æƒ³æ¥å¯¹ä¼ ç»ŸI/Oæ¨¡å‹åšä¸ªæ”¹é€ ï¼Œå³åœ¨å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚åï¼Œç”¨æˆ·çº¿ç¨‹`ä¸å†é˜»å¡ç­‰å¾…å†…æ ¸æ•°æ®å°±ç»ª`ï¼Œè€Œæ˜¯`ç«‹å³è¿”å›`ï¼ˆå¯ä»¥å»æ‰§è¡Œå…¶ä»–ä¸šåŠ¡é€»è¾‘æˆ–è€…ç»§ç»­å¤„ç†å…¶ä»–è¯·æ±‚ï¼‰ã€‚å½“å†…æ ¸çš„I/Oæ“ä½œå®Œæˆåï¼Œ`å†…æ ¸ç³»ç»Ÿ`ä¼šå‘ç”¨æˆ·çº¿ç¨‹`å‘é€ä¸€ä¸ªäº‹ä»¶é€šçŸ¥`ï¼Œç”¨æˆ·çº¿ç¨‹æ‰æ¥å¤„ç†è¿™ä¸ªè¯»/å†™æ“ä½œï¼Œä¹‹åæ‹¿åˆ°æ•°æ®å†åšäº›å…¶ä»–ä¸šåŠ¡åå“åº”ç»™å®¢æˆ·ç«¯ï¼Œä»è€Œå®Œæˆä¸€æ¬¡å®¢æˆ·ç«¯è¯·æ±‚çš„å¤„ç†ã€‚äº‹ä»¶é©±åŠ¨çš„I/Oæ¨¡å‹ä¸­ï¼Œç¨‹åºä¸å¿…é˜»å¡ç­‰å¾…I/Oæ“ä½œçš„å®Œæˆï¼Œä¹Ÿæ— éœ€ä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä»è€Œæé«˜äº†ç³»ç»Ÿçš„å¹¶å‘å¤„ç†èƒ½åŠ›å’Œå“åº”é€Ÿåº¦ã€‚`äº‹ä»¶é©±åŠ¨å‹çš„I/Oæ¨¡å‹é€šå¸¸ä¹Ÿè¢«è¢«ç§°ä¸ºI/Oå¤šè·¯å¤ç”¨`ï¼Œå³è¿™ç§æ¨¡å‹å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå¤„ç†å¤šä¸ªè¿æ¥ï¼ˆå¤ç”¨å°±æ˜¯æŒ‡å¤šä¸ªè¿æ¥å¤ç”¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå¤šè·¯ä¹Ÿå³æ‰€è°“çš„ å¤šä¸ªè¿æ¥ï¼‰ï¼Œé€šè¿‡è¿™ç§æ–¹å¼é¿å…äº†çº¿ç¨‹é—´åˆ‡æ¢çš„å¼€é”€ï¼ŒåŒæ—¶ä¹Ÿä½¿å¾—ç”¨æˆ·çº¿ç¨‹ä¸å†è¢«é˜»å¡ï¼Œæé«˜äº†ç³»ç»Ÿçš„æ€§èƒ½å’Œå¯é æ€§ã€‚nginxæ”¯æŒäº‹ä»¶é©±åŠ¨æ˜¯å› ä¸ºä»–åˆ©ç”¨äº†æ“ä½œç³»ç»Ÿæä¾›çš„I/Oå¤šè·¯å¤ç”¨æ¥å£ï¼Œå¦‚Linuxç³»ç»Ÿä¸­ï¼Œå¸¸ç”¨çš„I/Oå¤šè·¯å¤ç”¨æ¥å£æœ‰select/pollï¼Œepollã€‚è¿™äº›æ¥å£å¯ä»¥ç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€å˜åŒ–ï¼Œå½“æ–‡ä»¶æè¿°ç¬¦å¯è¯»æˆ–å¯å†™æ—¶ï¼Œå°±ä¼šå‘ç”¨æˆ·çº¿ç¨‹å‘é€ä¸€ä¸ªäº‹ä»¶é€šçŸ¥ã€‚ç”¨æˆ·çº¿ç¨‹é€šè¿‡äº‹ä»¶å¤„ç†æœºåˆ¶ï¼ˆè¯»å–/å†™å…¥æ•°æ®ï¼‰æ¥å¤„ç†è¿™ä¸ªäº‹ä»¶ï¼Œä¹‹åè¿›è¡Œå¯¹åº”çš„ä¸šåŠ¡é€»è¾‘å®Œäº†è¿›è¡Œå“åº”ã€‚**ç®€å•ä¸€å¥è¯æ¦‚æ‹¬ï¼š** `äº‹ä»¶é©±åŠ¨æœºåˆ¶å°±æ˜¯æŒ‡å½“æœ‰è¯»/å†™/è¿æ¥äº‹ä»¶å°±ç»ªæ—¶ å†å»åšè¯»/å†™/æ¥å—è¿æ¥è¿™äº›äº‹æƒ…ï¼Œè€Œä¸æ˜¯ä¸€ç›´åœ¨é‚£é‡Œå‚»å‚»çš„ç­‰ï¼Œä¹Ÿæ­£åº”äº†ä»–çš„åè¯ï¼š ã€äº‹ä»¶é©±åŠ¨ï¼ã€‘ï¼ŒåŸºäºäº‹ä»¶é©±åŠ¨æ€æƒ³è®¾è®¡çš„å¤šè·¯å¤ç”¨I/Oï¼ˆå¦‚select/pollï¼Œepollï¼‰ï¼Œç›¸å¯¹äºä¼ ç»ŸI/Oæ¨¡å‹ï¼Œè¾¾åˆ°äº†å¼‚æ­¥éé˜»å¡çš„æ•ˆæœï¼`
    > 
    > æ—¢ç„¶æåˆ°äº†select/poll,epoll é‚£ä¹ˆæˆ‘ä»¬å°±ç®€å•è¯´ä¸€ä¸‹ï¼ˆæ³¨æ„æˆ‘è¿™é‡Œæ˜¯ç®€å•æè¿°ï¼Œåç»­æœ‰æ—¶é—´ä¼šå¯¹ç›¸å…³çŸ¥è¯†ç‚¹ä»æºç å±‚é¢åšä¸ªç³»ç»Ÿçš„æ•´ç†å’Œå›¾è§£ï¼‰ï¼š
    > 
    > **selectï¼š** å°†å·²è¿æ¥çš„ Socket éƒ½æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œç„¶åç”¨æˆ·æ€è°ƒç”¨ select å‡½æ•°å°†æ–‡ä»¶æè¿°ç¬¦é›†åˆæ‹·è´åˆ°å†…æ ¸é‡Œï¼Œè®©å†…æ ¸æ¥æ£€æŸ¥æ˜¯å¦æœ‰ç½‘ç»œäº‹ä»¶äº§ç”Ÿï¼Œæ£€æŸ¥çš„æ–¹å¼å¾ˆç²—æš´ï¼Œå°±æ˜¯é€šè¿‡éå†æ–‡ä»¶æè¿°ç¬¦é›†åˆçš„æ–¹å¼ï¼Œå½“æ£€æŸ¥åˆ°æœ‰äº‹ä»¶äº§ç”Ÿåï¼Œå°†æ­¤ Socket æ ‡è®°ä¸ºå¯è¯»æˆ–å¯å†™ï¼Œ æ¥ç€å†æŠŠæ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆæ‹·è´å›ç”¨æˆ·æ€é‡Œï¼Œç„¶åç”¨æˆ·æ€è¿˜éœ€è¦å†é€šè¿‡éå†çš„æ–¹æ³•æ‰¾åˆ°å¯è¯»æˆ–å¯å†™çš„ Socketï¼Œç„¶åå†å¯¹å…¶å¤„ç†ã€‚
    > 
    > **pollï¼š** pollå‡½æ•°çš„è¯å…¶å®å’Œselectå¤§å·®ä¸å·®ï¼Œå”¯ä¸€åŒºåˆ«å¯èƒ½å°±æ˜¯socketåˆ—è¡¨çš„ç»“æ„æœ‰æ‰€ä¸åŒï¼Œä¸å†å—FD\_SETSIZEçš„é™åˆ¶ã€‚è¿™é‡Œå°±ä¸å¤šè¯´äº†ã€‚
    > 
    > **epollï¼š** epollåœ¨å‰è¾¹ä¸¤è€…çš„åŸºç¡€ä¸Šåšäº†å¾ˆå¤§çš„ä¼˜åŒ–ï¼Œselect/polléƒ½éœ€è¦éå†æ•´ä¸ªsocketåˆ—è¡¨ï¼Œå½“æ£€æµ‹åˆ°ä¼ å…¥çš„socketå¯è¯»/å¯å†™æ—¶ï¼Œåˆ™copy socketåˆ—è¡¨ç»™ç”¨æˆ·ç©ºé—´ï¼Œç”¨æˆ·æ€ä»ç„¶éœ€è¦éå†ï¼ˆå› ä¸ºå†…æ ¸copyç»™ç”¨æˆ·æ€çš„æ˜¯æ•´ä¸ªsocketåˆ—è¡¨ï¼‰ ï¼Œè€Œepollåˆ™æ˜¯é€šè¿‡çº¢é»‘æ ‘ç»“æ„å°†éœ€è¦ç›‘æ§çš„socketæ’å…¥åˆ°è¿›å»ï¼Œç„¶åå½“æœ‰socketå¯è¯»æ—¶ä¼šé€šè¿‡å›è°ƒæœºåˆ¶æ¥å°†å…¶æ·»åŠ åˆ°å¯è¯»åˆ—è¡¨ä¸­ï¼Œç„¶åå†…æ ¸å°†å¯è¯»åˆ—è¡¨copyç»™ç”¨æˆ·æ€å³å¯(æ®è¯´æ­¤å¤„ä½¿ç”¨äº†mmapè¿™é‡Œæˆ‘ä»¬ä¸å»éªŒè¯æ¢ç©¶ï¼Œåç»­å†™ç›¸å…³æ–‡ç« æ—¶åœ¨æ·±ç©¶å§)ï¼Œæ•´ä¸ªè¿‡ç¨‹å°‘äº†æ— æ•ˆçš„éå†ä»¥åŠä¸ç”¨copyæ•´ä¸ªsocketé›†åˆã€‚
    
2.  **å¤šè¿›ç¨‹æœºåˆ¶ï¼š**
    
    > å¦å¤–å¯ä»¥å¾—çŸ¥nginxæœ‰ä¸¤ç§ç±»å‹çš„è¿›ç¨‹ï¼Œä¸€ç§æ˜¯Masterä¸»è¿›ç¨‹ï¼Œä¸€ç§æ˜¯Workerå·¥ä½œè¿›ç¨‹ã€‚ä¸»è¿›ç¨‹ä¸»è¦è´Ÿè´£3é¡¹å·¥ä½œï¼š`åŠ è½½é…ç½®`ã€`å¯åŠ¨å·¥ä½œè¿›ç¨‹`åŠ`éåœå‡çº§`ã€‚å¦å¤–workè¿›ç¨‹æ˜¯ä¸»è¿›ç¨‹å¯åŠ¨åï¼Œforkè€Œæ¥çš„ã€‚å‡è®¾ Nginx forkäº†å¤šä¸ª(å…·ä½“åœ¨äºä½ çš„é…ç½®)Workerè¿›ç¨‹ï¼Œå¹¶ä¸”åœ¨Masterè¿›ç¨‹ä¸­é€šè¿‡ socket å¥—æ¥å­—ç›‘å¬ï¼ˆlistenï¼‰80ç«¯å£ã€‚ç„¶åæ¯ä¸ªworkerè¿›ç¨‹éƒ½å¯ä»¥å» accept è¿™ä¸ªç›‘å¬çš„ socketã€‚ å½“ä¸€ä¸ªè¿æ¥è¿›æ¥åï¼Œæ‰€æœ‰Workerè¿›ç¨‹ï¼Œéƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªWorkerè¿›ç¨‹å¯ä»¥ accept è¿™ä¸ªè¿æ¥ï¼Œå…¶å®ƒçš„åˆ™ accept å¤±è´¥ï¼ŒNginx ä¿è¯åªæœ‰ä¸€ä¸ªWorkerå»acceptçš„æ–¹å¼å°±æ˜¯åŠ é”ï¼ˆaccept\_mutexï¼‰ã€‚æœ‰äº†é”ä¹‹åï¼Œåœ¨åŒä¸€æ—¶åˆ»ï¼Œå°±åªä¼šæœ‰ä¸€ä¸ªWorkerè¿›ç¨‹å» accpet è¿æ¥ï¼Œåœ¨ Worker è¿›ç¨‹æ‹¿åˆ° Http è¯·æ±‚åï¼Œå°±å¼€å§‹æŒ‰ç…§workerè¿›ç¨‹å†…çš„é¢„ç½®æ¨¡å—å»å¤„ç†è¯¥ Http è¯·æ±‚ï¼Œæœ€åè¿”å›å“åº”ç»“æœå¹¶æ–­å¼€è¿æ¥ã€‚å…¶å®å¦‚æœç†Ÿæ‚‰reactoræ¨¡å‹ä½ ä¼šå‘ç°ï¼Œnginxçš„è®¾è®¡æœ‰reactorçš„å½±å­ï¼Œåªä¸è¿‡reactorçš„ä¸»reactoræ˜¯ä¼šè´Ÿè´£acceptçš„ï¼Œè€Œnginxçš„ä¸»è¿›ç¨‹ï¼ˆå¯¹åº”ä¸»reactorï¼‰ æ˜¯ä¸ä¼šå»acceptçš„ï¼Œè€Œæ˜¯äº¤ç»™äº†workerè¿›ç¨‹æ¥å¤„ç†ã€‚
    > 
    > workerè¿›ç¨‹é™¤äº†acceptè¿æ¥ä¹‹å¤–ï¼Œè¿˜ä¼šæ‰§è¡Œï¼šç½‘ç»œè¯»å†™ã€å­˜å‚¨è¯»å†™ã€å†…å®¹ä¼ è¾“ã€ä»¥åŠè¯·æ±‚åˆ†å‘ç­‰ç­‰ã€‚è€Œå…¶ä»£ç çš„æ¨¡å—åŒ–è®¾è®¡ï¼Œä¹Ÿä½¿å¾—æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦å¯¹åŠŸèƒ½æ¨¡å— è¿›è¡Œé€‚å½“çš„é€‰æ‹©å’Œä¿®æ”¹ï¼Œç¼–è¯‘æˆç¬¦åˆç‰¹å®šéœ€è¦/ä¸šåŠ¡çš„æœåŠ¡å™¨
    
3.  **proxy cacheï¼ˆæœåŠ¡ç«¯ç¼“å­˜ï¼‰ï¼š**
    
    > proxy cacheä¸»è¦å®ç° nginx æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯æ•°æ®è¯·æ±‚çš„å¿«é€Ÿå“åº”ã€‚nginx æœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°è¢«ä»£ç†æœåŠ¡å™¨çš„å“åº”æ•°æ®ä¹‹åï¼Œä¸€æ–¹é¢å°†æ•°æ®ä¼ é€’ç»™å®¢æˆ·ç«¯ï¼Œå¦ä¸€æ–¹é¢æ ¹æ®proxy cacheçš„é…ç½®å°†è¿™äº›æ•°æ®ç¼“å­˜åˆ°æœ¬åœ°ç¡¬ç›˜ä¸Šã€‚å½“å®¢æˆ·ç«¯å†æ¬¡è®¿é—®ç›¸åŒçš„æ•°æ®æ—¶ï¼ŒnginxæœåŠ¡å™¨ç›´æ¥ä»ç¡¬ç›˜æ£€ç´¢åˆ°ç›¸åº”çš„æ•°æ®è¿”å›ç»™ç”¨æˆ·ï¼Œä»è€Œå‡å°‘ä¸è¢«ä»£ç†æœåŠ¡å™¨äº¤äº’çš„æ—¶é—´ã€‚åœ¨ç¼“å­˜æ•°æ®æ—¶ï¼Œè¿ç”¨äº†é›¶æ‹·è´ä»¥åŠmmapæŠ€æœ¯ï¼Œä½¿å¾—æ•°æ®copyæ€§èƒ½å¤§å¹…æå‡ã€‚
    
4.  **åå‘ä»£ç†ï¼š**
    
    > nginxçš„å¼ºå¤§ä¹‹å¤„å…¶ä¸­ä¸€ä¸ªå°±æ˜¯ä»–çš„åå‘ä»£ç†ï¼Œé€šè¿‡åå‘ä»£ç†ï¼Œå¯ä»¥éšè—çœŸæ­£çš„æœåŠ¡ï¼Œå¢åŠ å…¶å®‰å…¨æ€§ï¼ŒåŒæ—¶ä¾¿äºç»Ÿä¸€ç®¡ç†å¤„ç†è¯·æ±‚ï¼Œå¦å¤–å¯ä»¥å¾ˆå®¹æ˜“çš„åšä¸ªè´Ÿè½½å‡è¡¡ï¼Œæ›´å¥½çš„é¢å¯¹é«˜å¹¶å‘çš„åœºæ™¯ã€‚
    

1.3ã€nginxæ¨¡å—
-----------

> nginxæœåŠ¡å™¨ç”±nå¤šä¸ªæ¨¡å—ç»„æˆï¼Œæ¯ä¸ªæ¨¡å—å°±æ˜¯ä¸€ä¸ªåŠŸèƒ½ï¼ŒæŸä¸ªæ¨¡å—åªè´Ÿè´£è‡ªèº«çš„åŠŸèƒ½ï¼Œæ‰€ä»¥è¯´å¯¹äº **`â€œé«˜å†…èšï¼Œä½è€¦åˆâ€œ`** çš„ç¼–ç¨‹è§„åˆ™ï¼Œåœ¨`nginx`èº«ä¸Šå¯è°“`ä½“ç°çš„æ·‹æ¼“å°½è‡´`ã€‚

**nginxæ¨¡å—ç¤ºæ„å›¾å¦‚ä¸‹ï¼š** ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9abd5af68a4f4581b34e14af6810e3a7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1306&h=928&s=154272&e=png&b=f8f6f2)

*   **æ ¸å¿ƒæ¨¡å—** ï¼šæ˜¯nginx æœåŠ¡å™¨æ­£å¸¸è¿è¡Œå¿…ä¸å¯å°‘çš„æ¨¡å—ï¼Œæä¾›é”™è¯¯æ—¥å¿—è®°å½•ã€é…ç½®æ–‡ä»¶è§£æã€äº‹ä»¶é©±åŠ¨ æœºåˆ¶ã€è¿›ç¨‹ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½
*   **æ ‡å‡†HTTPæ¨¡å—** ï¼šæä¾› HTTP åè®®è§£æç›¸å…³çš„åŠŸèƒ½ï¼Œå¦‚ï¼šç«¯å£é…ç½®ã€ç½‘é¡µç¼–ç è®¾ç½®ã€HTTP å“åº”å¤´è®¾ ç½®ç­‰
*   **å¯é€‰HTTPæ¨¡å—** ï¼šä¸»è¦ç”¨äºæ‰©å±•æ ‡å‡†çš„ HTTP åŠŸèƒ½ï¼Œè®©nginxèƒ½å¤„ç†ä¸€äº›ç‰¹æ®Šçš„æœåŠ¡ï¼Œå¦‚ï¼šFlash å¤š åª’ä½“ä¼ è¾“ã€è§£æ GeoIP è¯·æ±‚ã€SSL æ”¯æŒç­‰
*   **é‚®ä»¶æœåŠ¡æ¨¡å—** ï¼šä¸»è¦ç”¨äºæ”¯æŒ nginx çš„é‚®ä»¶æœåŠ¡ï¼ŒåŒ…æ‹¬å¯¹ POP3 åè®®ã€IMAP åè®®å’Œ SMTP åè®®çš„æ”¯æŒ
*   **ç¬¬ä¸‰æ–¹æ¨¡å—** ï¼šæ˜¯ä¸ºäº†æ‰©å±• Nginx æœåŠ¡å™¨åº”ç”¨ï¼Œå®Œæˆå¼€å‘è€…è‡ªå®šä¹‰åŠŸèƒ½ï¼Œå¦‚ï¼šJson æ”¯æŒã€Lua æ”¯æŒç­‰

1.4ã€nginxå¸¸è§åº”ç”¨åœºæ™¯
---------------

nginxå¸¸ç”¨åœºæ™¯æŒºå¤šçš„ï¼Œæ¯”å¦‚ï¼š

*   åå‘ä»£ç†
*   è´Ÿè½½å‡è¡¡
*   ç¼“å­˜
*   é™æµ
*   é»‘/ç™½åå•
*   é™æ€èµ„æºæœåŠ¡
*   åŠ¨é™åˆ†ç¦»
*   é˜²ç›—é“¾
*   è·¨åŸŸ
*   é«˜å¯ç”¨
*   .......

å…¶ä¸­æˆ‘è®¤ä¸º **æœ€æœ€** åŸºç¡€çš„ä¹Ÿæ˜¯åº”ç”¨æœ€å¤šçš„å°±æ˜¯ **åå‘ä»£ç†**ï¼Œè¿™é‡Œæˆ‘ä»¬ç”»ä¸ªå›¾ç®€å•çœ‹ä¸‹ä»€ä¹ˆæ˜¯åå‘ä»£ç† ï¼ˆpsï¼šå…¶ä»–çš„é‚£äº›ä½¿ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬å…ˆä¸åšå±•å¼€ï¼Œæ”¾åˆ°ä¸‹è¾¹ä¸€ä¸ªä¸ªå“”å“”ã€‚ï¼‰

æ‰€è°“åå‘ä»£ç†ï¼Œå…¶å®å¾ˆå¥½ç†è§£å°±æ˜¯ä»£ç†çš„æœåŠ¡ç«¯ï¼ˆä¸ä¹‹å¯¹åº”çš„æ­£å‘ä»£ç†ä¸€èˆ¬ä»£ç†çš„æ˜¯å®¢æˆ·ç«¯ï¼‰ï¼Œ**nginxåå‘ä»£ç†å¦‚ä¸‹ç¤ºæ„ï¼š** ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12feb26340c74998bd7917f1a21d83fa~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1906&h=1212&s=132766&e=png&b=fdfdfd)

* * *

**å¥½äº†ä»‹ç»äº†è¿™ä¹ˆå¤šï¼Œæƒ³å¿…åˆ°è¿™é‡Œåº”è¯¥å¯¹nginxæœ‰ä¸ªå¤§ä½“çš„äº†è§£äº†å§ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å®‰è£…å¹¶ä¸€ä¸ªä¸€ä¸ªçš„åˆ†æä»‹ç»nginxçš„çŸ¥è¯†ç‚¹ã€‚**

2ã€nginxå®‰è£…
=========

å…³äºnginxçš„å®‰è£…åœ¨è¿™é‡Œä¸å†èµ˜è¿°ï¼Œå‚è€ƒæˆ‘ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« ï¼š[Centos7ä¸­å®‰è£…nginx](https://juejin.cn/post/7293176193322729510 "https://juejin.cn/post/7293176193322729510")

3ã€nginxç›®å½•ä¸€è§ˆ
===========

æˆ‘ä»¬ä½¿ç”¨ tree /usr/local/nginx/ -L 2 å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹nginxçš„ç›®å½•ï¼Œå¯¹å…¶ç»“æ„æœ‰ä¸ªåˆæ­¥çš„è®¤è¯†ï¼š

```shell
[root@localhost /]# tree /opt/nginx/ -L 2
/usr/local/nginx/
â”œâ”€â”€ conf                        #å­˜æ”¾ä¸€ç³»åˆ—é…ç½®æ–‡ä»¶çš„ç›®å½•
â”‚Â Â  â”œâ”€â”€ fastcgi.conf           #fastcgiç¨‹åºç›¸å…³é…ç½®æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ fastcgi.conf.default   #fastcgiç¨‹åºç›¸å…³é…ç½®æ–‡ä»¶å¤‡ä»½
â”‚Â Â  â”œâ”€â”€ fastcgi_params         #fastcgiç¨‹åºå‚æ•°æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ fastcgi_params.default #fastcgiç¨‹åºå‚æ•°æ–‡ä»¶å¤‡ä»½
â”‚Â Â  â”œâ”€â”€ koi-utf           #ç¼–ç æ˜ å°„æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ koi-win           #ç¼–ç æ˜ å°„æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ mime.types        #åª’ä½“ç±»å‹æ§åˆ¶æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ mime.types.default#åª’ä½“ç±»å‹æ§åˆ¶æ–‡ä»¶å¤‡ä»½
â”‚Â Â  â”œâ”€â”€ nginx.conf        #ä¸»é…ç½®æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ nginx.conf.default#ä¸»é…ç½®æ–‡ä»¶å¤‡ä»½
â”‚Â Â  â”œâ”€â”€ scgi_params      #scgiç¨‹åºç›¸å…³é…ç½®æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ scgi_params.default #scgiç¨‹åºç›¸å…³é…ç½®æ–‡ä»¶å¤‡ä»½
â”‚Â Â  â”œâ”€â”€ uwsgi_params       #uwsgiç¨‹åºç›¸å…³é…ç½®æ–‡ä»¶
â”‚Â Â  â”œâ”€â”€ uwsgi_params.default#uwsgiç¨‹åºç›¸å…³é…ç½®æ–‡ä»¶å¤‡ä»½
â”‚Â Â  â””â”€â”€ win-utf          #ç¼–ç æ˜ å°„æ–‡ä»¶
â”œâ”€â”€ html                 #å­˜æ”¾ç½‘é¡µæ–‡æ¡£
â”‚Â Â  â”œâ”€â”€ 50x.html         #é”™è¯¯é¡µç æ˜¾ç¤ºç½‘é¡µæ–‡ä»¶
â”‚Â Â  â””â”€â”€ index.html       #ç½‘é¡µçš„é¦–é¡µæ–‡ä»¶
â”œâ”€â”€ sbin                #å­˜æ”¾å¯åŠ¨ç¨‹åº
â”‚Â Â  â”œâ”€â”€ nginx           #nginxå¯åŠ¨ç¨‹åº

3 directories, 18 files
```

ä»è¾“å‡ºå¯ä»¥çœ‹åˆ°nginxåˆ†çš„å¾ˆæ¸…æ™°ï¼Œæœ‰é…ç½®ç›®å½•ï¼Œhtmlç›®å½•ï¼Œlogç›®å½•ï¼Œå¯åŠ¨ç¨‹åºç›®å½•ã€‚

*   **å…³äºç›®å½•çš„ä¸€ç‚¹å°è¯´æ˜ï¼š**
    
    ä¸Šè¾¹çš„ä»…ä»…æ˜¯nginxçš„ä¸»ç›®å½•ï¼Œäº‹å®ä¸Šï¼Œç”Ÿæ•ˆçš„ä¸»é…ç½®æ–‡ä»¶ä¸€å®šæ˜¯/usr/local/nginx/conf.conf ï¼Ÿè¿™ä¸ä¸€å®šï¼Œè€Œæ˜¯å–å†³äºä½ å¯åŠ¨nginxæ—¶å€™æœ‰æ²¡æœ‰æŒ‡å®šnginx.confï¼Œå®é™…ä½¿ç”¨ä¸­æˆ‘å‘ç°æˆ‘æœºå™¨ä¸Šæœ‰å¥½å‡ ä¸ªåœ°æ–¹éƒ½å­˜åœ¨nginx.confæ–‡ä»¶ï¼Œä½¿ç”¨ locate nginx.confçœ‹ä¸€ä¸‹ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/26191e37310e42e4ae8e166927959eaf~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=904&h=186&s=29866&e=png&b=010101) é‚£å¦‚ä½•ç¡®å®šnginxå½“å‰ç”Ÿæ•ˆçš„æ˜¯å“ªä¸ªnginx.confå‘¢ï¼Œå¾ˆç®€å•ä½¿ç”¨nginx -Tå‘½ä»¤å³å¯æŸ¥çœ‹å½“å‰ç”Ÿæ•ˆçš„nginx.confï¼Œå¦‚ä¸‹ï¼šå¯ä»¥çœ‹åˆ°æˆ‘å½“å‰ç”Ÿæ•ˆçš„æ˜¯ /etc/nginx/nginx.confè¿™ä¸ªæ–‡ä»¶ï¼ˆæˆ‘æ˜¯ä½¿ç”¨çš„ systemctl start nginx.serviceå‘½ä»¤å¯åŠ¨çš„ï¼ŒæœªæŒ‡å®šç”¨å“ªä¸ªæ–‡ä»¶å¯åŠ¨ï¼Œæ‰€ä»¥å¯ä»¥çœ‹å‡ºé»˜è®¤ä½¿ç”¨çš„æ˜¯ /etc/nginx/nginx.confè¿™ä¸ªé…ç½®æ–‡ä»¶ï¼‰ ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7cd376f7eec1444298216905fb5d2669~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1116&h=196&s=26459&e=png&b=010101) å¦å¤–è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯nginxçš„æ—¥å¿—ï¼Œæˆ‘å‘ç°æˆ‘çš„nginxæ—¥å¿—å°±ä¸æ˜¯åœ¨ /usr/local/nginx/logs/è¿™ä¸ªç›®å½•ä¸‹ï¼Œè€Œæ˜¯æ”¾åˆ°äº†/var/log/nginx/ è¿™ä¸ªç›®å½•ä¸‹äº†ï¼ˆpsï¼šlogæ–‡ä»¶çš„å­˜æ”¾å’Œæˆ‘çš„nginx.confæ–‡ä»¶ä¸­çš„ access\_logé…ç½®æœ‰å…³ç³»ï¼‰ã€‚å¦‚ä¸‹æ¼”ç¤ºï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa46cd957f224031bb05950196630777~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3316&h=1624&s=335118&e=png&b=000000)

å¥½äº†åœ¨äº†è§£äº†nginxæ•´ä½“çš„ç›®å½•ç»“æ„åï¼Œå°±æ¥çœ‹çœ‹ **nginx.conf** è¿™ä¸ªæ–‡ä»¶è¿™ä¸ªæ–‡ä»¶æ˜¯nginxçš„æ ¸å¿ƒé…ç½®ï¼Œ**æƒ³ç©è½¬nginxï¼Œè¯»æ‡‚è¿™ä¸ªé…ç½®æ–‡ä»¶æ˜¯å¿…ä¸å¯å°‘çš„ä¸€é¡¹åŸºæœ¬åŠŸï¼**

4ã€nginx.confæ–‡ä»¶ è§£è¯»
=================

é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“`nginx.confæ–‡ä»¶æ˜¯ç”±ä¸€ä¸ªä¸€ä¸ªçš„æŒ‡ä»¤å—ç»„æˆçš„`ï¼Œnginxç”¨{}æ ‡è¯†ä¸€ä¸ªæŒ‡ä»¤å—ï¼ŒæŒ‡ä»¤å—ä¸­å†è®¾ç½®å…·ä½“çš„æŒ‡ä»¤(æ³¨æ„ æŒ‡ä»¤å¿…é¡»ä»¥ ; å·ç»“å°¾)ï¼ŒæŒ‡ä»¤å—æœ‰`å…¨å±€å—`ï¼Œ`eventså—`ï¼Œ`httpå—`ï¼Œ`serverå—`å’Œ`locationå— ä»¥åŠ upstreamå—`ã€‚ç²¾ç®€åçš„ç»“æ„å¦‚ä¸‹ï¼š

```vbscript
å…¨å±€æ¨¡å—
eventæ¨¡å—
httpæ¨¡å—
    upstreamæ¨¡å—
    
    serveræ¨¡å—
        locationå—
        locationå—
        ....
    serveræ¨¡å—
        locationå—
        locationå—
        ...
    ....    

```



**å„æ¨¡å—çš„åŠŸèƒ½ä½œç”¨å¦‚ä¸‹æè¿°ï¼š**

1.  **å…¨å±€æ¨¡å—ï¼š** é…ç½®å½±å“nginxå…¨å±€çš„æŒ‡ä»¤ï¼Œæ¯”å¦‚è¿è¡Œnginxçš„ç”¨æˆ·åï¼Œnginxè¿›ç¨‹pidå­˜æ”¾è·¯å¾„ï¼Œæ—¥å¿—å­˜æ”¾è·¯å¾„ï¼Œé…ç½®æ–‡ä»¶å¼•å…¥ï¼Œworkerè¿›ç¨‹æ•°ç­‰ã€‚
2.  **eventså—ï¼š** é…ç½®å½±å“nginxæœåŠ¡å™¨æˆ–ä¸ç”¨æˆ·çš„ç½‘ç»œè¿æ¥ã€‚æ¯”å¦‚æ¯ä¸ªè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°ï¼Œé€‰å–å“ªç§äº‹ä»¶é©±åŠ¨æ¨¡å‹ï¼ˆselect/poll epollæˆ–è€…æ˜¯å…¶ä»–ç­‰ç­‰nginxæ”¯æŒçš„ï¼‰æ¥å¤„ç†è¿æ¥è¯·æ±‚ï¼Œæ˜¯å¦å…è®¸åŒæ—¶æ¥å—å¤šä¸ªç½‘è·¯è¿æ¥ï¼Œå¼€å¯å¤šä¸ªç½‘ç»œè¿æ¥åºåˆ—åŒ–ç­‰ã€‚
3.  **httpå—ï¼š** å¯ä»¥åµŒå¥—å¤šä¸ªserverï¼Œé…ç½®ä»£ç†ï¼Œç¼“å­˜ï¼Œæ—¥å¿—æ ¼å¼å®šä¹‰ç­‰ç»å¤§å¤šæ•°åŠŸèƒ½å’Œç¬¬ä¸‰æ–¹æ¨¡å—çš„é…ç½®ã€‚å¦‚æ–‡ä»¶å¼•å…¥ï¼Œmime-typeå®šä¹‰ï¼Œæ—¥å¿—è‡ªå®šä¹‰ï¼Œæ˜¯å¦ä½¿ç”¨sendfileä¼ è¾“æ–‡ä»¶ï¼Œè¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•è¿æ¥è¯·æ±‚æ•°ç­‰ã€‚
4.  **serverå—ï¼š** é…ç½®è™šæ‹Ÿä¸»æœºçš„ç›¸å…³å‚æ•°æ¯”å¦‚åŸŸåç«¯å£ç­‰ç­‰ï¼Œä¸€ä¸ªhttpä¸­å¯ä»¥æœ‰å¤šä¸ªserverã€‚
5.  **locationå—ï¼š** é…ç½®urlè·¯ç”±è§„åˆ™
6.  **upstreamå—ï¼š** é…ç½®ä¸Šæ¸¸æœåŠ¡å™¨çš„åœ°å€ä»¥åŠè´Ÿè½½å‡è¡¡ç­–ç•¥å’Œé‡è¯•ç­–ç•¥ç­‰ç­‰

**ä¸‹é¢çœ‹ä¸‹nginx.confé•¿å•¥æ ·å¹¶å¯¹ä¸€äº›æŒ‡ä»¤åšä¸ªè§£é‡Šï¼š**

```shell
# æ³¨æ„ï¼šæœ‰äº›æŒ‡ä»¤æ˜¯å¯ä»¥åœ¨ä¸åŒæŒ‡ä»¤å—ä½¿ç”¨çš„ï¼ˆéœ€è¦æ—¶å¯ä»¥å»å®˜ç½‘çœ‹çœ‹å¯¹åº”æŒ‡ä»¤çš„ä½œç”¨åŸŸï¼‰ã€‚æˆ‘è¿™é‡Œåªæ˜¯æ¼”ç¤º
# è¿™é‡Œæˆ‘ä»¥/usr/local/nginx/conf/nginx.confæ–‡ä»¶ä¸ºä¾‹

[root@localhost /usr/local/nginx]# cat /usr/local/nginx/conf/nginx.conf

#user  nobody; # æŒ‡å®šNginx Workerè¿›ç¨‹è¿è¡Œç”¨æˆ·ä»¥åŠç”¨æˆ·ç»„ï¼Œé»˜è®¤ç”±nobodyè´¦å·è¿è¡Œ
worker_processes  1;  # æŒ‡å®šå·¥ä½œè¿›ç¨‹çš„ä¸ªæ•°ï¼Œé»˜è®¤æ˜¯1ä¸ªã€‚å…·ä½“å¯ä»¥æ ¹æ®æœåŠ¡å™¨cpuæ•°é‡è¿›è¡Œè®¾ç½®ï¼Œ æ¯”å¦‚cpuæœ‰4ä¸ªï¼Œå¯ä»¥è®¾ç½®ä¸º4ã€‚å¦‚æœä¸çŸ¥é“cpuçš„æ•°é‡ï¼Œå¯ä»¥è®¾ç½®ä¸ºautoã€‚ nginxä¼šè‡ªåŠ¨åˆ¤æ–­æœåŠ¡å™¨çš„cpuä¸ªæ•°ï¼Œå¹¶è®¾ç½®ç›¸åº”çš„è¿›ç¨‹æ•°
#error_log  logs/error.log;  # ç”¨æ¥å®šä¹‰å…¨å±€é”™è¯¯æ—¥å¿—æ–‡ä»¶è¾“å‡ºè·¯å¾„ï¼Œè¿™ä¸ªè®¾ç½®ä¹Ÿå¯ä»¥æ”¾å…¥httpå—ï¼Œserverå—ï¼Œæ—¥å¿—è¾“å‡ºçº§åˆ«æœ‰debugã€infoã€noticeã€warnã€errorã€critå¯ä¾›é€‰æ‹©ï¼Œå…¶ä¸­ï¼Œdebugè¾“å‡ºæ—¥å¿—æœ€ä¸ºæœ€è¯¦ç»†ï¼Œè€Œcritè¾“å‡ºæ—¥å¿—æœ€å°‘ã€‚
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info; # æŒ‡å®šerroræ—¥å¿—ä½ç½®å’Œæ—¥å¿—çº§åˆ«
#pid        logs/nginx.pid;  # ç”¨æ¥æŒ‡å®šè¿›ç¨‹pidçš„å­˜å‚¨æ–‡ä»¶ä½ç½®

events {
    accept_mutex on;   # è®¾ç½®ç½‘è·¯è¿æ¥åºåˆ—åŒ–ï¼Œé˜²æ­¢æƒŠç¾¤ç°è±¡å‘ç”Ÿï¼Œé»˜è®¤ä¸ºon
    
    # Nginxæ”¯æŒçš„å·¥ä½œæ¨¡å¼æœ‰selectã€pollã€kqueueã€epollã€rtsigå’Œ/dev/pollï¼Œå…¶ä¸­selectå’Œpolléƒ½æ˜¯æ ‡å‡†çš„å·¥ä½œæ¨¡å¼ï¼Œkqueueå’Œepollæ˜¯é«˜æ•ˆçš„å·¥ä½œæ¨¡å¼ï¼Œä¸åŒçš„æ˜¯epollç”¨åœ¨Linuxå¹³å°ä¸Šï¼Œè€Œkqueueç”¨åœ¨BSDç³»ç»Ÿä¸­ï¼Œå¯¹äºLinuxç³»ç»Ÿï¼Œepollå·¥ä½œæ¨¡å¼æ˜¯é¦–é€‰
    use epoll;
    
    # ç”¨äºå®šä¹‰Nginxæ¯ä¸ªå·¥ä½œè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤æ˜¯1024ã€‚æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°ç”±worker_processeså’Œworker_connectionså†³å®šï¼Œå³Max_client=worker_processes*worker_connectionsåœ¨ä½œä¸ºåå‘ä»£ç†æ—¶ï¼Œmax_clientså˜ä¸ºï¼šmax_clients = worker_processes *worker_connections/4ã€‚è¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°å—Linuxç³»ç»Ÿè¿›ç¨‹çš„æœ€å¤§æ‰“å¼€æ–‡ä»¶æ•°é™åˆ¶ï¼Œåœ¨æ‰§è¡Œæ“ä½œç³»ç»Ÿå‘½ä»¤â€œulimit -n 65536â€åworker_connectionsçš„è®¾ç½®æ‰èƒ½ç”Ÿæ•ˆ
    worker_connections  1024; 
}

# å¯¹HTTPæœåŠ¡å™¨ç›¸å…³å±æ€§çš„é…ç½®å¦‚ä¸‹
http {
    include       mime.types; # å¼•å…¥æ–‡ä»¶ç±»å‹æ˜ å°„æ–‡ä»¶ 
    default_type  application/octet-stream; # å¦‚æœæ²¡æœ‰æ‰¾åˆ°æŒ‡å®šçš„æ–‡ä»¶ç±»å‹æ˜ å°„ ä½¿ç”¨é»˜è®¤é…ç½® 
    # è®¾ç½®æ—¥å¿—æ‰“å°æ ¼å¼
    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';
    # 
    #access_log  logs/access.log  main; # è®¾ç½®æ—¥å¿—è¾“å‡ºè·¯å¾„ä»¥åŠ æ—¥å¿—çº§åˆ«
    sendfile        on; # å¼€å¯é›¶æ‹·è´ çœå»äº†å†…æ ¸åˆ°ç”¨æˆ·æ€çš„ä¸¤æ¬¡copyæ•…åœ¨æ–‡ä»¶ä¼ è¾“æ—¶æ€§èƒ½ä¼šæœ‰å¾ˆå¤§æå‡
    #tcp_nopush     on; # æ•°æ®åŒ…ä¼šç´¯è®¡åˆ°ä¸€å®šå¤§å°ä¹‹åæ‰ä¼šå‘é€ï¼Œå‡å°äº†é¢å¤–å¼€é”€ï¼Œæé«˜ç½‘ç»œæ•ˆç‡
    keepalive_timeout  65; # è®¾ç½®nginxæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¼šè¯çš„è¶…æ—¶æ—¶é—´ã€‚è¶…è¿‡è¿™ä¸ªæ—¶é—´ä¹‹åæœåŠ¡å™¨ä¼šå…³é—­è¯¥è¿æ¥ï¼Œå®¢æˆ·ç«¯å†æ¬¡å‘èµ·è¯·æ±‚ï¼Œåˆ™éœ€è¦å†æ¬¡è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ã€‚
    #gzip  on; # å¼€å¯å‹ç¼©åŠŸèƒ½ï¼Œå‡å°‘æ–‡ä»¶ä¼ è¾“å¤§å°ï¼ŒèŠ‚çœå¸¦å®½ã€‚
    sendfile_max_chunk 100k; #æ¯ä¸ªè¿›ç¨‹æ¯æ¬¡è°ƒç”¨ä¼ è¾“æ•°é‡ä¸èƒ½å¤§äºè®¾å®šçš„å€¼ï¼Œé»˜è®¤ä¸º0ï¼Œå³ä¸è®¾ä¸Šé™ã€‚
    
    # é…ç½®ä½ çš„ä¸Šæ¸¸æœåŠ¡ï¼ˆå³è¢«nginxä»£ç†çš„åç«¯æœåŠ¡ï¼‰çš„ipå’Œç«¯å£/åŸŸå
    upstream backend_server { 
        server 172.30.128.65:8080;
        server 172.30.128.65:8081 backup; #å¤‡æœº
    }

    server {
        listen       80; #nginxæœåŠ¡å™¨ç›‘å¬çš„ç«¯å£
        server_name  localhost; #ç›‘å¬çš„åœ°å€ nginxæœåŠ¡å™¨åŸŸå/ip å¤šä¸ªä½¿ç”¨è‹±æ–‡é€—å·åˆ†å‰²
        #access_log  logs/host.access.log  main; # è®¾ç½®æ—¥å¿—è¾“å‡ºè·¯å¾„ä»¥åŠ çº§åˆ«ï¼Œä¼šè¦†ç›–httpæŒ‡ä»¤å—çš„access_logé…ç½®
        
        # locationç”¨äºå®šä¹‰è¯·æ±‚åŒ¹é…è§„åˆ™ã€‚ ä»¥ä¸‹æ˜¯å®é™…ä½¿ç”¨ä¸­å¸¸è§çš„3ä¸­é…ç½®ï¼ˆå³åˆ†ä¸ºï¼šé¦–é¡µï¼Œé™æ€ï¼ŒåŠ¨æ€ä¸‰ç§ï¼‰
       
        # ç¬¬ä¸€ç§ï¼šç›´æ¥åŒ¹é…ç½‘ç«™æ ¹ç›®å½•ï¼Œé€šè¿‡åŸŸåè®¿é—®ç½‘ç«™é¦–é¡µæ¯”è¾ƒé¢‘ç¹ï¼Œä½¿ç”¨è¿™ä¸ªä¼šåŠ é€Ÿå¤„ç†ï¼Œä¸€èˆ¬è¿™ä¸ªè§„åˆ™é…æˆç½‘ç«™é¦–é¡µï¼Œå‡è®¾æ­¤æ—¶æˆ‘ä»¬çš„ç½‘ç«™é¦–é¡µæ–‡ä»¶å°±æ˜¯ï¼š usr/local/nginx/html/index.html
        location = / {  
            root   html; # é™æ€èµ„æºæ–‡ä»¶çš„æ ¹ç›®å½• æ¯”å¦‚æˆ‘çš„æ˜¯ /usr/local/nginx/html/
            index  index.html index.htm; # é™æ€èµ„æºæ–‡ä»¶åç§° æ¯”å¦‚ï¼šç½‘ç«™é¦–é¡µhtmlæ–‡ä»¶
        }
        # ç¬¬äºŒç§ï¼šé™æ€èµ„æºåŒ¹é…ï¼ˆé™æ€æ–‡ä»¶ä¿®æ”¹å°‘è®¿é—®é¢‘ç¹ï¼Œå¯ä»¥ç›´æ¥æ”¾åˆ°nginxæˆ–è€…ç»Ÿä¸€æ”¾åˆ°æ–‡ä»¶æœåŠ¡å™¨ï¼Œå‡å°‘åç«¯æœåŠ¡çš„å‹åŠ›ï¼‰ï¼Œå‡è®¾æŠŠé™æ€æ–‡ä»¶æˆ‘ä»¬è¿™é‡Œæ”¾åˆ°äº† usr/local/nginx/webroot/static/ç›®å½•ä¸‹
        location ^~ /static/ {
            alias /webroot/static/; #è®¿é—® ip:80/static/xxx.jpgåï¼Œå°†ä¼šå»è·å–/url/local/nginx/webroot/static/xxx.jpg æ–‡ä»¶å¹¶å“åº”
        }
        # ç¬¬äºŒç§çš„å¦å¤–ä¸€ç§æ–¹å¼ï¼šæ‹¦æˆªæ‰€æœ‰ åç¼€åæ˜¯gif,jpg,jpeg,png,css.js,icoè¿™äº› ç±»é™æ€çš„çš„è¯·æ±‚ï¼Œè®©ä»–ä»¬éƒ½å»ç›´æ¥è®¿é—®é™æ€æ–‡ä»¶ç›®å½•å³å¯
        location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ {
            root /webroot/static/;
        }
        # ç¬¬ä¸‰ç§ï¼šç”¨æ¥æ‹¦æˆªéé¦–é¡µã€éé™æ€èµ„æºçš„åŠ¨æ€æ•°æ®è¯·æ±‚ï¼Œå¹¶è½¬å‘åˆ°åç«¯åº”ç”¨æœåŠ¡å™¨ 
        location / {
            proxy_pass http://backend_server; #è¯·æ±‚è½¬å‘ upstreamæ˜¯backend_server æŒ‡ä»¤å—æ‰€å®šä¹‰çš„æœåŠ¡å™¨åˆ—è¡¨
            deny 192.168.3.29; #æ‹’ç»çš„ip ï¼ˆé»‘åå•ï¼‰
            allow 192.168.5.10; #å…è®¸çš„ipï¼ˆç™½åå•ï¼‰
        }
        
        # å®šä¹‰é”™è¯¯è¿”å›çš„é¡µé¢ï¼Œå‡¡æ˜¯çŠ¶æ€ç æ˜¯ 500 502 503 504 æ€»ä¹‹50å¼€å¤´çš„éƒ½ä¼šè¿”å›è¿™ä¸ª æ ¹ç›®å½•ä¸‹htmlæ–‡ä»¶å¤¹ä¸‹çš„50x.htmlæ–‡ä»¶å†…å®¹
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
        
    }
    # å…¶ä½™çš„serveré…ç½® ,å¦‚æœæœ‰éœ€è¦çš„è¯
    #server {
        ......
    #    location / {
               ....
    #    }
    #}
    
    # include /etc/nginx/conf.d/*.conf;  # ä¸€èˆ¬æˆ‘ä»¬å®é™…ä½¿ç”¨ä¸­æœ‰å¾ˆå¤šé…ç½®ï¼Œé€šå¸¸çš„åšæ³•å¹¶ä¸æ˜¯å°†å…¶ç›´æ¥å†™åˆ°nginx.confæ–‡ä»¶ï¼Œ
    # è€Œæ˜¯å†™åˆ°æ–°æ–‡ä»¶ ç„¶åä½¿ç”¨includeæŒ‡ä»¤ å°†å…¶å¼•å…¥åˆ°nginx.confå³å¯ï¼Œè¿™æ ·ä½¿å¾—ä¸»é…ç½®nginx.confæ–‡ä»¶æ›´åŠ æ¸…æ™°ã€‚
    
}

```



ä»¥ä¸Šå°±æ˜¯nginx.confæ–‡ä»¶çš„é…ç½®äº†ï¼Œä¸»è¦è®²äº†ä¸€äº›æŒ‡ä»¤çš„å«ä¹‰ï¼Œå½“ç„¶å®é™…çš„æŒ‡ä»¤æœ‰å¾ˆå¤šï¼Œæˆ‘åœ¨é…ç½®æ–‡ä»¶å¹¶æ²¡æœ‰å…¨éƒ¨å†™å‡ºæ¥ï¼Œå‡†å¤‡æ”¾åˆ°åè¾¹ç« èŠ‚è¯¦ç»†é˜è¿°è¿™äº›ä¸œè¥¿ï¼Œæ¯”å¦‚ï¼š**locationåŒ¹é…è§„åˆ™ï¼Œåå‘ä»£ç†ï¼ŒåŠ¨é™åˆ†ç¦»ï¼Œè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé‡è¯•ç­–ç•¥ï¼Œå‹ç¼©ï¼Œhttps,é™æµï¼Œç¼“å­˜ï¼Œè·¨åŸŸè¿™äº›** æˆ‘ä»¬éƒ½æ²¡ç»†è¯´ï¼Œè¿™äº›ä¸œè¥¿æ¯”è¾ƒå¤šæ¯”è¾ƒç»†ä¸å¯èƒ½æŠŠä½¿ç”¨è§„åˆ™å’Œç»†èŠ‚éƒ½å†™åˆ°ä¸Šè¾¹çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸‹è¾¹ä¸€ä¸€è§£é‡Šè¯´æ˜å…³äºè¿™äº›ä¸œè¥¿çš„é…ç½®å’Œä½¿ç”¨æ–¹å¼ã€‚ï¼ˆå¦å¤–å€¼çš„æ³¨æ„çš„æ˜¯ï¼š å› ä¸ºæœ‰äº›æŒ‡ä»¤æ˜¯å¯ä»¥åœ¨ä¸åŒä½œç”¨åŸŸä½¿ç”¨çš„ï¼Œå¦‚æœåœ¨å¤šä¸ªä½œç”¨åŸŸéƒ½æœ‰ç›¸åŒæŒ‡ä»¤çš„ä½¿ç”¨ï¼Œé‚£ä¹ˆnginxå°†ä¼šéµå¾ªå°±è¿‘åŸåˆ™æˆ–è€…æˆ‘æ„¿ç§°ä¹‹ä¸º **å†…å±‚é…ç½®ä¼˜å…ˆ**ã€‚ eg: ä½ åœ¨ httpé…äº†æ—¥å¿—çº§åˆ«ï¼Œä¹Ÿåœ¨æŸä¸ªserverä¸­é…äº†æ—¥å¿—çº§åˆ«ï¼Œé‚£ä¹ˆè¿™ä¸ªserverå°†ä½¿ç”¨ä»–è‡ªå·±é…ç½®çš„å·²ä¸ä½¿ç”¨å¤–å±‚çš„httpæ—¥å¿—é…ç½®ï¼‰

5ã€location è·¯ç”±åŒ¹é…è§„åˆ™
=================

**ä»€ä¹ˆæ˜¯location? :** nginxæ ¹æ®ç”¨æˆ·è¯·æ±‚çš„URIæ¥åŒ¹é…å¯¹åº”çš„locationæ¨¡å—ï¼ŒåŒ¹é…åˆ°å“ªä¸ªlocationï¼Œè¯·æ±‚å°†è¢«å“ªä¸ªlocationå—ä¸­çš„é…ç½®é¡¹æ‰€å¤„ç†ã€‚

locationé…ç½®è¯­æ³•ï¼š`location [ä¿®é¥°ç¬¦] pattern {â€¦}`

**å¸¸è§åŒ¹é…è§„åˆ™å¦‚ä¸‹ï¼š**

| ä¿®é¥°ç¬¦ | ä½œç”¨ |
| --- | --- |
| ç©º | æ— ä¿®é¥°ç¬¦çš„å‰ç¼€åŒ¹é…ï¼ŒåŒ¹é…å‰ç¼€æ˜¯ ä½ é…ç½®çš„ï¼ˆæ¯”å¦‚è¯´ä½ é…çš„æ˜¯ /aaaï¼‰ çš„url |
| \= | ç²¾ç¡®åŒ¹é… |
| ~ | æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…ï¼ŒåŒºåˆ†å¤§å°å†™ |
| ~\* | æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™ |
| ^~ | ^~ç±»å‹çš„å‰ç¼€åŒ¹é…ï¼Œç±»ä¼¼äºæ— ä¿®é¥°ç¬¦å‰ç¼€åŒ¹é…ï¼Œä¸åŒçš„æ˜¯ï¼Œå¦‚æœåŒ¹é…åˆ°äº†ï¼Œé‚£ä¹ˆå°±åœæ­¢åç»­åŒ¹é… |
| / | é€šç”¨åŒ¹é…ï¼Œä»»ä½•è¯·æ±‚éƒ½ä¼šåŒ¹é…åˆ°ï¼ˆåªè¦ä½ åŸŸåå¯¹ï¼Œæ‰€æœ‰è¯·æ±‚é€šåƒï¼ï¼‰ |

5.1ã€å‰ç¼€åŒ¹é…ï¼ˆæ— ä¿®é¥°ç¬¦ï¼‰
--------------

é¦–å…ˆæˆ‘æå‰åˆ›å»ºäº†prefix\_match.htmlæ–‡ä»¶ï¼Œä¹‹åæ”¹ä¸€ä¸‹nginx.confæ–‡ä»¶ï¼ˆç»™å‰ç¼€æ˜¯ /prefixmatch çš„è¯·æ±‚è¿”å› /etc/nginx/locatest/prefix\_match.html è¿™ä¸ªæ–‡ä»¶ï¼‰ ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7ddbcfcc11c34bbd96c9fea044bf73d4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=622&h=378&s=32366&e=png&b=010101)

ç„¶ååœ¨å®¿ä¸»æœºhostsä¸­é…ç½®åŸŸå 172.30.128.65 [www.locatest.com](https://link.juejin.cn?target=http%3A%2F%2Fwww.locatest.com "http://www.locatest.com") æ˜ å°„åï¼Œè§‚å¯Ÿåˆ°nginxæœåŠ¡å™¨è¿”å›å†…å®¹å¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8ec24b7ceb4046fda34c95041393ad95~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2420&h=2014&s=291249&e=png&b=010101)

shell

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`curl http://www.locatest.com/prefixmatch     âœ… 301 curl http://www.locatest.com/prefixmatch?    âœ… 301 curl http://www.locatest.com/PREFIXMATCH     âŒ 404 curl http://www.locatest.com/prefixmatch/    âœ… 200 curl http://www.locatest.com/prefixmatchmmm  âŒ 404 curl http://www.locatest.com/prefixmatch/mmm âŒ 404 curl http://www.locatest.com/aaa/prefixmatch/âŒ 404`

å¯ä»¥çœ‹åˆ° `åŸŸå/prefixmatch` å’Œ`åŸŸå/prefixmatch?` è¿”å›äº†301 ï¼ŒåŸå› åœ¨äºprefixmatchæ˜ å°„çš„ /etc/nginx/locatest/ æ˜¯ä¸ªç›®å½•ï¼Œè€Œä¸æ˜¯ä¸ªæ–‡ä»¶æ‰€ä»¥nginxæç¤ºæˆ‘ä»¬301ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸ç”¨ç®¡æ²¡å…³ç³»ï¼Œæ€»ä¹‹æˆ‘ä»¬çŸ¥é“ï¼š`åŸŸå/prefixmatch`ï¼Œ`åŸŸå/prefixmatch?` å’Œ`åŸŸå/prefixmatch/` è¿™ä¸‰ä¸ªurlé€šè¿‡æˆ‘ä»¬é…ç½®çš„ **æ— ä¿®é¥°ç¬¦å‰ç¼€åŒ¹é…è§„åˆ™** éƒ½èƒ½åŒ¹é…ä¸Šå°±è¡Œäº†ã€‚

psï¼š_ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä¸‹è¾¹çš„å‡ ä¸ªlocationè§„åˆ™æ¼”ç¤ºä¸å†è·³è½¬é™æ€æ–‡ä»¶äº†ï¼Œè€Œæ˜¯ç›´æ¥returnä¸€å¥è¯ã€‚_

5.2ã€ç²¾ç¡®åŒ¹é…ï¼ˆ = ï¼‰
-------------

ä¸ºäº†æ¼”ç¤ºç²¾ç¡®åŒ¹é…ï¼Œæˆ‘ä»¬å†ç»™nginx.confæ–‡ä»¶å¢åŠ ä¸€ä¸ªlocationé…ç½®ï¼Œå¦‚ä¸‹æ ‡çº¢å¤„ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/79c3aaedaedc46e2bdb4e1d21918ebb1~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=730&h=498&s=36209&e=png&b=000000)

å®é™…æ•ˆæœå¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b20c9d644e64ee18f03901f9adf2263~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1342&h=1142&s=139125&e=png&b=010101)

ruby

`http://www.locatest.com/exactmatch      âœ… 200 http://www.locatest.com/exactmatchï¼Ÿ    âœ… 200 http://www.locatest.com/exactmatch/     âŒ 404 http://www.locatest.com/exactmatchmmmm  âŒ 404 http://www.locatest.com/EXACTMATCH      âŒ 404`

å¯ä»¥çœ‹å‡ºæ¥ç²¾ç¡®åŒ¹é…å°±æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œå·®ä¸€ä¸ªå­—ä¹Ÿä¸è¡Œï¼

5.3ã€å‰ç¼€åŒ¹é…ï¼ˆ ^~ ï¼‰
--------------

æˆ‘ä»¬ä¸Šè¾¹è¯´äº†ä¸å¸¦ä»»ä½•ä¿®é¥°ç¬¦çš„å‰ç¼€åŒ¹é…ï¼ˆ5.1å°èŠ‚ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸‹ ä¿®é¥°ç¬¦æ˜¯ ^~çš„ å‰ç¼€åŒ¹é…å’Œä¸å¸¦ä¿®é¥°ç¬¦çš„å‰ç¼€åŒ¹é…æœ‰å•¥åŒºåˆ«ï¼Œå…ˆåœ¨ngnx.confæ–‡ä»¶å¢åŠ ä¸ªlocationå¹¶é…å¥½å¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/02a5131e4e7e41b68aa60fad6ca3a950~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=682&h=390&s=38232&e=png&b=010101) curlæ•ˆæœå¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/901e9f889df34413bd261db7f31807a9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1446&h=1168&s=171046&e=png&b=010101)



`curl http://www.locatest.com/exactprefixmatch     âœ… 200 curl http://www.locatest.com/exactprefixmatch/    âœ… 200 curl http://www.locatest.com/exactprefixmatch?    âœ… 200 curl http://www.locatest.com/exactprefixmatchmmm  âœ… 200 curl http://www.locatest.com/exactprefixmatch/mmm âœ… 200 curl http://www.locatest.com/aaa/exactprefixmatch âŒ 404 curl http://www.locatest.com/EXACTPREFIXMATCH     âŒ 404`

å¯ä»¥çœ‹åˆ°å¸¦ä¿®é¥°ç¬¦(`^~`)çš„å‰ç¼€åŒ¹é… åƒï¼š`åŸŸå/exactprefixmatchmmm` å’Œ`åŸŸå/exactprefixmatch/mmm` æ˜¯å¯ä»¥åŒ¹é…ä¸Šçš„ï¼Œè€Œä¸å¸¦ä¿®é¥°ç¬¦çš„å‰ç¼€åŒ¹é…è¿™ä¸¤ä¸ªç±»å‹çš„urlæ˜¯åŒ¹é…ä¸ä¸Šçš„ç›´æ¥è¿”å›äº†404 ï¼Œå…¶ä»–çš„å’Œä¸å¸¦ä¿®é¥°ç¬¦çš„å‰ç¼€åŒ¹é…ä¼¼ä¹éƒ½å·®ä¸å¤šã€‚

5.4ã€æ­£åˆ™åŒ¹é…ï¼ˆ~ åŒºåˆ†å¤§å°å†™ï¼‰
-----------------

psï¼šæ­£åˆ™è¡¨è¾¾å¼çš„åŒ¹é…ï¼Œéœ€è¦ä½ å¯¹æ­£åˆ™è¯­æ³•æ¯”è¾ƒç†Ÿæ‚‰ï¼Œç†Ÿæ‚‰è¯­æ³•åå†™åŒ¹é…è§„åˆ™ä¹Ÿå°±å¾—å¿ƒåº”æ‰‹äº†ã€‚

æ·»åŠ ä¸ªlocationå¹¶é…ç½®ï¼Œå¦‚ä¸‹ï¼šï¼ˆ ^è¡¨ç¤ºå¼€å¤´ï¼Œ$è¡¨ç¤ºç»“å°¾ï¼‰ ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e8f1374b3dbf4875bf0959c5b41bef3e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=752&h=360&s=36101&e=png&b=000000) å®é™…æ•ˆæœå¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5c6e2f9bfc3c4d159cca6c18d5e27d1f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1422&h=2088&s=254957&e=png&b=010101)

ruby

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`curl http://www.locatest.com/regexmatch      âœ… 200 curl http://www.locatest.com/regexmatch/     âŒ 404 curl http://www.locatest.com/regexmatch?     âœ… 200 curl http://www.locatest.com/regexmatchmmm   âŒ 404 curl http://www.locatest.com/regexmatch/mmm  âŒ 404 curl http://www.locatest.com/REGEXMATCH      âŒ 404 curl http://www.locatest.com/aaa/regexmatch  âŒ 404 curl http://www.locatest.com/bbbregexmatch   âŒ 404`

å¯ä»¥çœ‹åˆ°~ä¿®é¥°çš„æ­£åˆ™æ˜¯åŒºåˆ†å¤§å°å†™çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ ä¸åŒºåˆ†å¤§å°å†™çš„åŒ¹é…ã€‚

5.5ã€æ­£åˆ™åŒ¹é…ï¼ˆ~\* ä¸åŒºåˆ†å¤§å°å†™ï¼‰
--------------------

æ”¹ä¸‹location åœ¨ä¿®é¥°ç¬¦~ååŠ ä¸ª \* ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d698156eb04349b4abe409bda34c32e1~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=984&h=354&s=37607&e=png&b=010101) çœ‹ä¸‹å®é™…æ•ˆæœï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/552f152769094533a332b4362ed18395~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1382&h=1872&s=235117&e=png&b=010101) å¯ä»¥çœ‹åˆ°è¿™æ¬¡ curl [www.locatest.com/REGEXMATCH](https://link.juejin.cn?target=http%3A%2F%2Fwww.locatest.com%2FREGEXMATCH "http://www.locatest.com/REGEXMATCH") æ˜¯å¯ä»¥åŒ¹é…ä¸Šçš„ï¼Œè¯´æ˜ ~\* ç¡®å®æ˜¯ä¸åŒºåˆ†å¤§å°å†™çš„ã€‚

5.6ã€é€šç”¨åŒ¹é…ï¼ˆ / ï¼‰
-------------

é€šç”¨åŒ¹é…ä½¿ç”¨ä¸€ä¸ª / è¡¨ç¤ºï¼Œå¯ä»¥åŒ¹é…æ‰€æœ‰è¯·æ±‚ï¼Œä¸€èˆ¬nginxé…ç½®æ–‡ä»¶æœ€åéƒ½ä¼šæœ‰ä¸€ä¸ªé€šç”¨åŒ¹é…è§„åˆ™ï¼Œå½“å…¶ä»–åŒ¹é…è§„åˆ™å‡å¤±æ•ˆæ—¶ï¼Œè¯·æ±‚ä¼šè¢«è·¯ç”±ç»™é€šç”¨åŒ¹é…è§„åˆ™å¤„ç†ï¼Œå¦‚æœæ²¡æœ‰é…ç½®é€šç”¨åŒ¹é…ï¼Œå¹¶ä¸”å…¶ä»–æ‰€æœ‰åŒ¹é…è§„åˆ™å‡å¤±æ•ˆæ—¶ï¼Œnginxä¼šè¿”å›404é”™è¯¯ã€‚ ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a014bb34510b4db1a141a4b3d9fb3cf0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1016&h=382&s=41404&e=png&b=000000) é€šç”¨åŒ¹é…å®é™…æ•ˆæœï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3068466ae35c4400b3915b260eb2ec75~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1034&h=710&s=123910&e=png&b=020202) å¯ä»¥çœ‹åˆ°é€šç”¨åŒ¹é…å¾ˆå¥½ç†è§£ï¼Œåªè¦ä½ åŸŸåå†™å¯¹äº†ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„urléƒ½ä¼šè¢«åŒ¹é…ä¸Šï¼Œæ¥è€…ä¸æ‹’çš„æ„Ÿè§‰ã€‚

5.7ã€å…³äºlocation åŒ¹é…ä¼˜å…ˆçº§
--------------------

ä¸Šè¾¹æˆ‘ä»¬è¯´äº†6ç§locationåŒ¹é…è§„åˆ™ï¼Œé‚£ä¹ˆå¦‚æœå­˜åœ¨å¤šä¸ªåˆ°åº•èµ°å“ªä¸ªlocationå‘¢ï¼Ÿè¿™å°±çš„è¯´è¯´locationçš„åŒ¹é…ä¼˜å…ˆçº§äº†ã€‚å…ˆæ¥çœ‹ä¸‹nginxå®˜ç½‘å’Œstackoverflowä¸Šçš„èµ„æ–™å¦‚ä¸‹ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aadcbf83cfa24e118bfd7f996b51c3dd~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2972&h=1698&s=626226&e=png&b=fefefe) ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/146fa555a03f42c7905ad4af477597c0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2226&h=1800&s=471724&e=png&b=fcfcfc) ç»¼ä¸Šèµ„æ–™æˆ‘ä»¬å¯¹**locationåŒ¹é…ä¼˜å…ˆçº§çš„æ€»ç»“å¦‚ä¸‹ï¼š**

1.  ä¼˜å…ˆèµ°`ç²¾ç¡®åŒ¹é…`ï¼Œç²¾ç¡®åŒ¹é…å‘½ä¸­æ—¶ï¼Œç›´æ¥èµ°å¯¹åº”çš„locationï¼Œåœæ­¢ä¹‹åçš„åŒ¹é…åŠ¨ä½œã€‚
2.  `æ— ä¿®é¥°ç¬¦ç±»å‹çš„å‰ç¼€åŒ¹é…`å’Œ `^~ ç±»å‹çš„å‰ç¼€åŒ¹é…`å‘½ä¸­æ—¶ï¼Œæ”¶é›†å‘½ä¸­çš„åŒ¹é…ï¼Œå¯¹æ¯”å‡ºæœ€é•¿çš„é‚£ä¸€æ¡å¹¶å­˜èµ·æ¥(æœ€é•¿æŒ‡çš„æ˜¯ä¸è¯·æ±‚urlåŒ¹é…åº¦æœ€é«˜çš„é‚£ä¸ªlocation)ã€‚
3.  `å¦‚æœ`æ­¥éª¤2ä¸­æœ€é•¿çš„é‚£ä¸€æ¡åŒ¹é…`æ˜¯^~ç±»å‹çš„å‰ç¼€åŒ¹é…`ï¼Œç›´æ¥èµ°æ­¤æ¡åŒ¹é…å¯¹åº”çš„locationå¹¶`åœæ­¢`åç»­åŒ¹é…åŠ¨ä½œï¼›å¦‚æœæ­¥éª¤2`æœ€é•¿çš„é‚£ä¸€æ¡åŒ¹é…`ä¸æ˜¯^~ç±»å‹çš„å‰ç¼€åŒ¹é…ï¼ˆä¹Ÿå°±`æ˜¯æ— ä¿®é¥°ç¬¦çš„å‰ç¼€åŒ¹é…`ï¼‰ï¼Œåˆ™`ç»§ç»­å¾€ä¸‹`åŒ¹é…
4.  æŒ‰locationçš„å£°æ˜é¡ºåºï¼Œæ‰§è¡Œæ­£åˆ™åŒ¹é…ï¼Œå½“æ‰¾åˆ°ç¬¬ä¸€ä¸ªå‘½ä¸­çš„æ­£åˆ™locationæ—¶ï¼Œåœæ­¢åç»­åŒ¹é…ã€‚
5.  éƒ½æ²¡åŒ¹é…åˆ°ï¼Œèµ°é€šç”¨åŒ¹é…ï¼ˆ / ï¼‰ï¼ˆå¦‚æœæœ‰é…ç½®çš„è¯ï¼‰ï¼Œå¦‚æœæ²¡é…ç½®é€šç”¨åŒ¹é…çš„è¯ï¼Œä¸Šè¾¹ä¹Ÿéƒ½æ²¡åŒ¹é…ä¸Šï¼Œåˆ°è¿™é‡Œå°±æ˜¯404äº†ã€‚

**å¦‚æœéè¦ç»™ä¿®é¥°ç¬¦æ’ä¸ªåºçš„è¯å°±æ˜¯é…±æ ·å­ï¼š** `=` > `^~` > `æ­£åˆ™` > `æ— ä¿®é¥°ç¬¦çš„å‰ç¼€åŒ¹é…` > `/`

_okå…³äºlocationå°±åˆ°è¿™é‡Œï¼Œlocationæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç‚¹ï¼Œå­¦å¥½è¿™ä¸ªæ‰çŸ¥é“nginxåˆ°åº•æ˜¯å’‹åŒ¹é…urlçš„ã€‚_

6ã€åå‘ä»£ç†
======

åå‘ä»£ç†ç¤ºæ„å›¾æˆ‘ä»¬ä¸Šè¾¹è¯´è¿‡ï¼Œè¿™é‡Œå†æ¬¡ç²˜ä¸€ä¸‹ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/12feb26340c74998bd7917f1a21d83fa~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1906&h=1212&s=132766&e=png&b=fdfdfd)

æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ç”¨ä¸€ä¸ªå°demoæ¥æ¼”ç¤ºåå‘ä»£ç†çš„ä½¿ç”¨

6.1ã€æœåŠ¡å‡†å¤‡
--------

é¦–å…ˆå°†æˆ‘æœ¬åœ°çš„ä¸€ä¸ªæœåŠ¡æ‰“æˆ èƒ–jarï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9b061b43645f469c86b008c7b8a341da~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3394&h=2096&s=633913&e=png&b=2c2c2c) ç„¶åä½¿ç”¨java -jaræ–¹å¼å¯åŠ¨æœåŠ¡ï¼Œä¸”æŒ‡å®šç«¯å£ä¸º8081ï¼š

perl

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`java -jar /Users/hzz/myself_project/xzll/study-admin/study-admin-service/target/study-admin-service.jar --server.port=8081`

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/88bd8441e4b0444f9966a97482248319~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3536&h=1816&s=837365&e=png&b=010101) æœ€åä½¿ç”¨postmanæµ‹è¯•æ¥å£æ˜¯å¦æ­£å¸¸ï¼ˆæ³¨æ„æ­¤æ—¶è¿˜æ²¡è¢«nginxä»£ç†ï¼Œè€Œæ˜¯ç›´æ¥è°ƒçš„æœåŠ¡ï¼‰ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d1179942c8e84befb0eed6e7b9238e88~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3238&h=1396&s=224332&e=png&b=fcfcfc) å¯åŠ¨æœåŠ¡å¹¶éªŒè¯æ¥å£æ— è¯¯åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹nginxé…ç½®æ–‡ä»¶ã€‚è®©nginxåå‘ä»£ç†æˆ‘ä»¬çš„æœåŠ¡ã€‚

6.2ã€ä¿®æ”¹nginx.confæ–‡ä»¶
------------------

è¦è®© **`nginx ä»£ç†`** æˆ‘ä»¬çš„ **`æœåŠ¡`** å¾ˆç®€å•ï¼Œç®€å•æè¿°ä¸€ä¸‹å°±æ˜¯ **`ä¸¤æ­¥ï¼š`**

1.  **é€šè¿‡upstreamæŒ‡ä»¤å—æ¥å®šä¹‰æˆ‘ä»¬çš„ä¸Šæ¸¸æœåŠ¡ï¼ˆå³è¢«ä»£ç†çš„æœåŠ¡ï¼‰**
2.  **é€šè¿‡locationæŒ‡ä»¤å—ä¸­çš„ proxy\_passæŒ‡ä»¤ï¼ŒæŒ‡å®šè¯¥locationè¦è·¯ç”±åˆ°å“ªä¸ªupstream**

é…ç½®å¥½1å’Œ2åï¼Œå¦‚æœæ¥äº†è¯·æ±‚å ä¼šé€šè¿‡urlè·¯ç”±åˆ°å¯¹åº”çš„location, ç„¶ånginxä¼šå°†è¯·æ±‚æ‰“åˆ°upstreamå®šä¹‰çš„æœåŠ¡åœ°å€ä¸­å»ï¼Œä¸‹è¾¹æˆ‘ä»¬çœ‹çœ‹ï¼š

ä½¿ç”¨ vi /etc/nginx/nginx.confå‘½ä»¤ä¿®æ”¹nginx.confæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f39d0590e33a4fde83367db2665481d5~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1160&h=940&s=87778&e=png&b=000000) ï¼ˆæ³¨æ„ä¸Šè¾¹çš„ proxy\_pass [http://mybackendserver/](https://link.juejin.cn?target=http%3A%2F%2Fmybackendserver%2F "http://mybackendserver/") **åè¾¹è¿™ä¸ªæ–œçº¿åŠ å’Œä¸åŠ åŒºåˆ«æŒºå¤§çš„**ï¼Œ`åŠ çš„è¯ä¸ä¼šæ‹¼æ¥/backend` , `è€Œä¸åŠ çš„è¯ä¼šæ‹¼æ¥ /backend` ,è¿™ä¸€ç‚¹æˆ‘ä»¬åœ¨15.5.3å°èŠ‚ä¼šè®²åˆ°ï¼Œè¿™é‡Œç•™æ„ä¸‹å°±å¥½ï¼‰

6.3ã€æµ‹è¯•åå‘ä»£ç†
----------

ä¿®æ”¹å®Œåæˆ‘ä»¬æ‰§è¡Œ nginx -s reload å‘½ä»¤é‡æ–°åŠ è½½nginxé…ç½®ï¼Œç„¶åå†potsmanä¸­è°ƒç”¨ä¸€ä¸‹ï¼Œå¦‚ä¸‹ï¼š

> psï¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ä¸­å‡ºç°äº†ä¸€ä¸ªé”™è¯¯: failed (13: Permission denied) while connecting to upstreamï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b20fc1bdc0fd41678904ae1859ad6255~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3562&h=160&s=78420&e=png&b=010101) è§£å†³åŠæ³•å¾ˆç®€å•åœ¨è™šæ‹Ÿæœºæ‰§è¡Œå‘½ä»¤ï¼šsetenforce 0 æ¥å…³é—­`seLinuxçš„é™åˆ¶`å³å¯ï¼Œæˆ–è€…å‚è€ƒï¼š[stackoverflowä¸Šçš„è§£å†³æ–¹æ¡ˆ](https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F23948527%2F13-permission-denied-while-connecting-to-upstreamnginx "https://stackoverflow.com/questions/23948527/13-permission-denied-while-connecting-to-upstreamnginx")

è§£å†³åå†æ¬¡è°ƒç”¨å‘ç°å¯ä»¥äº†ï¼šï¼ˆæ³¨æ„ [www.proxytest.com](https://link.juejin.cn?target=http%3A%2F%2Fwww.proxytest.com "http://www.proxytest.com") æ˜¯æˆ‘éšä¾¿å†™çš„åŸŸåæ²¡åšdnsè§£æï¼Œæˆ‘æ˜¯åœ¨è¯·æ±‚å‘å‡ºæ–¹ å®¿ä¸»æœº é…äº†hostï¼Œæ‰€ä»¥æ‰èƒ½è¯·æ±‚é€šï¼‰ ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fcf2fba55362411cb87886220be08b31~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3220&h=1416&s=227407&e=png&b=fdfdfd)åŒæ—¶ä¹Ÿå¯ä½¿ç”¨å‘½ä»¤ tail -n +1 -f access.log è§‚å¯Ÿåˆ°nginxæ—¥å¿—è¾“å‡ºå¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6da779ef690a4df0b18e56f914e30ff6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3134&h=328&s=82297&e=png&b=010101)

6.4ã€åå‘ä»£ç†æµç¨‹ä¸åŸç†
-------------

å¯¹äºä¸Šè¾¹æ¼”ç¤ºçš„åå‘ä»£ç†æ¡ˆä¾‹çš„æµç¨‹ä¸åŸç†ï¼Œæˆ‘ä»¬æ¥ä¸ªç¤ºæ„å›¾å¦‚ä¸‹ï¼šï¼ˆè¿™ä¸ªå›¾æ¯”è¾ƒé‡è¦ï¼‰ ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6cd983baf59944abb6510a3b717a8490~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2612&h=1450&s=259427&e=png&b=ffffff)

æ¥ä¸‹æ¥æˆ‘ä»¬æ¼”ç¤ºä¸‹è´Ÿè½½å‡è¡¡ã€‚

7ã€è´Ÿè½½å‡è¡¡
======

è¯´åˆ°è´Ÿè½½å‡è¡¡å¾ˆå¤šäººåº”è¯¥å¹¶ä¸é™Œç”Ÿï¼Œæ€»è€Œè¨€ä¹‹è´Ÿè½½å‡è¡¡å°±æ˜¯ï¼šé¿å…é«˜å¹¶å‘é«˜æµé‡æ—¶è¯·æ±‚éƒ½èšé›†åˆ°æŸä¸€ä¸ªæœåŠ¡æˆ–è€…æŸå‡ ä¸ªæœåŠ¡ä¸Šï¼Œè€Œæ˜¯è®©å…¶å‡åŒ€åˆ†é…ï¼ˆæˆ–è€…èƒ½è€…å¤šåŠ³ï¼‰ï¼Œä»è€Œå‡å°‘é«˜å¹¶å‘å¸¦æ¥çš„ç³»ç»Ÿå‹åŠ›ï¼Œä»è€Œè®©æœåŠ¡æ›´ç¨³å®šã€‚å¯¹äºnginxæ¥è¯´ï¼Œè´Ÿè½½å‡è¡¡å°±æ˜¯ä» `upstream` æ¨¡å—å®šä¹‰çš„åç«¯æœåŠ¡å™¨åˆ—è¡¨ä¸­æŒ‰ç…§é…ç½®çš„è´Ÿè½½ç­–ç•¥é€‰å–ä¸€å°æœåŠ¡å™¨æ¥å—ç”¨æˆ·çš„è¯·æ±‚ã€‚

7.1ã€å‡†å¤‡3ä¸ªä¸åŒç«¯å£çš„springbootæœåŠ¡
-------------------------

æƒ³è¦æ¼”ç¤ºè´Ÿè½½å‡è¡¡ï¼Œæˆ‘ä»¬é¦–å…ˆå¾—å¤šæå‡ ä¸ªæœåŠ¡ï¼Œæä¸€ä¸ªæœåŠ¡æ˜¯æ²¡æ³•å„¿æ¼”ç¤ºçš„ã€‚æ‰€ä»¥æˆ‘å¯åŠ¨äº†3ä¸ªä¸åŒç«¯å£ï¼ˆ8081ï¼Œ8082ï¼Œ8083ï¼‰çš„springbootæœåŠ¡ï¼Œå¦‚ä¸‹ï¼š

perl

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`java -jar /Users/hzz/myself_project/xzll/study-admin/study-admin-service/target/study-admin-service.jar --server.port=8081 java -jar /Users/hzz/myself_project/xzll/study-admin/study-admin-service/target/study-admin-service.jar --server.port=8082 java -jar /Users/hzz/myself_project/xzll/study-admin/study-admin-service/target/study-admin-service.jar --server.port=8083`

ä½¿ç”¨ command+D å¯¹iterm2è¿›è¡Œåˆ†å± ï¼Œæœ€å·¦ä¾§æ˜¯8081ç«¯å£ï¼Œä¸­é—´æ˜¯8082ï¼Œå³ä¾§æ˜¯8083ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9ff1fcf675f74538ab25a0808abc8d5d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3550&h=1950&s=1320742&e=png&b=232323) æ¥ä¸‹æ¥æˆ‘ä»¬è¯´ä¸€ä¸‹è´Ÿè½½ç­–ç•¥å†å¼€å§‹ã€‚

7.2ã€nginxå¸¸ç”¨çš„è´Ÿè½½ç­–ç•¥:
-----------------

| è´Ÿè½½ç­–ç•¥ | æè¿° | ç‰¹ç‚¹ |
| --- | --- | --- |
| è½®è¯¢ | é»˜è®¤æ–¹å¼ | 1\. æ¯ä¸ªè¯·æ±‚ä¼šæŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨  
2\. åœ¨è½®è¯¢ä¸­ï¼Œå¦‚æœæœåŠ¡å™¨downæ‰äº†ï¼Œä¼šè‡ªåŠ¨å‰”é™¤è¯¥æœåŠ¡å™¨  
3\. ç¼ºçœé…ç½®å°±æ˜¯è½®è¯¢ç­–ç•¥  
4\. æ­¤ç­–ç•¥é€‚åˆæœåŠ¡å™¨é…ç½®ç›¸å½“ï¼Œæ— çŠ¶æ€ä¸”çŸ­å¹³å¿«çš„æœåŠ¡ä½¿ç”¨ |
| weight | æƒé‡æ–¹å¼ | 1\. åœ¨è½®è¯¢ç­–ç•¥çš„åŸºç¡€ä¸ŠæŒ‡å®šè½®è¯¢çš„å‡ ç‡  
2\. æƒé‡è¶Šé«˜åˆ†é…åˆ°çš„è¯·æ±‚è¶Šå¤š  
3\. æ­¤ç­–ç•¥å¯ä»¥ä¸least\_connå’Œip\_hashç»“åˆä½¿ç”¨  
4\. æ­¤ç­–ç•¥æ¯”è¾ƒé€‚åˆæœåŠ¡å™¨çš„ç¡¬ä»¶é…ç½®å·®åˆ«æ¯”è¾ƒå¤§çš„æƒ…å†µ |
| ip\_hash | ä¾æ®ipçš„hashå€¼æ¥åˆ†é… | 1\. åœ¨nginxç‰ˆæœ¬1.3.1ä¹‹å‰ï¼Œä¸èƒ½åœ¨ip\_hashä¸­ä½¿ç”¨æƒé‡ï¼ˆweightï¼‰  
2\. ip\_hashä¸èƒ½ä¸backupåŒæ—¶ä½¿ç”¨  
3\. æ­¤ç­–ç•¥é€‚åˆæœ‰çŠ¶æ€æœåŠ¡ï¼Œæ¯”å¦‚session  
4\. å½“æœ‰æœåŠ¡å™¨éœ€è¦å‰”é™¤ï¼Œå¿…é¡»æ‰‹åŠ¨downæ‰ |
| least\_conn | æœ€å°‘è¿æ¥æ–¹å¼ | 1\. æ­¤è´Ÿè½½å‡è¡¡ç­–ç•¥é€‚åˆè¯·æ±‚å¤„ç†æ—¶é—´é•¿çŸ­ä¸ä¸€é€ æˆæœåŠ¡å™¨è¿‡è½½çš„æƒ…å†µ |
| fairï¼ˆç¬¬ä¸‰æ–¹ï¼‰ | å“åº”æ—¶é—´æ–¹å¼ | 1\. æ ¹æ®åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­çš„ä¼˜å…ˆåˆ†é…  
2\. Nginxæœ¬èº«ä¸æ”¯æŒfairï¼Œå¦‚æœéœ€è¦è¿™ç§è°ƒåº¦ç®—æ³•ï¼Œåˆ™å¿…é¡»å®‰è£…upstream\_fairæ¨¡å— |
| url\_hashï¼ˆç¬¬ä¸‰æ–¹ï¼‰ | ä¾æ®URLåˆ†é…æ–¹å¼ | 1\. æŒ‰è®¿é—®çš„URLçš„å“ˆå¸Œç»“æœæ¥åˆ†é…è¯·æ±‚ï¼Œä½¿æ¯ä¸ªURLå®šå‘åˆ°ä¸€å°åç«¯æœåŠ¡å™¨  
2\. Nginxæœ¬èº«ä¸æ”¯æŒurl\_hashï¼Œå¦‚æœéœ€è¦è¿™ç§è°ƒåº¦ç®—æ³•ï¼Œåˆ™å¿…é¡»å®‰è£…Nginxçš„hashè½¯ä»¶åŒ… |

### 7.2.1ã€è½®è¯¢

è½®è¯¢ç­–ç•¥æ˜¯é»˜è®¤çš„ï¼Œæ‰€ä»¥åªéœ€è¦å¦‚ä¸‹è¿™æ ·ä¿®æ”¹é…ç½®æ–‡ä»¶å°±å¯ä»¥äº†ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ce021eaa72194ccea51dc6f699c55e95~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1186&h=938&s=102633&e=png&b=000000) é‡å¯nginxåè§‚å¯Ÿä¸€ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2166f81edf34ec5a8b4e932753a4e75~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3542&h=1922&s=980779&e=png&b=2b2b2b) ä»¥ä¸Šå›¾ç‰‡å¯ä»¥çœ‹åˆ°ï¼Œæ˜¯æŒ‰upstreamä¸­çš„å…ˆåé¡ºåºæ¥è¿›è¡Œè½®è¯¢çš„ã€‚

### 7.2.2ã€weight

weightæŒ‡ä»¤ç”¨äºæŒ‡å®šè½®è¯¢æœºç‡ï¼Œweightçš„é»˜è®¤å€¼ä¸º1ï¼Œweightçš„æ•°å€¼ä¸è®¿é—®æ¯”ç‡æˆæ­£æ¯”ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬æŒ‡å®š8082ç«¯å£çš„æœåŠ¡çš„weight=2ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3243101b8ce348ce901e5bb72e4e16c8~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1182&h=950&s=99825&e=png&b=010101) çœ‹ä¸‹æƒé‡ç­–ç•¥ä¸‹çš„è¯·æ±‚ç»“æœï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d5281831071b4af89abbcab0872bbca3~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3554&h=1958&s=1160694&e=png&b=222222) å¯ä»¥çœ‹åˆ°åœ¨ä¸€è½®è½®è¯¢ä¸­ï¼Œ8081å‘½ä¸­1æ¬¡ï¼Œ8082ç”±äºé…ç½®äº† weight=2æ‰€ä»¥å‘½ä¸­äº†2æ¬¡ï¼Œ8083å‘½ä¸­äº†1æ¬¡ã€‚å³é…ç½®äº†weight=2çš„8082æœåŠ¡ï¼Œå‘½ä¸­å‡ ç‡æ˜¯8081æˆ–è€…8083çš„ä¸¤å€

### 7.2.3ã€ip\_hash

è®¾å®šipå“ˆå¸Œå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ä½ çš„upstreamä¸­ æŒ‡å®š `ip_hash;`å³å¯ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/65caa05e4c074534b40d5e9d980c871a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1156&h=920&s=89812&e=png&b=010101) é‡å¯nginxåçœ‹ä¸‹æ•ˆæœï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ea9f2b9e30cf4bba9f57b33ecbc87976~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3542&h=1948&s=576034&e=png&b=282828) å¯ä»¥çœ‹åˆ°ï¼Œç”±äºæˆ‘çš„è®¿é—®ipæ€»æ˜¯å›ºå®šçš„å®¿ä¸»æœºçš„172.30.128.64 æ ¹æ®hashç®—æ³•æˆ‘çš„ipè¢«åŒ¹é…ç»™äº†8083ç«¯å£çš„æœåŠ¡ï¼Œæ‰€ä»¥åªè¦æˆ‘ä¸æ¢ip ä¸ç®¡æˆ‘è¯·æ±‚å¤šå°‘æ¬¡ï¼Œè¯·æ±‚éƒ½æ˜¯è¢« è½¬å‘åˆ°äº†8083çš„æœåŠ¡ä¸Šäº†ã€‚

### 7.2.4ã€least\_conn

åŒip\_hashä¸€æ ·ï¼Œè®¾å®šæœ€å°è¿æ¥æ•°ç­–ç•¥ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨ä½ çš„upstreamä¸­ æŒ‡å®š `least_conn;`å³å¯ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/66c66d671b044574aa52abe89e4f1133~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1116&h=960&s=110038&e=png&b=000000) ç”±äºæˆ‘è¿™é‡Œæœ€å°è¿æ¥æ•°çœ‹ä¸å‡ºå•¥æ•ˆæœï¼Œæ‰€ä»¥å°±ä¸æ¼”ç¤ºæˆªå›¾äº†ï¼ŒçŸ¥é“æ€ä¹ˆé…ç½®æœ€å°è¿æ¥æ•°å³å¯ã€‚å…³äºç¬¬ä¸‰æ–¹çš„è´Ÿè½½ç­–ç•¥ã€‚ä¸åšè¿‡å¤šè¯´æ˜äº†ï¼Œå¯ä»¥çœ‹çœ‹ï¼š[nginxå®˜æ–¹æ–‡æ¡£](https://link.juejin.cn?target=https%3A%2F%2Fdocs.nginx.com%2Fnginx%2Fadmin-guide%2Fload-balancer%2Fhttp-load-balancer%2F "https://docs.nginx.com/nginx/admin-guide/load-balancer/http-load-balancer/") è·å–å…¶ä»–çš„ç½‘ä¸Šèµ„æ–™ã€‚

8ã€åŠ¨é™åˆ†ç¦»
======

åœ¨è¯´åŠ¨é™åˆ†ç¦»å‰ï¼Œæˆ‘ä»¬è¦çŸ¥é“ä¸ºä½•è¦åšåŠ¨é™åˆ†ç¦»ä»¥åŠä»–èƒ½è§£å†³å•¥é—®é¢˜ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬å¸¸è§çš„webç³»ç»Ÿä¸­ä¼šæœ‰å¤§é‡çš„é™æ€èµ„æºæ–‡ä»¶æ¯”å¦‚æ˜é‡‘ä¸»é¡µé¢åˆ·æ–°åçš„f12å¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8215059d01a645e7a6ea31a4abec3314~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1924&h=1714&s=739313&e=png&b=fefefe) å¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šé™æ€èµ„æºï¼Œå¦‚æœå°†è¿™äº›èµ„æºéƒ½æåˆ°åç«¯æœåŠ¡çš„è¯ï¼Œå°†ä¼šæé«˜åç«¯æœåŠ¡çš„å‹åŠ›ä¸”å ç”¨å¸¦å®½å¢åŠ äº†ç³»ç»Ÿè´Ÿè½½ï¼ˆè¦çŸ¥é“ï¼Œé™æ€èµ„æºçš„è®¿é—®é¢‘ç‡å…¶å®è›®é«˜çš„ï¼‰æ‰€ä»¥ä¸ºäº†é¿å…è¯¥ç±»é—®é¢˜æˆ‘ä»¬å¯ä»¥æŠŠä¸å¸¸ä¿®æ”¹çš„é™æ€èµ„æºæ–‡ä»¶æ”¾åˆ°nginxçš„é™æ€èµ„æºç›®å½•ä¸­å»ï¼Œè¿™æ ·åœ¨è®¿é—®é™æ€èµ„æºæ—¶ç›´æ¥è¯»å–nginxæœåŠ¡å™¨æœ¬åœ°æ–‡ä»¶ç›®å½•ä¹‹åè¿”å›ï¼Œè¿™æ ·å°±å¤§å¤§å‡å°‘äº†åç«¯æœåŠ¡çš„å‹åŠ›åŒæ—¶ä¹ŸåŠ å¿«äº†é™æ€èµ„æºçš„è®¿é—®é€Ÿåº¦ï¼Œä½•ä¸ºé™ï¼Œä½•ä¸ºåŠ¨å‘¢ï¼Ÿï¼š

1.  **é™ï¼š** å°†ä¸å¸¸ä¿®æ”¹ä¸”è®¿é—®é¢‘ç¹çš„é™æ€æ–‡ä»¶ï¼Œæ”¾åˆ°nginxæœ¬åœ°é™æ€ç›®å½•ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥æä¸ªé™æ€èµ„æºæœåŠ¡å™¨ä¸“é—¨å­˜æ”¾æ‰€æœ‰é™æ€æ–‡ä»¶ï¼‰
2.  **åŠ¨ï¼š** å°†å˜åŠ¨é¢‘ç¹/å®æ—¶æ€§è¾ƒé«˜çš„æ¯”å¦‚åç«¯æ¥å£ï¼Œå®æ—¶è½¬å‘åˆ°å¯¹åº”çš„åå°æœåŠ¡

æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ„é€ ä¸€ä¸ªhtmlé¡µé¢ï¼Œç„¶åç‚¹å‡»æŒ‰é’®åå‘é€getè¯·æ±‚åˆ°åç«¯æ¥å£ã€‚æµç¨‹å¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8418a768c2784f908ef61074ffc7b8a4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1146&h=708&s=95694&e=png&b=ffffff)

8.1ã€å‡†å¤‡å·¥ä½œ
--------

é¦–å…ˆæˆ‘ä»¬æä¸ªhtmlï¼ˆè¯·åŸè°…æˆ‘è¿™ç²—ç³™çš„å‰ç«¯ä»£ç ğŸ˜‚ğŸ˜‚ï¼‰,å†…å®¹å¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aa5b2655fc014eadbe37f5670d575413~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2318&h=1974&s=470447&e=png&b=1f1f1f) ä¹‹åä½¿ç”¨

ruby

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`scp /Users/hzz/fsdownload/index_page.html root@172.30.128.65:/usr/local/nginx/test/static`

å‘½ä»¤å°†index\_page.html æ–‡ä»¶ä¸Šä¼ åˆ°è™šæ‹Ÿæœºã€‚

8.2ã€ä¿®æ”¹nginx.confæ–‡ä»¶
------------------

é¦–å…ˆæˆ‘ä»¬é…ç½®ä¿©locationè§„åˆ™,ä¸€ä¸ªï¼ˆ /frontend ï¼‰æ˜¯è¯»å–é™æ€æ–‡ä»¶ï¼Œä¸€ä¸ªï¼ˆ/backendï¼‰æ˜¯è½¬å‘åˆ° æˆ‘ä»¬é…ç½®çš„upstreamæœåŠ¡ä¸­å»ã€‚å¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb0421cc4d1c47a788e8a06c597a9da8~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1368&h=1590&s=170684&e=png&b=000000)

8.3ã€æ¼”ç¤º
------

é¦–å…ˆæˆ‘ä»¬åœ¨æµè§ˆå™¨è¾“å…¥ï¼š[www.proxytest.com/frontend/](https://link.juejin.cn?target=http%3A%2F%2Fwww.proxytest.com%2Ffrontend%2F "http://www.proxytest.com/frontend/") ï¼Œå¯ä»¥çœ‹åˆ°è¯·æ±‚è¿”å›äº†ä¸€ä¸ªhtmlé¡µé¢ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬åˆšæ‰çš„ /usr/local/nginx/test/static/index\_page.htmlæ–‡ä»¶ ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b2684cbef96645298fc0cd904579265a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3548&h=1980&s=719150&e=png&b=ffffff) æ¥ç€æˆ‘ä»¬è¾“å…¥è¦æŸ¥è¯¢çš„äººåï¼Œä¹‹åç‚¹å‡» "è°ƒç”¨getæ¥å£" æŒ‰é’®ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9e17b5fbfdbc4b56a36fe271dca2beb8~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3516&h=1884&s=930330&e=png&b=ffffff) è¿”å›æ•°æ®ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/25b739593cea436da5597cd299861115~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3416&h=1686&s=609426&e=png&b=ffffff) æŸ¥çœ‹nginxè®¿é—®æ—¥å¿—å¯ä»¥çœ‹åˆ°ä¸¤æ¬¡è¯·æ±‚çš„è¾“å‡ºï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/085c8b4eb6a747ef8694a3fbc043f9b2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3584&h=296&s=63836&e=png&b=000000)

okåˆ°è¿™é‡ŒåŠ¨é™åˆ†ç¦»å°±æ¼”ç¤ºå®Œäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹è·¨åŸŸ

9ã€è·¨åŸŸ
====

9.1ã€ä¸ºä½•ä¼šäº§ç”Ÿè·¨åŸŸï¼Ÿ
------------

äº§ç”Ÿè·¨åŸŸé—®é¢˜çš„ä¸»è¦åŸå› å°±åœ¨äºåŒæºç­–ç•¥ï¼Œä¸ºäº†ä¿è¯ç”¨æˆ·ä¿¡æ¯å®‰å…¨ï¼Œé˜²æ­¢æ¶æ„ç½‘ç«™çªƒå–æ•°æ®ï¼ŒåŒæºç­–ç•¥æ˜¯å¿…é¡»çš„ï¼Œè¯¥æ”¿ç­–ç”± Netscape å…¬å¸äº1995å¹´å¼•å…¥æµè§ˆå™¨ã€‚ç›®å‰ï¼Œæ‰€æœ‰æµè§ˆå™¨éƒ½å®è¡Œè¿™ä¸ªæ”¿ç­–ã€‚åŒæºç­–ç•¥ä¸»è¦æ˜¯æŒ‡ä¸‰ç‚¹ç›¸åŒå³ï¼š**åè®®+åŸŸå+ç«¯å£ ç›¸åŒçš„ä¸¤ä¸ªè¯·æ±‚**ï¼Œåˆ™å¯ä»¥è¢«çœ‹åš**æ˜¯åŒæº**çš„ï¼Œä½†å¦‚æœ**å…¶ä¸­ä»»æ„ä¸€ç‚¹å­˜åœ¨ä¸åŒ**ï¼Œåˆ™ä»£è¡¨æ˜¯**ä¸¤ä¸ªä¸åŒæºçš„è¯·æ±‚**ï¼ŒåŒæºç­–ç•¥ä¼šé™åˆ¶ä¸åŒæºä¹‹é—´çš„èµ„æºäº¤äº’ä»è€Œå‡å°‘æ•°æ®å®‰å…¨é—®é¢˜ã€‚

9.2ã€è·¨åŸŸæ¼”ç¤º
--------

é¦–å…ˆæˆ‘åœ¨nginx.confæ–‡ä»¶ä¸­åŠ ä¸€ä¸ªserveré…ç½®ä¹Ÿå³å°†å‰åç«¯é…æˆä¸åŒçš„server å¹¶ä¸”ç›‘å¬çš„ç«¯å£ä»¥åŠåŸŸååç§°éƒ½ä¸ä¸€è‡´ï¼Œä»è€Œ`é€ æˆ`è®¿é—®`å‰ç«¯æœåŠ¡å’Œåç«¯æœåŠ¡`æ—¶å€™ è¿™ä¿©æœåŠ¡`ä¸æ˜¯"åŒæº"`ï¼Œ å¦‚ä¸‹ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/820db4f4dfe643a88f3c628f23cfa392~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1288&h=1590&s=159800&e=png&b=000000) ä¹‹åæˆ‘ä¿®æ”¹index\_pageä¸­çš„åç«¯åœ°å€ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e3165e5e643d404c90e6dbb402530a7d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1898&h=1072&s=243627&e=png&b=1f1f1f) é‡å¯nginxï¼Œå¹¶é…ç½®å®¿ä¸»æœºçš„hostsæ–‡ä»¶ï¼š

makefile

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`172.30.128.65 www.front.com 172.30.128.65:90  www.backend.com`

ä¹‹ååœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ä¸€ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c4432be0fc544d3a63fa4e6b312cd9c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3196&h=1596&s=303575&e=png&b=f7f7f7) å¯ä»¥çœ‹åˆ°æµè§ˆå™¨æç¤ºæˆ‘ä»¬å—åŒæºè§„åˆ™å½±å“æˆ‘ä»¬ä¸èƒ½è·¨åŸŸè®¿é—®èµ„æºã€‚é€ æˆçš„åŸå› æ˜¯æˆ‘çš„ä¸¤ä¸ªåŸŸåè§£æå‡ºæ¥çš„ç«¯å£ä¸ä¸€è‡´ ä¸€ä¸ªæ˜¯80ä¸€ä¸ªæ˜¯90ã€‚ä¸ç¬¦åˆåŒæºç­–ç•¥ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šæœ‰è·¨åŸŸæŠ¥é”™ã€‚

9.3ã€nginxè§£å†³è·¨åŸŸ
-------------

é¦–å…ˆæƒ³è§£å†³è·¨è¶Šå°±å¾—é¿å…ä¸åŒæºï¼Œè€Œæˆ‘ä»¬å¯ä¸å¯ä»¥ æŠŠå¯¹åç«¯çš„ä»£ç† æ”¾åœ¨å‰ç«¯çš„serverä¸­å‘¢ï¼ˆä¹Ÿå°±æ˜¯è¯´è®©å‰åç«¯ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªç«¯å£ï¼Œä¸€ä¸ªserver\_nameï¼‰ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºserveræ”¯æŒå¤šä¸ªlocationé…ç½®å‘€ï¼ˆä¸€ä¸ªlocationå¤„ç†å‰ç«¯ï¼Œä¸€ä¸ªlocationè½¬å‘åç«¯ï¼‰ï¼Œæˆ‘ä»¬æ”¹ä¸‹é…ç½®æ–‡ä»¶è¯•ä¸€æŠŠå¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8b7c974e3c1647a78ebb7217b7e838f1~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1426&h=1416&s=147711&e=png&b=000000) ä¹‹åé‡å¯nginxååœ¨æµè§ˆå™¨è¾“å…¥ [www.xxxadminsystem.com/page/](https://link.juejin.cn?target=http%3A%2F%2Fwww.xxxadminsystem.com%2Fpage%2F "http://www.xxxadminsystem.com/page/") ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1f62b80ed64d42ba96a189d6d84c3371~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3548&h=2052&s=933049&e=png&b=fefefe) ä¸Šè¾¹/pageè¯·æ±‚è¿”å›äº†htmlé¡µé¢ä¹‹åæˆ‘ä»¬è¾“å…¥å‚æ•°ç‚¹å‡»â€œè°ƒç”¨getæ¥å£â€æŸ¥çœ‹åˆ°åç«¯æ¥å£çš„è°ƒç”¨å¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2bf18e319e7249e1841e8e8e08089c05~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3570&h=2020&s=883770&e=png&b=ffffff) ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3e328b4af14142dfad71ad39cfc09d68~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2454&h=1430&s=454537&e=png&b=ffffff) ä»ä¸Šè¾¹å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä¸Šè¾¹è®¾æƒ³çš„æ–¹å¼æ˜¯å¯è¡Œçš„ã€‚

*   å½“ç„¶æœ‰äº›èµ„æ–™ä¸Šæœ‰è¯´ä½¿ç”¨ è®¾ç½®headerçš„æ–¹å¼è§£å†³è·¨åŸŸï¼Œä½†æ˜¯åœ¨å®é™…æµ‹è¯•ä¸­ï¼Œè®¾ç½®headerçš„æ–¹å¼å§‹ç»ˆæ²¡è§£å†³è·¨åŸŸï¼Œè¯•äº†å¥½ä¹…ä¹Ÿæ²¡è§£å†³æ‰ğŸ˜‚ğŸ˜‚ï¼Œæœ‰è¯•è¿‡æ­¤æ–¹å¼è§£å†³çš„å¤§ä½¬å¸®å¿™çœ‹çœ‹æˆ‘è¿™æ˜¯å“ªé‡Œé…é”™äº†è¿˜æ˜¯å’‹çš„åœ¨æ­¤æå‰æ„Ÿè°¢äº†ã€‚
    
    > ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ab1b5d522d2f45b1a3ce5d7353f4c9c2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1680&h=1880&s=395837&e=png&b=010101)
    

10ã€ç¼“å­˜
=====

åœ¨å¼€å¤´æˆ‘ä»¬å°±ä»‹ç»è¿‡ï¼Œnginxä»£ç†ç¼“å­˜å¯ä»¥åœ¨æŸäº›åœºæ™¯ä¸‹æœ‰æ•ˆçš„å‡å°‘æœåŠ¡å™¨å‹åŠ›ï¼Œè®©è¯·æ±‚å¿«é€Ÿå“åº”ï¼Œä»è€Œæå‡ç”¨æˆ·ä½“éªŒå’ŒæœåŠ¡æ€§èƒ½ï¼Œé‚£ä¹ˆnginxç¼“å­˜å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿåœ¨ä½¿ç”¨åŠæ¼”ç¤ºå‰æˆ‘ä»¬å…ˆæ¥ç†Ÿæ‚‰ä¸‹ç›¸å…³çš„é…ç½®ä»¥åŠå…¶å«ä¹‰ï¼ŒçŸ¥é“äº†è¿™äº›æ‰èƒ½æ›´å¥½çš„ä½¿ç”¨nginxç¼“å­˜ã€‚

10.1ã€nginxç¼“å­˜é…ç½®å‚æ•°è¡¨æ ¼ä¸€è§ˆ
--------------------

| æŒ‡ä»¤åç§° | ä½œç”¨è§£é‡Š | è¯­æ³• | é»˜è®¤é…ç½® | ç¤ºä¾‹ | ä½œç”¨åŸŸ |
| --- | --- | --- | --- | --- | --- |
| proxy\_cache | è®¾ç½®æ˜¯å¦å¼€å¯å¯¹åç«¯å“åº”çš„ç¼“å­˜ã€‚ | proxy\_cache zone | off; | proxy\_cache off; | proxy\_cache mycache; # è§„å®šå¼€å¯nginxç¼“å­˜å¹¶ä¸”ç¼“å­˜åç§°ä¸º: mycache | http, server, location |
| proxy\_cache\_valid | é…ç½®ä»€ä¹ˆçŠ¶æ€ç å¯ä»¥è¢«ç¼“å­˜ï¼Œä»¥åŠç¼“å­˜æ—¶é•¿ | proxy\_cache\_valid \[code ...\] time; | æ²¡æœ‰é»˜è®¤å€¼ | proxy\_cache\_valid 200 304 2m; # å¯¹äºçŠ¶æ€ä¸º200å’Œ304çš„ç¼“å­˜æ–‡ä»¶ï¼Œç¼“å­˜æ—¶é—´æ˜¯2åˆ†é’Ÿ | http, server, location |
| proxy\_cache\_key | è®¾ç½®ç¼“å­˜æ–‡ä»¶çš„ key | proxy\_cache\_key string; | proxy\_cache\_key schemeschemeschemeproxy\_host$request\_uri; | proxy\_cache\_key "hosthosthostrequest\_uri $cookie\_user"; # ä½¿ç”¨host +è¯·æ±‚çš„uriä»¥åŠcookieæ‹¼æ¥æˆç¼“å­˜key | http, server, location |
| proxy\_cache\_path | æŒ‡å®šç¼“å­˜å­˜å‚¨çš„è·¯å¾„ï¼Œæ–‡ä»¶åä¸ºcache keyçš„md5å€¼ï¼Œç„¶åå¤šçº§ç›®å½•çš„è¯ï¼Œæ ¹æ®levelå‚æ•°æ¥ç”Ÿæˆï¼Œkey\_zoneå‚æ•°ç”¨æ¥æŒ‡å®šåœ¨å…±äº«å†…å­˜ä¸­ç¼“å­˜æ•°æ®çš„åç§°å’Œå†…å­˜å¤§å°ï¼Œæ¯”å¦‚keys\_zone=mycache:100mï¼Œinactiveç”¨æ¥æŒ‡å®šç¼“å­˜æ²¡æœ‰è¢«è®¿é—®åè¶…æ—¶ç§»é™¤çš„æ—¶é—´ï¼Œé»˜è®¤æ˜¯10åˆ†é’Ÿï¼Œä¹Ÿå¯ä»¥è‡ªå·±æŒ‡å®šæ¯”å¦‚inactive=2h ï¼›max\_size ç”¨æ¥æŒ‡å®šç¼“å­˜çš„æœ€å¤§å€¼ï¼Œè¶…è¿‡è¿™ä¸ªå€¼åˆ™ä¼šè‡ªåŠ¨ç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼ˆlruæ·˜æ±°ç®—æ³•ï¼‰çš„ç¼“å­˜ è¿™ä¸ªæŒ‡ä»¤å¯¹åº”çš„å‚æ•°å¾ˆå¤šï¼Œå…·ä½“è§å®˜ç½‘ï¼š[proxy\_cache\_path](https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%3F_ga%3D2.13518455.1300709501.1700036543-1660479828.1698914648%23proxy_cache_path "https://nginx.org/en/docs/http/ngx_http_proxy_module.html?_ga=2.13518455.1300709501.1700036543-1660479828.1698914648#proxy_cache_path") | proxy\_cache\_path path \[levels=levels\] \[use\_temp\_path=on|off\] keys\_zone=name:size \[inactive=time\] \[max\_size=size\] \[min\_free=size\] \[manager\_files=number\] \[manager\_sleep=time\] \[manager\_threshold=time\] \[loader\_files=number\] \[loader\_sleep=time\] \[loader\_threshold=time\] \[purger=on|off\] \[purger\_files=number\] \[purger\_sleep=time\] \[purger\_threshold=time\]; | æ—  | proxy\_cache\_path /data/nginx/cache levels=1:2 keys\_zone=mycache:128m inactive=3d max\_size=2g; # è®¾ç½®ç¼“å­˜å­˜æ”¾çš„ç›®å½•ä¸º/data/nginx/cacheï¼Œå¹¶è®¾ç½®ç¼“å­˜åç§°ä¸ºmycacheï¼Œå¤§å°ä¸º128mï¼Œ ä¸‰å¤©æœªè¢«è®¿é—®è¿‡çš„ç¼“å­˜å°†è‡ªåŠ¨æ¸…é™¤ï¼Œç£ç›˜ä¸­ç¼“å­˜çš„æœ€å¤§å®¹é‡ä¸º2GBã€‚ | http |
| proxy\_cache\_bypass | å®šä¹‰ä¸ä»ç¼“å­˜ä¸­è·å–å“åº”æ•°æ®çš„æ¡ä»¶ã€‚å¦‚æœå­—ç¬¦ä¸²å‚æ•°ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå€¼ä¸ä¸ºç©ºä¸”ä¸ç­‰äº" 0 "ï¼Œåˆ™ä¸ä¼šä»ç¼“å­˜ä¸­è·å–å“åº”: | proxy\_cache\_bypass string ...; | æ²¡æœ‰é»˜è®¤å€¼ | proxy\_cache\_bypass cookienocachecookie\_nocache cookienâ€‹ocachearg\_nocache$arg\_comment; | http, server, location |
| proxy\_cache\_min\_uses | æŒ‡å®šæŸä¸€ä¸ªç›¸åŒè¯·æ±‚åœ¨å‡ æ¬¡è¯·æ±‚ä¹‹åæ‰ç¼“å­˜å“åº”å†…å®¹ | proxy\_cache\_min\_uses number; | proxy\_cache\_min\_uses 1; | proxy\_cache\_min\_uses 3; è§„å®šæŸä¸€ä¸ªè¯·æ±‚åœ¨ç¬¬3æ¬¡ä¹‹åæ‰èµ°nginxç¼“å­˜ | http, server, location |
| proxy\_cache\_use\_stale | æŒ‡å®šåç«¯æœåŠ¡å™¨åœ¨è¿”å›ä»€ä¹ˆçŠ¶æ€ç çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨è¿‡æœŸçš„ç¼“å­˜ | proxy\_cache\_use\_stale error timeout invalid\_header http\_500 http\_502 http\_503 ... |off ; | proxy\_cache\_use\_stale off; | proxy\_cache\_use\_stale error timeout http\_500 http\_502 http\_503 http\_504; # è§„å®šæœåŠ¡åœ¨å‡ºç°error timeout,ä»¥åŠ502,503,504æ—¶å¯ä½¿ç”¨è¿‡æœŸç¼“å­˜ | http, server, location |
| proxy\_cache\_lock | é»˜è®¤ä¸å¼€å¯ï¼Œå¼€å¯åè‹¥å‡ºç°å¹¶å‘é‡å¤è¯·æ±‚ï¼Œnginxåªè®©ä¸€ä¸ªè¯·æ±‚å»åç«¯è¯»æ•°æ®ï¼Œå…¶ä»–çš„æ’é˜Ÿå¹¶å°è¯•ä»ç¼“å­˜ä¸­è¯»å–; | proxy\_cache\_lock on |off; | proxy\_cache\_lock off; | proxy\_cache\_lock on; # å¼€å¯ç¼“å­˜é” | http, server, location |
| proxy\_cache\_lock\_timeout | ç­‰å¾…ç¼“å­˜é”(proxy\_cache\_lock)è¶…æ—¶ä¹‹åå°†ç›´æ¥è¯·æ±‚åç«¯ï¼Œä¸”ç»“æœä¸ä¼šè¢«ç¼“å­˜ | proxy\_cache\_lock\_timeout time; | proxy\_cache\_lock\_timeout 5s; | proxy\_cache\_lock\_timeout 6s; # ç­‰å¾…ç¼“å­˜é”è¶…æ—¶ï¼ˆ6msï¼‰ä¹‹åå°†ç›´æ¥è¯·æ±‚åç«¯ï¼Œç»“æœä¸ä¼šè¢«ç¼“å­˜ã€‚ | http, server, location |
| proxy\_cache\_methods | å¦‚æœå®¢æˆ·ç«¯è¯·æ±‚æ–¹æ³•åœ¨è¯¥æŒ‡ä»¤ä¸­ï¼Œåˆ™å“åº”å°†è¢«ç¼“å­˜ã€‚â€œGETâ€å’Œâ€œHEADâ€æ–¹æ³•æ€»æ˜¯è¢«æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œå°½ç®¡å»ºè®®æ˜¾å¼åœ°æŒ‡å®šå®ƒ | proxy\_cache\_methods GET|HEAD |POST ...; | proxy\_cache\_methods GET HEAD; | proxy\_cache\_methods GET HEAD PUT POST; # è§„å®š å¯ç¼“å­˜çš„æ–¹æ³•æœ‰ ï¼šget head put post | http, server, location |
| .............. | .......... | .......... | .......... | .......... | .......... |

äº‹å®ä¸Šï¼Œ**ngx\_http\_proxy\_module**æ¨¡å—ä¸­**ä»£ç†ç¼“å­˜proxy\_cacheç›¸å…³çš„æŒ‡ä»¤è¿œä¸æ­¢è¿™äº›**ï¼Œåœ¨è¿™é‡Œæˆ‘ä¸å¯èƒ½æŠŠæ‰€æœ‰éƒ½åˆ—å‡ºæ¥ï¼Œåªåˆ—å‡ºä¸Šè¾¹é‚£å‡ ä¸ªå·²ç»å¾ˆå ç¯‡å¹…äº†ï¼Œå¦‚æœæœ‰éœ€è¦è¯·å‚è€ƒï¼š [nginxå®˜æ–¹æ–‡æ¡£](https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%3F_ga%3D2.13518455.1300709501.1700036543-1660479828.1698914648%23proxy_cache "https://nginx.org/en/docs/http/ngx_http_proxy_module.html?_ga=2.13518455.1300709501.1700036543-1660479828.1698914648#proxy_cache")ï¼Œ åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œè¯¦ç»†æè¿°äº†ngx\_http\_proxy\_moduleæ¨¡å—ï¼ˆåŒ…å«äº†proxy\_cacheéƒ¨åˆ†ï¼‰çš„å„ç§æŒ‡ä»¤ã€ä½œç”¨ä»¥åŠä½¿ç”¨æ–¹å¼ï¼Œç›¸ä¿¡åœ¨é‡åˆ°å›°éš¾å’Œç–‘æƒ‘æ—¶ï¼Œå®˜æ–¹æ–‡æ¡£æ°¸è¿œæ˜¯ä½ æœ€å¥½çš„è€å¸ˆï¼å¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/17766455a2f74e7ab69e249594eb5756~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2650&h=1946&s=473524&e=png&b=fbfbfb)

10.2ã€nginxç¼“å­˜ä½¿ç”¨ä¸æ•ˆæœæ¼”ç¤º
-------------------

**é¦–å…ˆæˆ‘ä»¬æƒ³è¦çš„æ•ˆæœæ˜¯ï¼š** å°† **url+å‚æ•°ä¸€æ ·** çš„è¯·æ±‚çš„ç»“æœï¼Œç¼“å­˜åˆ°nginxã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬ä¿®æ”¹ä¸‹nginx.confæ–‡ä»¶,å¦‚ä¸‹ï¼š

```ini
http{
    ...
    # æŒ‡å®šç¼“å­˜å­˜æ”¾ç›®å½•ä¸º/usr/local/nginx/test/nginx_cache_storageï¼Œå¹¶è®¾ç½®ç¼“å­˜åç§°ä¸ºmycacheï¼Œå¤§å°ä¸º64mï¼Œ 1å¤©æœªè¢«è®¿é—®è¿‡çš„ç¼“å­˜å°†è‡ªåŠ¨æ¸…é™¤ï¼Œç£ç›˜ä¸­ç¼“å­˜çš„æœ€å¤§å®¹é‡ä¸º1gb
    proxy_cache_path /usr/local/nginx/test/nginx_cache_storage levels=1:2 keys_zone=mycache:64m inactive=1d max_size=1g;
    ...
    
    server{
        ...
        #  æŒ‡å®š username å‚æ•°ä¸­åªè¦æœ‰å­—æ¯ å°±ä¸èµ°nginxç¼“å­˜  
        if ($arg_username ~ [a-z]) {
             set $cache_name "no cache";
        }
        
        location  /interface {
                   proxy_pass http://mybackendserver/;
                   # ä½¿ç”¨åä¸º mycache çš„ç¼“å­˜ç©ºé—´
                   proxy_cache mycache;
                   # å¯¹äº200 206 çŠ¶æ€ç çš„æ•°æ®ç¼“å­˜2åˆ†é’Ÿ
                   proxy_cache_valid 200 206 1m;
                   # å®šä¹‰ç”Ÿæˆç¼“å­˜é”®çš„è§„åˆ™ï¼ˆè¯·æ±‚çš„url+å‚æ•°ä½œä¸ºç¼“å­˜keyï¼‰
                   proxy_cache_key $host$uri$is_args$args;
                   # èµ„æºè‡³å°‘è¢«é‡å¤è®¿é—®2æ¬¡åå†åŠ å…¥ç¼“å­˜
                   proxy_cache_min_uses 3;
                   # å‡ºç°é‡å¤è¯·æ±‚æ—¶ï¼Œåªè®©å…¶ä¸­ä¸€ä¸ªå»åç«¯è¯»æ•°æ®ï¼Œå…¶ä»–çš„ä»ç¼“å­˜ä¸­è¯»å–
                   proxy_cache_lock on;
                   # ä¸Šé¢çš„é” è¶…æ—¶æ—¶é—´ä¸º4sï¼Œè¶…è¿‡4sæœªè·å–æ•°æ®ï¼Œå…¶ä»–è¯·æ±‚ç›´æ¥å»åç«¯
                   proxy_cache_lock_timeout 4s;
                   # å¯¹äºè¯·æ±‚å‚æ•°ä¸­æœ‰å­—æ¯çš„ ä¸èµ°nginxç¼“å­˜
                   proxy_no_cache $cache_name; # åˆ¤æ–­è¯¥å˜é‡æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼åˆ™ä¸è¿›è¡Œç¼“å­˜ï¼Œæ²¡æœ‰å€¼åˆ™è¿›è¡Œç¼“å­˜
                   # åœ¨å“åº”å¤´ä¸­æ·»åŠ ä¸€ä¸ªç¼“å­˜æ˜¯å¦å‘½ä¸­çš„çŠ¶æ€ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
                   add_header Cache-status $upstream_cache_status;    
        }
        ...
}

```



![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/74810a8e148442b3a8e4261fb735fb8f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2258&h=1738&s=346084&e=png&b=000000)

ps: åœ¨ä¸Šè¾¹é…ç½®æ–‡ä»¶ä¸­é™¤äº†ç¼“å­˜ç›¸å…³çš„é…ç½®ï¼Œæˆ‘ä»¬è¿˜åŠ äº†ä¸€ä¸ªå‚æ•°ï¼š

bash

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`add_header Cache-status $upstream_cache_status;`

> è¿™ä¸ªå‚æ•°å¯ä»¥æ–¹ä¾¿ä»å“åº”å¤´çœ‹åˆ°æ˜¯å¦å‘½ä¸­äº†nginxç¼“å­˜ï¼Œæ–¹ä¾¿æˆ‘ä»¬è§‚å¯Ÿï¼Œå…¶ä¸åŒçš„å€¼æœ‰ä¸åŒçš„å«ä¹‰ï¼Œupstream\_cache\_statusçš„å€¼é›†åˆå¦‚ä¸‹ï¼š  
>   
> MISSï¼šè¯·æ±‚æœªå‘½ä¸­ç¼“å­˜  
> HITï¼šè¯·æ±‚å‘½ä¸­ç¼“å­˜ã€‚  
> EXPIREDï¼šè¯·æ±‚å‘½ä¸­ç¼“å­˜ä½†ç¼“å­˜å·²è¿‡æœŸã€‚  
> STALEï¼šè¯·æ±‚å‘½ä¸­äº†é™ˆæ—§ç¼“å­˜ã€‚  
> REVALIDDATEDï¼šNginxéªŒè¯é™ˆæ—§ç¼“å­˜ä¾ç„¶æœ‰æ•ˆã€‚  
> UPDATINGï¼šå‘½ä¸­çš„ç¼“å­˜å†…å®¹é™ˆæ—§ï¼Œä½†æ­£åœ¨æ›´æ–°ç¼“å­˜ã€‚  
> BYPASSï¼šå“åº”ç»“æœæ˜¯ä»åŸå§‹æœåŠ¡å™¨è·å–çš„ã€‚  

nginx.confæ–‡ä»¶é…å¥½åï¼Œåœ¨è¯·æ±‚ä¹‹å‰å…ˆçœ‹ä¸‹æ•°æ®åº“ â€œhzznbâ€ å’Œ â€œå¼ æ— å¿Œâ€ éƒ½æ˜¯å­˜åœ¨çš„ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9c965cc026144f94805a82c97c80663d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2194&h=456&s=226716&e=png&b=2e2e2e)

æ¥ä¸‹æ¥æˆ‘ä»¬`åˆ†åˆ«æŸ¥è¯¢ å¼ æ— å¿Œ å’Œ hzznb` æ¥çœ‹çœ‹ç¼“å­˜å‘½ä¸­æƒ…å†µï¼š

æŸ¥è¯¢usernam=`å¼ æ— å¿Œï¼›` ç¬¬ä¸€æ¬¡ï¼ˆæœªå‘½ä¸­ï¼Œå› ä¸ºæ­¤ url+å‚æ•° ä¹‹å‰æ²¡è¯·æ±‚è¿‡ç¼“å­˜ä¸­ç¡®å®æ²¡æœ‰ï¼‰ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/05c283c6753a4f20b03745d3dea240de~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3508&h=1618&s=483677&e=png&b=fdfdfd) ç¬¬äºŒæ¬¡ä¹Ÿæœªå‘½ä¸­å°±ä¸æˆªå›¾äº†

ç¬¬ä¸‰æ¬¡ï¼ˆæœªå‘½ä¸­ï¼‰ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ce285146c833461f9f405d9d12a12eb7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3476&h=1486&s=438841&e=png&b=ffffff) ç¬¬å››æ¬¡ï¼ˆ**å‘½ä¸­**ï¼‰ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/87dfb978af614a659333ba2bc990843d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3476&h=1670&s=491789&e=png&b=ffffff)

æŸ¥è¯¢usernam=`hzznbï¼›` ç¬¬ä¸€æ¬¡(æœªå‘½ä¸­)ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3c576e4715344e6abc4560fc7812be03~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3508&h=1478&s=413353&e=png&b=ffffff) ç¬¬2,3æ¬¡ä¹Ÿéƒ½æ˜¯miss å³æœªå‘½ä¸­ï¼ˆæˆªå›¾ç•¥ï¼‰

ç¬¬å››æ¬¡ï¼šï¼ˆä»ç„¶æ˜¯æœªå‘½ä¸­ï¼Œè¯´æ˜æˆ‘ä»¬åœ¨nginx.confä¸­é…ç½®çš„è§„åˆ™ï¼šâ€å‚æ•°ä¸­å¸¦å­—æ¯åˆ™ä¸ç¼“å­˜â€œ ç”Ÿæ•ˆäº†ï¼ï¼‰ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/985388c367c14e8d9e1b53cd3093aede~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3506&h=1616&s=497156&e=png&b=fdfdfd)

11ã€é»‘ç™½åå•
=======

nginxé»‘ç™½åå•æ¯”è¾ƒç®€å•ï¼Œallowåé…ç½®ä½ çš„ç™½åå•ï¼Œdenyåé…ç½®ä½ çš„é»‘åå•ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯å»ºä¸ªé»‘åå•å’Œç™½åå•çš„æ–‡ä»¶ç„¶åå†nginx.copnfä¸­incluldä¸€ä¸‹ï¼Œè¿™æ ·ä¿æŒä¸»é…ç½®æ–‡ä»¶æ•´æ´ï¼Œä¹Ÿå¥½ç®¡ç†ã€‚ä¸‹è¾¹æˆ‘ä¸ºäº†æ–¹ä¾¿å°±ç›´æ¥åœ¨ä¸»é…ç½®å†™äº†ã€‚

11.1ã€è¯­æ³•ä½œç”¨åŸŸ
----------

å…³äºé»‘ç™½åå•çš„è¯­æ³•å’Œä½œç”¨ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä¸‹å®˜ç½‘çš„ç¤ºä¾‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19d8b4060ade4e80bd57ec018630db22~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2664&h=2058&s=556935&e=png&b=fdfdfd) å¯ä»¥çœ‹åˆ°ip å¯ä»¥æ˜¯ipv4 ä¹Ÿå¯ä»¥æ˜¯ipv6 ä¹Ÿå¯ä»¥æŒ‰ç…§ç½‘æ®µæ¥é…ç½®ï¼Œå½“ç„¶ipé»‘ç™½é…ç½®å¯ä»¥åœ¨ httpï¼Œserverï¼Œlocationå’Œlimit\_exceptè¿™å‡ ä¸ªåŸŸéƒ½å¯ä»¥åŒºåˆ«åªæ˜¯ä½œç”¨ç²’åº¦å¤§å°é—®é¢˜ã€‚å½“ç„¶nginxå»ºè®®æˆ‘ä»¬ä½¿ç”¨ ngx\_http\_geo\_moduleè¿™ä¸ªåº“ï¼Œngx\_http\_geo\_moduleåº“æ”¯æŒ æŒ‰åœ°åŒºã€å›½å®¶è¿›è¡Œå±è”½ï¼Œå¹¶ä¸”æä¾›äº†IPåº“ï¼Œå½“éœ€è¦é…ç½®çš„åå•æ¯”è¾ƒå¤šæˆ–è€…æ ¹æ®åœ°åŒºå›½å®¶å±è”½æ—¶è¿™ä¸ªåº“å¯ä»¥å¸®ä¸Šå¤§å¿™ã€‚

ä¸‹é¢æˆ‘ä»¬é…ç½®å¹¶æ¼”ç¤ºä¸€ä¸‹ï¼š

11.2ã€é»‘ç™½åå•æ¼”ç¤º
-----------

**å…è®¸ä»»ä½•ipè®¿é—®å‰ç«¯ï¼Œç„¶åç¦æ­¢172.30.128.64è®¿é—®åç«¯**ï¼Œnginx.confæ–‡ä»¶å¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/aec3216ee5354b2a913c66bc0afe4f37~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2428&h=1832&s=356656&e=png&b=000000) è®¿é—®å‰ç«¯ï¼Œèµ°/pageè¿™ä¸ªlocationï¼ˆå¯ä»¥è®¿é—®æˆåŠŸï¼‰ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc8ae97280d4481cae7ee662a1c1e485~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3524&h=1808&s=809270&e=png&b=ffffff) è®¿é—®åç«¯ï¼Œèµ°interfaceè¿™ä¸ªlocationï¼ˆæ˜¾ç¤º403è¢«ç¦æ­¢äº†ï¼‰ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/66ebb732a42249a8b1b91380970331c9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3506&h=1760&s=806046&e=png&b=fefefe)

12ã€nginxé™æµ
==========

Nginxä¸»è¦æœ‰ä¸¤ç§é™æµæ–¹å¼ï¼šæŒ‰å¹¶å‘è¿æ¥æ•°é™æµ(ngx\_http\_limit\_conn\_module)ã€æŒ‰è¯·æ±‚é€Ÿç‡é™æµ(ngx\_http\_limit\_req\_module ä½¿ç”¨çš„ä»¤ç‰Œæ¡¶ç®—æ³•)ã€‚

å…³äº ngx\_http\_limit\_req\_moduleæ¨¡å—ï¼Œé‡Œè¾¹æœ‰å¾ˆå¤šç§é™æµæŒ‡ä»¤ï¼Œå®˜ç½‘èµ„æ–™ä¸€è§ˆï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6fa7772d23e143939490bd8373a801ad~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2082&h=1782&s=339953&e=png&b=fdfdfd) æˆ‘ä»¬ä¸‹é¢ä½¿ç”¨ ngx\_http\_limit\_req\_module æ¨¡å—ä¸­çš„limit\_req\_zoneå’Œ limit\_req è¿™ä¸¤ä¸ªæŒ‡ä»¤æ¥è¾¾åˆ°é™åˆ¶å•ä¸ªIPçš„**è¯·æ±‚é€Ÿç‡** çš„ç›®çš„ã€‚

12.1ã€nginxé™æµé…ç½®è§£é‡Š
----------------

åœ¨ nginx.conf ä¸­æ·»åŠ é™æµé…ç½®å¦‚ä¸‹ï¼š

```ini
http{
    ...
    # å¯¹è¯·æ±‚é€Ÿç‡é™æµ
    limit_req_zone $binary_remote_addr zone=myRateLimit:10m rate=5r/s;
    
    server{
        location /interface{
            ...
            limit_req zone=myRateLimit burst=5  nodelay;
            limit_req_status 520;
            limit_req_log_level info;
        }
    }
}


```



![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8cfe0df0bd92490fb641ba50bb66c4a4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2354&h=1860&s=358907&e=png&b=010101) å¯¹ä¸Šå›¾æ ‡çº¢çš„é…ç½®åšä¸ªè§£é‡Šï¼š

**$binary\_remote\_addr**ï¼šè¡¨ç¤ºåŸºäº remote\_addr(å®¢æˆ·ç«¯IP) æ¥åšé™æµ **zone=myRateLimit:10m**ï¼šè¡¨ç¤ºä½¿ç”¨myRateLimitæ¥ä½œä¸ºå†…å­˜åŒºåŸŸï¼ˆå­˜å‚¨è®¿é—®ä¿¡æ¯ï¼‰çš„åå­—ï¼Œå¤§å°ä¸º10Mï¼Œ1Mèƒ½å­˜å‚¨16000 IPåœ°å€çš„è®¿é—®ä¿¡æ¯ï¼Œ10Må¯ä»¥å­˜å‚¨16W IPåœ°å€è®¿é—®ä¿¡æ¯ **rate=5r/s**ï¼šè¡¨ç¤ºç›¸åŒipæ¯ç§’æœ€å¤šè¯·æ±‚5æ¬¡ï¼Œnginxæ˜¯ç²¾ç¡®åˆ°æ¯«ç§’çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤é…ç½®ä»£è¡¨æ¯200æ¯«ç§’å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œè¿™æ„å‘³ç€è‡ªä¸Šä¸€ä¸ªè¯·æ±‚å¤„ç†å®Œåï¼Œè‹¥åç»­200æ¯«ç§’å†…åˆæœ‰è¯·æ±‚åˆ°è¾¾ï¼Œå°†æ‹’ç»å¤„ç†è¯¥è¯·æ±‚ï¼ˆå¦‚æœæ²¡é…burstçš„è¯ï¼‰  
**burst=5**ï¼š(è‹±æ–‡ çˆ†å‘ çš„æ„æ€)ï¼Œæ„æ€æ˜¯è®¾ç½®ä¸€ä¸ªå¤§å°ä¸º5çš„ç¼“å†²é˜Ÿåˆ—ï¼Œè‹¥åŒæ—¶æœ‰6ä¸ªè¯·æ±‚åˆ°è¾¾ï¼ŒNginx ä¼šå¤„ç†ç¬¬ä¸€ä¸ªè¯·æ±‚ï¼Œå‰©ä½™5ä¸ªè¯·æ±‚å°†æ”¾å…¥é˜Ÿåˆ—ï¼Œç„¶åæ¯éš”200msä»é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªè¯·æ±‚è¿›è¡Œå¤„ç†ã€‚è‹¥è¯·æ±‚æ•°å¤§äº6ï¼Œå°†æ‹’ç»å¤„ç†å¤šä½™çš„è¯·æ±‚ï¼Œç›´æ¥è¿”å›503  
**nodelay**ï¼šé’ˆå¯¹çš„æ˜¯ burst å‚æ•°ï¼Œburst=5 nodelay è¿™ä¸ªé…ç½®è¡¨ç¤ºè¢«æ”¾åˆ°ç¼“å†²é˜Ÿåˆ—çš„è¿™5ä¸ªè¯·æ±‚ä¼šç«‹é©¬å¤„ç†ï¼Œä¸å†æ˜¯æ¯éš”200mså–ä¸€ä¸ªäº†ã€‚ä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿è¿™5ä¸ªçªå‘è¯·æ±‚ç«‹é©¬å¤„ç†å¹¶ç»“æŸï¼Œåç»­æ¥äº†è¯·æ±‚ä¹Ÿä¸ä¸€å®šä¸ä¼šç«‹é©¬å¤„ç†ï¼Œå› ä¸ºè™½ç„¶è¯·æ±‚è¢«å¤„ç†äº†ä½†æ˜¯è¯·æ±‚æ‰€å çš„å‘å¹¶ä¸ä¼šè¢«ç«‹å³é‡Šæ”¾ï¼Œè€Œæ˜¯åªèƒ½æŒ‰ 200ms ä¸€ä¸ªæ¥é‡Šæ”¾ï¼Œé‡Šæ”¾ä¸€ä¸ªå æ‰å°†ç­‰å¾…çš„è¯·æ±‚ å…¥é˜Ÿä¸€ä¸ªã€‚  
**å¦å¤–ä¸¤ä¸ªï¼š** limit\_req\_status=520è¡¨ç¤ºå½“è¢«é™æµåï¼Œnginxçš„è¿”å›ç ï¼Œlimit\_req\_log\_level infoä»£è¡¨æ—¥å¿—çº§åˆ«

**æ³¨æ„ï¼š** å¦‚æœä¸å¼€å¯nodelayä¸”å¼€å¯äº†burstè¿™ä¸ªé…ç½®ï¼Œé‚£ä¹ˆå°†ä¼šä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒï¼ˆä½ æƒ³æƒ³å‡è®¾bursté˜Ÿåˆ—é•¿åº¦ä¸º100çš„è¯æ¯100mså¤„ç†ä¸€ä¸ª,é‚£é˜Ÿåˆ—æœ€åé‚£ä¸ªè¯·æ±‚å¾—ç­‰10000ms=10såæ‰èƒ½è¢«å¤„ç†ï¼Œé‚£ä¸è¶…æ—¶æ‰æ€ªå‘¢æ­¤æ—¶burstå·²ç»æ„ä¹‰ä¸å¤§äº†ï¼‰æ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ å»ºè®®burstå’Œnodelayç»“åˆä½¿ç”¨ï¼Œä»è€Œå°½å¯èƒ½è¾¾åˆ°é€Ÿç‡ç¨³å®šï¼Œä½†çªç„¶æµé‡ä¹Ÿèƒ½æ­£å¸¸å¤„ç†çš„æ•ˆæœã€‚

12.2ã€nginxé™æµï¼ˆé’ˆå¯¹è¯·æ±‚é€Ÿç‡ï¼‰
--------------------

ä¸ºäº†çªå‡ºburstå’Œnodealyçš„ä½œç”¨ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¼”ç¤º

### 12.2.1ã€é™åˆ¶æ¯ç§’åŒä¸€ipæœ€å¤šè®¿é—®5æ¬¡/1s

ä¿®æ”¹nginx.confï¼ŒæŠŠburst=5 nodelayæ³¨é‡Šæ‰ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7f0d4083281f4bc68308cb03f75f053a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2150&h=1774&s=348261&e=png&b=010101) ä¸Šè¾¹çš„é…ç½®æ„å‘³ç€æ¯ç§’æœ€å¤šå¤„ç†5æ¬¡åŒæ ·ipçš„è¯·æ±‚ï¼Œæˆ‘ä»¬ä½¿ç”¨jmeterè®¾ç½®1ä¸ªçº¿ç¨‹å¾ªç¯10æ¬¡ï¼Œé—´éš”æ—¶é—´ä¸º100ms,æ•ˆæœå¦‚ä¸‹ï¼ˆ5æˆåŠŸ5å¤±è´¥ï¼‰ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/948f5582525a4e4ba7dfdb9b7ebacf73~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2834&h=1002&s=277682&e=png&b=3d4244) å¦‚æœæˆ‘ä»¬å°†é—´éš”æ—¶é—´æ”¹200çš„è¯ï¼Œæ˜¯éƒ½å¯ä»¥æˆåŠŸçš„ï¼Œå› ä¸ºä¸€ç§’æœ€å¤š5æ¬¡ç²¾ç¡®åˆ°æ¯«ç§’å…¶å®å°±æ˜¯æœ€å¤š200msä¸€æ¬¡,è€Œ200msä¸€æ¬¡æ­£å¥½æ²¡è¶…è¿‡æˆ‘ä»¬é…ç½®çš„ 5r/s çš„é€Ÿç‡ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2c0fe06a62b045108164463559e7db1d~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1614&h=380&s=77674&e=png&b=3d4244) è¿è¡Œjemeterå‘ç°é—´éš”200msè®¿é—®ä¸€æ¬¡çš„è¯·æ±‚éƒ½æˆåŠŸäº†ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cde886bec6754608af23eb37e5639329~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2856&h=936&s=279581&e=png&b=3d4244)

### 12.2.2ã€æ‰“å¼€burstå‚æ•°å¹¶è®¾ç½®æˆ5

ç°åœ¨æˆ‘ä»¬çš„é€Ÿç‡ä¸å˜è¿˜æ˜¯æœ€å¤š5æ¬¡ä¸€ç§’ï¼Œä½†æ˜¯è®¾ç½®burst=5ä»£è¡¨ç¼“å†²é˜Ÿåˆ—çš„é•¿åº¦ä¸º5ï¼Œnginxæ¯éš”200msï¼Œä»ç¼“å†²é˜Ÿåˆ—æ‹¿ä¸€ä¸ªè¿›è¡Œå¤„ç†ï¼Œé…ç½®å¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4aadf8d462a2448ca290deef74241577~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1642&h=1680&s=322918&e=png&b=010101)

ä¹‹åæˆ‘ä»¬é…ç½®çº¿ç¨‹æ•°é‡ä¸º15ï¼Œæ¯éš”100msæ‰ä¸€æ¬¡ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/07d5fbe951ae48768073ae49e5b753ac~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2842&h=1196&s=389751&e=png&b=3d4244) å¯ä»¥çœ‹åˆ°å…±è®¡6ä¸ªè¯·æ±‚è¢«å¤„ç†ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¢«nginxè¿›ç¨‹ç›´æ¥å¤„ç†ï¼Œä¹‹åå¾€burstå¡äº†5ä¸ªï¼ˆæ¯éš”200msæ‹¿ä¸€ä¸ªè¿›è¡Œå¤„ç†ï¼‰å‰©ä¸‹çš„éƒ½è¢«è¿”å›äº†520çŠ¶æ€ç ä»£è¡¨è¢«æ‹’ç»äº†ï¼Œæˆ‘ä»¬æ‰¾ä¸€ä¸ªï¼ˆ1-10è¿™ä¸ªï¼‰è¢«æ‹’çš„çœ‹çœ‹çŠ¶æ€ç ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d167f2adfc7244ce87ccc75daf97abd2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1382&h=790&s=100137&e=png&b=3a3f41)

### 12.2.3ã€æ‰“å¼€nodelay

æˆ‘ä»¬ä¸Šè¾¹è¯´è¿‡**æ‰“å¼€nodlayçš„è¯**ï¼Œä»£è¡¨æ”¾åˆ°bursté˜Ÿåˆ—çš„è¯·æ±‚ç›´æ¥å¤„ç† ï¼Œ**ä¸å†æŒ‰é€Ÿç‡ 200ms/æ¬¡ æ‹¿äº†**ï¼Œé…ç½®å¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d027c21be6784d1f89102cdd338c3de9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1606&h=1744&s=321984&e=png&b=000000) æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜æ˜¯é…ç½®15ä¸ªçº¿ç¨‹ï¼Œç„¶åæ¯ä¸ªçº¿ç¨‹é—´éš”100msè¯·æ±‚ä¸€æ¬¡ï¼Œçœ‹ä¸‹æ•ˆæœï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/206e98db135f45799f7b85b9ef78d536~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2834&h=1160&s=334900&e=png&b=3d4244) å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼šå¼€å¯nodelayåå“åº”æ—¶é—´10å‡ ç§’æ˜æ˜¾æ¯”ä¸å¼€å¯nodelayå¿«å¾ˆå¤šï¼Œä½†æ˜¯è¯·æ±‚æˆåŠŸçš„è¿˜æ˜¯6ä¸ªï¼Œå› ä¸ºå°±åƒæˆ‘ä»¬ä¸Šè¾¹è¯´çš„ngdelayè™½ç„¶ä¼šå³æ—¶å¤„ç†ï¼Œä½†æ˜¯é‡Šæ”¾å‘ä½æ˜¯200msé‡Šæ”¾ä¸€ä¸ª **`ï¼ˆä¹Ÿå°±æ˜¯è¯´å³æ—¶å¼€å¯äº†nodelay ä½†é‡Šæ”¾ä»¤ç‰Œçš„é€Ÿåº¦æ˜¯ä¸å˜çš„ï¼‰`** ï¼Œæ‰€ä»¥nodelayå‚æ•°æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰æé«˜è®¿é—®é€Ÿç‡ï¼Œè€Œä»…ä»…æ˜¯è®©å¤„äºbursté˜Ÿåˆ—çš„è¯·æ±‚ `â€è¢«å¿«é€Ÿå¤„ç†â€œ` ç½¢äº†ã€‚

12.3ã€nginxé™æµï¼ˆé’ˆå¯¹è¿æ¥æ•°é‡ï¼‰
--------------------

é’ˆå¯¹è¿æ¥æ•°é‡çš„é™æµå’Œé€Ÿç‡ä¸ä¸€æ ·ï¼Œå³ä½¿ä½ é€Ÿç‡æ˜¯1msä¸€æ¬¡ï¼Œåªè¦ä½ è¿æ¥æ•°é‡ä¸è¶…è¿‡è®¾ç½®çš„ï¼Œé‚£ä¹ˆä¹Ÿè®¿é—®æˆåŠŸã€‚å¦‚æœè¿æ¥æ•°è¶…è¿‡è®¾ç½®çš„å€¼å°†ä¼šè¯·æ±‚å¤±è´¥ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ä»–æ˜¯ ngx\_http\_limit\_conn\_moduleæ¨¡å—ä¸­çš„ï¼Œä¸è¦å’Œ é€Ÿç‡é™æµçš„ ngx\_http\_limit\_req\_moduleæ¨¡å—ææ··äº†ã€‚

é…ç½®å¦‚ä¸‹ï¼š

ini

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`http{     # é’ˆå¯¹ip  å¯¹è¯·æ±‚è¿æ¥æ•°é™æµ     ...     limit_conn_zone $binary_remote_addr zone=myConnLimit:10m;      ...          server{        ...        limit_conn myConnLimit 12;     } }`    

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/96779ae313654b8eac3a78fe2fa3aa90~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1708&h=1852&s=323494&e=png&b=000000) ç®€å•å¯¹ä»¥ä¸Šæ ‡é»„å¤„è¯´æ˜ä¸€ä¸‹ï¼Œ`limit_conn_zone $binary_remote_addr zone=myConnLimit:10m;` ä»£è¡¨çš„æ„æ€ æ˜¯ åŸºäºè¿æ¥æ•°é‡é™æµï¼Œé™æµçš„å¯¹è±¡æ˜¯ip åç§°æ˜¯myConnLimit å­˜å‚¨ç©ºé—´å¤§å°10mbï¼ˆå³å­˜æ”¾æŸipçš„è®¿é—®è®°å½•ï¼‰ï¼Œlimit\_conn myConnLimit 12;æ ‡è¯†è¯¥ipæœ€å¤§æ”¯æŒ12ä¸ªè¿æ¥è¶…è¿‡åˆ™è¿”å›503ï¼ˆè¢«é™æµåçŠ¶æ€ç é»˜è®¤æ˜¯503ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¿®æ”¹è¿”å›ç  åƒä¸Šè¾¹çš„ é’ˆå¯¹è¯·æ±‚é€Ÿç‡é™æµ ï¼Œè¿”å›ç å°±æ˜¯ æˆ‘ä¿®æ”¹çš„520ï¼‰ã€‚

ä½¿ç”¨jmeteræ20ä¸ªçº¿ç¨‹ï¼Œ0å»¶è¿Ÿï¼Œæ¼”ç¤ºä¸‹æ•ˆæœï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/661dcb8c3fff497497a2beb325ea2ab0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2844&h=1400&s=412439&e=png&b=3c4143) å¯ä»¥çœ‹åˆ°ç”±äºæˆ‘ä»¬é…ç½®çš„å¹¶å‘æ•°æ˜¯12ï¼Œæ‰€ä»¥20ä¸ªè¿æ¥ä¸­æœ‰8ä¸ªéƒ½è¢«é™äº†ã€‚è¿™ä¸ªç†è§£èµ·æ¥ä¼¼ä¹æ¯”é€Ÿç‡é™æµï¼ˆngx\_http\_limit\_req\_moduleï¼‰ç®€å•äº›æˆ‘ä»¬å°±ä¸è¿‡å¤šè§£é‡Šäº†ã€‚

13ã€httpsé…ç½®
==========

è¯´åˆ°httpså¤§å®¶åº”è¯¥å¹¶ä¸é™Œç”Ÿï¼Œæˆ‘è¿™é‡Œä¸å•°å—¦ä»‹ç»äº†ã€‚ä¸€èˆ¬æˆ‘ä»¬å®‰è£…çš„nginxæ¨¡å—éƒ½æ˜¯ä¸åŒ…å«sslæ¨¡å—çš„ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å®‰è£…ä¸‹ã€‚å®‰è£…å®Œä¹‹åæˆ‘ä»¬å†è¯´å¦‚ä½•é…ç½®httpsã€‚

13.1ã€https\_sslæ¨¡å—å®‰è£…
-------------------

é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ `nginx -V` (å¤§å†™) çœ‹ä¸‹æœ‰æ²¡æœ‰å®‰è£…https\_sslæ¨¡å—ï¼š

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c1fb912b90f41e8aff840eac5654ad1~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3558&h=376&s=115535&e=png&b=010101) å¯ä»¥çœ‹åˆ°æˆ‘å·²ç»å®‰è£…äº†,å®é™…ä¸Šæˆ‘å¯ä»¥ç›´æ¥ä½¿ç”¨https\_sslæ¨¡å—äº†ä½†æ˜¯ä¸ºäº†æ–‡ç« å®Œå–„æ€§ã€‚æˆ‘ä¸‹è¾¹è¯´ä¸€ä¸‹https\_sslæ¨¡å—çš„å®‰è£…æ­¥éª¤ï¼š

> æ³¨æ„ï¼šä¸‹è¾¹çš„https\_sslæ¨¡å—æ˜¯å®‰è£…åˆ°æˆ‘çš„æ—§ç‰ˆæœ¬1.23.0å»äº†ï¼Œè€Œæˆ‘å½“å‰ç”Ÿæ•ˆè¿è¡Œçš„nginxæ˜¯1.24.0 ï¼Œä½¿ç”¨`ps -ef | grep nginx` å‘½ä»¤å¯çœ‹å‡ºå½“å‰è¿è¡Œçš„nginxï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a658014a50ff4be4bc116c7cf1d1c8d9~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1716&h=218&s=67057&e=png&b=010101) ä¸‹è¾¹çš„å®‰è£…https\_sslä»…ä»…æ˜¯ä¸ºäº†å†…å®¹å…¨é¢ï¼Œ**è€Œä¸æ˜¯çœŸæ­£ä½¿ç”¨1.23.0ç‰ˆæœ¬çš„nginxæˆ–è€…1.23.0ç‰ˆæœ¬çš„https\_sslæ¨¡å—**ï¼ˆæœ¬æ–‡ä½¿ç”¨çš„ç‰ˆæœ¬éƒ½æ˜¯1.24.0 ï¼Œ1.23.0æ˜¯æˆ‘ä¹‹å‰çš„ä¸€ä¸ªnginxç‰ˆæœ¬ï¼‰ã€‚

æ²¡æœ‰sslæ¨¡å—æƒ…å†µä¸‹ï¼Œé¦–å…ˆæˆ‘ä»¬`è¿›å…¥nginxè§£å‹ç›®å½•`ï¼šæˆ‘çš„æ˜¯ /usr/local/nginx/nginx-1.23.0/ **æ€»ä¹‹å°±æ˜¯æ‰¾åˆ°ä½ çš„nginxè§£å‹ç›®å½•**) ï¼Œä¹‹ååœ¨è¯¥ç›®å½•æ‰§è¡Œå‘½ä»¤ `./configure --prefix=/usr/local/nginx --with-http_ssl_module` æ¥å®‰è£…sslæ¨¡å—ï¼Œå¦‚ä¸‹å›¾ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fd6de3c1306e4e89aca67d583f51bc50~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1702&h=516&s=136899&e=png&b=010101) å®‰è£…å¥½åï¼Œåœ¨/usr/local/nginx/nginx-1.23.0/ ç›®å½•ä¸­æ‰§è¡Œ `make` å‘½ä»¤ï¼Œé‡æ–°ç¼–è¯‘nginx,æ³¨æ„æ­¤å¤„æ— éœ€make installï¼ŒmakeæˆåŠŸåï¼Œæˆ‘ä»¬æ‰§è¡Œ `cp ./objs/nginx /usr/local/nginx/sbin/` å‘½ä»¤å°†ç¼–è¯‘åçš„æ–‡ä»¶è¦†ç›–åˆ° /usr/local/nginx/sbin/ï¼Œä¹‹åæ‰§è¡Œ `/usr/local/nginx/sbin/nginx -V` ï¼Œå¯çœ‹åˆ°sslæ¨¡å—å°±å®‰è£…æˆåŠŸäº†ã€‚æ“ä½œè®°å½•å›¾å¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63e8ba8d00a54a7fb129b4d006397444~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1600&h=1092&s=316783&e=png&b=010101)

13.2ã€åŸŸåè´­ä¹°&è§£æ&sslè¯ä¹¦ç”³è¯·ä¸éªŒè¯
-----------------------

è¦é…ç½®sslæœ€å¥½æ˜¯æœ‰ä¸ªåŸŸåï¼Œæ‰€ä»¥æˆ‘èŠ±ä¸€æ¯é…±é¦™æ‹¿é“çš„ğŸ’°ä¹°äº†ä¸€ä¸ªåŸŸåï¼ˆåœ¨ä¹°åŸŸåå‰éœ€è¦è¿›è¡ŒåŸŸåæ¨¡æ¿å®åï¼Œå…·ä½“æ“ä½œå»è…¾è®¯äº‘å®˜ç½‘çœ‹è¿™é‡Œä¸å•°å—¦äº†ï¼‰ï¼Œæˆ‘ä¹°çš„åŸŸåæ˜¯ï¼š **`hzznb-xzll.xyz`**

psï¼š å¦‚æœæˆ‘æ²¡è®°é”™çš„è¯è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ªåŸŸåï¼Œè™½ç„¶ä»–10å—é’±ä½†æ˜¯æˆ‘å¾ˆçæƒœä»–ğŸ˜„ğŸ˜„ï¼Œæ¥ä¸‹æ¥å¯ä»¥åœ¨æˆ‘çš„åŸŸåä¸­çœ‹åˆ°å·²ç»æˆåŠŸäº†ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/98e304262b96425281fa2e86de4a9961~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3448&h=1066&s=347574&e=png&b=e4ebf9) æœ‰åŸŸåäº†ï¼Œä¸‹ä¸€æ­¥å°±éœ€è¦é…ç½®DNSè§£æï¼Œè®©åˆ«äººé€šè¿‡å…¬ç½‘ä¹Ÿè®¿é—®åˆ°å‘€ï¼Œæ‰€ä»¥ç‚¹å‡»ä¸Šå›¾çš„ **è§£æ** æŒ‰é’®åï¼Œæ¥åˆ°ä¸‹è¾¹çš„é¡µé¢æ·»åŠ è§£æè®°å½•ï¼Œå¦‚ä¸‹ï¼šï¼ˆä¸»æœºè®°å½•wwwçš„ç»“æœæ˜¯ï¼š[www.hzznb-xzll.xyz](https://link.juejin.cn?target=http%3A%2F%2Fwww.hzznb-xzll.xyz "http://www.hzznb-xzll.xyz") ï¼Œ@çš„ç»“æœæ˜¯ hzznb-xzll.xyzï¼Œ \*çš„æ„æ€ä¸ºæ³›è§£æï¼Œå¯¹åº”çš„ç»“æœæ˜¯ xxx.hzznb-xzll.xyzï¼‰ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a0f2d211b5c4452da0831d377f1be81b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3472&h=896&s=230996&e=png&b=fff9f9) é…ç½®å¥½è§£æåï¼Œæˆ‘ä»¬å¼€å§‹ç”³è¯·ä¸€ä¸ªå…è´¹çš„sslè¯ä¹¦å¹¶å°†å…¶å’Œæˆ‘ä¸Šè¾¹çš„åŸŸåç»‘å®šï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a163ba2bd35488f82d3f4bf65b7c72e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3366&h=1708&s=454108&e=png&b=ffffff) æäº¤ç”³è¯·åï¼Œå› ä¸ºæˆ‘ä»¬é€‰æ‹©çš„æ‰‹åŠ¨DNSéªŒè¯ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æŒ‰ç…§äººå®¶çš„æç¤ºæ‰‹åŠ¨é…ç½®ï¼ˆè¿™ä¸ªæ“ä½œæ¯”è¾ƒé‡è¦ï¼Œä¸åšè¿™ä¸€æ­¥ï¼Œè¯ä¹¦éªŒè¯è‚¯å®šè¿‡ä¸å»ï¼Œæ‰€ä»¥å¿…é¡»åšå¹¶ä¸”åšå¯¹ï¼‰ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/54cade17f8ae4bac98ab76f024d36669~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3484&h=1754&s=812079&e=png&b=fef9f9) ä¹‹åæˆ‘ä»¬åœ¨æˆ‘çš„è¯ä¹¦çœ‹åˆ°å·²ç»å®ŒæˆéªŒè¯ï¼Œæ­¤æ—¶å°±å¯ä»¥ä¸‹è½½sslè¯ä¹¦ï¼Œç„¶åé…ç½®æˆ‘ä»¬çš„nginxäº†ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/978f4c76529843e3bfb542e0b7121c4b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3350&h=1228&s=266165&e=png&b=ffffff) å› ä¸ºæˆ‘ä»¬æ¥ä¸‹æ¥è¦é…ç½®åˆ°nginxåå‘ä»£ç†æœåŠ¡å™¨ï¼Œæ‰€ä»¥è¿™é‡Œé€‰æ‹©ä¸‹è½½nginxç±»å‹çš„sslè¯ä¹¦ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/acb37e756e7d4cf8b3b8b2a485f38d64~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3122&h=1612&s=420025&e=png&b=323232)

13.3ã€ä¸Šä¼ å¹¶é…ç½®nginxä»¥åŠæ¼”ç¤º
-------------------

ä¸‹è½½åˆ°æœ¬åœ°åæ˜¯ä¸ªzipæˆ‘ä»¬è§£å‹ä¹‹åä¼šçœ‹åˆ°é‡Œè¾¹æœ‰4ä¸ªæ–‡ä»¶åˆ†åˆ«æ˜¯ï¼š  

hzznb-xzll.xyz\_bundle.crt è¯ä¹¦æ–‡ä»¶  
hzznb-xzll.xyz\_bundle.pem è¯ä¹¦æ–‡ä»¶ï¼ˆå¯å¿½ç•¥è¯¥æ–‡ä»¶ï¼‰  
hzznb-xzll.xyz.key ç§é’¥æ–‡ä»¶  
hzznb-xzll.xyz.csr CSR æ–‡ä»¶ ï¼ˆCSR æ–‡ä»¶æ˜¯ç”³è¯·è¯ä¹¦æ—¶ç”±æ‚¨ä¸Šä¼ æˆ–ç³»ç»Ÿåœ¨çº¿ç”Ÿæˆçš„ï¼Œæä¾›ç»™ CA æœºæ„ã€‚å®‰è£…æ—¶å¯å¿½ç•¥è¯¥æ–‡ä»¶ã€‚ï¼‰

ä¹‹åæˆ‘ä»¬ä»…éœ€è¦æŠŠ hzznb-xzll.xyz.key å’Œ hzznb-xzll.xyz\_bundle.crt è¿™ä¿©è´§ä¸Šä¼ åˆ°æˆ‘æ–°å»ºçš„ certificateæ–‡ä»¶å¤¹ï¼š/usr/local/nginx/certificate/ ï¼Œæ“ä½œå¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/651a45d41f244c04b7fe4d8ee7f68c6c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2230&h=538&s=118121&e=png&b=010101) ä¸Šä¼ å®Œæˆï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/29eb6206483c42b98eceb87ccb8ccbe3~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1138&h=194&s=39891&e=png&b=010101) sslè¯ä¹¦å‡†å¤‡å¥½åï¼Œæˆ‘ä»¬éœ€è¦é…ç½®ä¸€ä¸ªhttpsçš„serverï¼ˆå¦‚ä¸‹é…ç½®ï¼š)  
ä¸‹è¾¹çš„æŒ‡ä»¤åç§°éƒ½æœ‰æ³¨é‡Šè¯´æ˜äº†å„ä¸ªæŒ‡ä»¤æ˜¯å¹²å•¥çš„ï¼Œæˆ‘ä¹Ÿå°±ä¸å•°å—¦äº†ï¼š

```ini
# --------------------HTTPS é…ç½®---------------------
    server {
        #SSL é»˜è®¤è®¿é—®ç«¯å£å·ä¸º 443
        listen 443 ssl; 
        #å¡«å†™ç»‘å®šè¯ä¹¦çš„åŸŸå 
        server_name www.hzznb-xzll.xyz hzznb-xzll.xyz; 
        #è¯·å¡«å†™è¯ä¹¦æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„
        ssl_certificate /usr/local/nginx/certificate/hzznb-xzll.xyz_bundle.crt; 
        #è¯·å¡«å†™ç§é’¥æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„
        ssl_certificate_key /usr/local/nginx/certificate/hzznb-xzll.xyz.key; 
        #åœæ­¢é€šä¿¡æ—¶ï¼ŒåŠ å¯†ä¼šè¯çš„æœ‰æ•ˆæœŸï¼Œåœ¨è¯¥æ—¶é—´æ®µå†…ä¸éœ€è¦é‡æ–°äº¤æ¢å¯†é’¥
        ssl_session_timeout 5m;
        #æœåŠ¡å™¨æ”¯æŒçš„TLSç‰ˆæœ¬
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; 
        #è¯·æŒ‰ç…§ä»¥ä¸‹å¥—ä»¶é…ç½®ï¼Œé…ç½®åŠ å¯†å¥—ä»¶ï¼Œå†™æ³•éµå¾ª openssl æ ‡å‡†ã€‚
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; 
        #å¼€å¯ç”±æœåŠ¡å™¨å†³å®šé‡‡ç”¨çš„å¯†ç å¥—ä»¶
        ssl_prefer_server_ciphers on;
    }    

```



å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸Šä¼ åˆ° /usr/local/nginx/certificate/ç›®å½•ä¸‹çš„ .crtå’Œ.keyæ–‡ä»¶è¢«ä½¿ç”¨åˆ°äº†ã€‚

ç°åœ¨æˆ‘ä»¬ä»…ä»…æ˜¯é…å¥½ä¸€ä¸ªhttpsç±»å‹çš„serverï¼Œå…‰ä¸€ä¸ªserveræ²¡æ³•è®¿é—®ä¹Ÿæ²¡æ„æ€ï¼Œæˆ‘ä»¬éœ€è¦è®©ç»™ä»–é…ç½®ä¸Šæ¸¸æœåŠ¡ä»¥åŠè·¯ç”±è§„åˆ™ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨æˆ‘ä»¬ä¸Šè¾¹çš„ 80ç«¯å£é‚£ä¸ªserverä¸­çš„locationé…ç½®ï¼Œç›´æ¥copyè¿‡æ¥ï¼Œ**https serverçš„é…ç½®** å¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1e5e659b5d504b73947c414db801d5a0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1580&h=2200&s=481554&e=png&b=010101) åˆ°è¿™é‡Œï¼Œå°±å¯ä»¥é€šè¿‡httpsæ–¹å¼è®¿é—®æˆ‘ä»¬çš„é¡µé¢å’Œæ¥å£äº†ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬çš„åè®®å’ŒåŸŸåæ¢äº†ï¼Œæ‰€ä»¥index\_page.htmlé‡Œè¾¹çš„æ¥å£åœ°å€ä¹Ÿå¾—å˜äº†ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/469223d90de34cb8b81e12098fbecef3~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2058&h=1856&s=417514&e=png&b=1f1f1f) ä¹‹åæˆ‘ä»¬å°†index\_page.htmlä¸Šä¼ åˆ°nginxçš„ /usr/local/nginx/test/static/ ç›®å½•ï¼Œå¹¶é‡å¯nginxï¼ˆnginx -s reloadï¼‰ ä¹‹ååœ¨æµè§ˆå™¨è®¿é—®è¯•è¯•ï¼Œ

> æ³¨æ„ï¼šæˆ‘æœ€å¼€å§‹åœ¨é…ç½®dnsè§£ææ—¶è®°å½•å€¼é…çš„æ˜¯å…¬ç½‘ip,ä½†æ˜¯æˆ‘å‘ç°å¥½åƒä¸å¥½ä½¿ï¼Œæ€»æ˜¯è¿æ¥å¤±è´¥ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b247a65f19ec4f4e8c2bfb6fcc4b2ea6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2596&h=1678&s=253672&e=png&b=fff8f8) ï¼Œåæ¥æ”¹æˆ å±€åŸŸç½‘ip 172.30.128.65 å‘ç°å¯è¡Œäº† ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b89c7e7cd4d14d919bf2c81ecaee5df3~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2884&h=836&s=187153&e=png&b=ffffff)

ä¿®æ”¹äº‘è§£ædnsè®°å½•å€¼ä¸º172.30.128.65åï¼Œè®¿é—®æ•ˆæœå¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/93b1857429404af3bc4fe460916175c2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3522&h=1382&s=589204&e=png&b=ffffff) ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a793e9c760a4cf58245c4279c998d75~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3548&h=1706&s=836338&e=png&b=ffffff) ä»ä¸Šè¾¹å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡httpsæ–¹å¼è®¿é—®å‰ç«¯é¡µé¢å’Œåå°æ¥å£äº†ã€‚

13.4ã€httpè·³è½¬https
----------------

ä¸€èˆ¬æƒ…å†µä¸‹ä¸ºäº†å®‰å…¨éƒ½ä¸ä½¿ç”¨httpæ–¹å¼è®¿é—®é¡µé¢oråå°æœåŠ¡ï¼Œä½†æ˜¯æœ‰çš„äººå°±æ˜¯å–œæ¬¢ä½¿ç”¨httpè®¿é—®æ€ä¹ˆåŠï¼Ÿå¥½è¯´ï¼Œæˆ‘ç»™httpåŠ ä¸ªè·³è½¬ï¼Œä½ è®¿é—® [xxx.com](https://link.juejin.cn?target=http%3A%2F%2Fxxx.com "http://xxx.com") æˆ‘ç»™ä½ è·³è½¬åˆ°[xxx.com](https://link.juejin.cn?target=https%3A%2F%2Fxxx.com "https://xxx.com"), æƒ³è¾¾åˆ°æ­¤æ•ˆæœéœ€è¦å…ˆä¿®æ”¹ä¸‹nginx.confæ–‡ä»¶ï¼š

```perl
server_name www.hzznb-xzll.xyz hzznb-xzll.xyz;
# é‡å®šå‘åˆ°ç›®æ ‡åœ°å€
return 301 https://$server_name$request_uri;

```



![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e36c7f2dee244e5789942330d911a1d1~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1488&h=1646&s=304188&e=png&b=010101) ä¹‹åé‡å¯nginxçœ‹ä¸‹æ¼”ç¤ºæ•ˆæœï¼š

é¦–å…ˆè¯·æ±‚ [www.hzznb-xzll.xyz/page/](https://link.juejin.cn?target=http%3A%2F%2Fwww.hzznb-xzll.xyz%2Fpage%2F "http://www.hzznb-xzll.xyz/page/") ä¼šè¿”å›é‡å®šå‘åœ°å€ï¼Œè®©ä½ é‡æ–°å®šå‘åˆ° [www.hzznb-xzll.xyz/page/](https://link.juejin.cn?target=https%3A%2F%2Fwww.hzznb-xzll.xyz%2Fpage%2F "https://www.hzznb-xzll.xyz/page/") ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3ff97704505f48ecba42fcf55f1e4544~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3460&h=1616&s=1289722&e=png&b=fbfbfb) è¯·æ±‚ï¼ˆè¿™ä¸€æ­¥æµè§ˆå™¨ä¼šè‡ªåŠ¨å‘èµ·è¯·æ±‚ï¼Œæ— éœ€æ‰‹åŠ¨ç‚¹å‡»æˆ–åˆ·æ–°å•¥çš„ï¼‰å®šå‘åçš„ç›®æ ‡åœ°å€ï¼š [www.hzznb-xzll.xyz/page/](https://link.juejin.cn?target=https%3A%2F%2Fwww.hzznb-xzll.xyz%2Fpage%2F "https://www.hzznb-xzll.xyz/page/") ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7dd23f4dc3634234b4385e17fd3e4bd0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3486&h=1732&s=876098&e=png&b=fbfbfb) å¯ä»¥çœ‹åˆ°httpæ–¹å¼çš„è¯·æ±‚è¢«æˆåŠŸé‡å®šå‘åˆ°äº†https server(443ç«¯å£å¯¹åº”çš„server)ã€‚

14ã€å‹ç¼©
=====

å‹ç¼©åŠŸèƒ½æ¯”è¾ƒå®ç”¨å°¤å…¶æ˜¯å¤„ç†ä¸€äº›å¤§æ–‡ä»¶æ—¶ï¼Œè€ŒgzipÂ æ˜¯è§„å®šçš„ä¸‰ç§æ ‡å‡† HTTPÂ å‹ç¼©æ ¼å¼ä¹‹ä¸€ã€‚ç›®å‰ç»å¤§å¤šæ•°çš„ç½‘ç«™éƒ½åœ¨ä½¿ç”¨ gzipÂ ä¼ è¾“ HTMLÂ ã€CSSÂ ã€ JavaScriptÂ ç­‰èµ„æºæ–‡ä»¶ã€‚éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ¯ä¸ªæµè§ˆå™¨éƒ½æ”¯æŒ gzipÂ å‹ç¼©ï¼Œå¦‚ä½•çŸ¥é“å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰æ˜¯å¦æ”¯æŒ å‹ç¼©Â å‘¢ï¼Ÿ å¯ä»¥é€šè¿‡è§‚å¯Ÿ æŸè¯·æ±‚å¤´ä¸­çš„ Accept-EncodingÂ æ¥è§‚å¯Ÿæ˜¯å¦æ”¯æŒå‹ç¼©ï¼Œå¦å¤–åªæœ‰å®¢æˆ·ç«¯æ”¯æŒä¹Ÿä¸é¡¶äº‹ï¼ŒæœåŠ¡ç«¯å¾—è¿”å›gzipæ ¼å¼çš„æ–‡ä»¶å‘€ï¼Œé‚£ä¹ˆè¿™ä»¶äº‹nginxå¯ä»¥å¸®æˆ‘ä»¬åšï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ NginxÂ çš„é…ç½®æ¥è®©æœåŠ¡ç«¯æ”¯æŒ gzipã€‚æœåŠ¡ç«¯è¿”å›å‹ç¼©æ–‡ä»¶åæµè§ˆå™¨è¿›è¡Œè§£å‹ç¼©ä»è€Œå±•ç¤ºæ­£å¸¸å†…å®¹ã€‚

14.1ã€å‹ç¼©å‰
--------

é¦–å…ˆåº”è¯¥æ˜ç¡®çš„æ˜¯æˆ‘å½“å‰æ˜¯æ²¡å¼€å¯å‹ç¼©çš„ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/77321f75b8e04d72bb2740eb3e8b8dca~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2450&h=1244&s=169679&e=png&b=000000)

å…¶æ¬¡ä¸ºäº†æ–¹ä¾¿çœ‹å‡ºæ•ˆæœï¼Œæˆ‘ä»¬å…ˆå°†ä¹‹å‰é‚£ä¸ªindex\_page.htmlæ–‡ä»¶åŠ ç‚¹å›¾ç‰‡ï¼ŒåŠ ç‚¹æ–‡å­—ç»™ä»–çš„æ–‡ä»¶å¤§å°å¼„å¤§ç‚¹ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5453159a8ab14b3ab35bc55aa751a388~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=2358&h=1770&s=385432&e=png&b=000000) è¿™é‡Œæ— éœ€é‡å¯nginxï¼Œçœ‹ä¸‹**æ²¡å¼€å¯å‹ç¼©** æ—¶å€™çš„æ•ˆæœï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f57509719384a728c1a61ab87600786~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3470&h=1664&s=2868882&e=png&b=fbf9f9) ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a16001d9150b4ad3a37db56f1a7e21e5~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3520&h=1728&s=3000578&e=png&b=f7f5f5)

14.2ã€å‹ç¼©å
--------

æƒ³è¦å‹ç¼©å°±å¾—é…ç½®nginx,æˆ‘ä»¬ä¿®æ”¹nginx.confæ–‡ä»¶ï¼Œåœ¨httpæŒ‡ä»¤å—æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```shell
http {
    # å¼€å¯/å…³é—­ å‹ç¼©æœºåˆ¶
    gzip on;
    # æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹© æ˜¯å¦å¼€å¯å‹ç¼©æœºåˆ¶
    gzip_types text/plain application/javascript text/css application/xml text/javascript image/jpeg image/jpg image/gif image/png  application/json;
    # è®¾ç½®å‹ç¼©çº§åˆ«ï¼Œä¸€å…±9ä¸ªçº§åˆ«  1-9   ï¼Œè¶Šé«˜èµ„æºæ¶ˆè€—è¶Šå¤§ è¶Šè€—æ—¶ï¼Œä½†å‹ç¼©æ•ˆæœè¶Šå¥½ï¼Œ
    gzip_comp_level 9;
    # è®¾ç½®æ˜¯å¦æºå¸¦Vary:Accept-Encoding çš„å“åº”å¤´
    gzip_vary on;
    # å¤„ç†å‹ç¼©è¯·æ±‚çš„ ç¼“å†²åŒºæ•°é‡å’Œå¤§å°
    gzip_buffers 32 64k;
    # å¯¹äºä¸æ”¯æŒå‹ç¼©åŠŸèƒ½çš„å®¢æˆ·ç«¯è¯·æ±‚ ä¸å¼€å¯å‹ç¼©æœºåˆ¶
    gzip_disable "MSIE [1-6]\."; # æ¯”å¦‚ä½ç‰ˆæœ¬çš„IEæµè§ˆå™¨ä¸æ”¯æŒå‹ç¼©
    # è®¾ç½®å‹ç¼©åŠŸèƒ½æ‰€æ”¯æŒçš„HTTPæœ€ä½ç‰ˆæœ¬
    gzip_http_version 1.1;
    # è®¾ç½®è§¦å‘å‹ç¼©çš„æœ€å°é˜ˆå€¼
    gzip_min_length 2k;
    # off/any/expired/no-cache/no-store/private/no_last_modified/no_etag/auth æ ¹æ®ä¸åŒé…ç½®å¯¹åç«¯æœåŠ¡å™¨çš„å“åº”ç»“æœè¿›è¡Œå‹ç¼©
    gzip_proxied any;
} 

```



å‡ ä¸ªæŒ‡ä»¤çš„ä½œç”¨åœ¨æ³¨é‡Šä¸­å†™æ˜äº†è¿™é‡Œä¸å†è¿‡å¤šè§£é‡Šã€‚æ¥ä¸‹æ¥æˆ‘ä»¬é‡å¯nginxï¼Œç„¶åçœ‹ä¸‹å‹ç¼©å‰åçš„æ•ˆæœï¼š

htmlæ–‡ä»¶å‹ç¼©ï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/77eb77074edc4c6ab170d2cf3915496f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3478&h=1690&s=1190643&e=png&b=fefefe) æ¥å£å“åº”å‹ç¼©ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/03f12df6d0a947cb8eb9a63b8032a8d6~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3512&h=1640&s=3327894&e=png&b=f9f7f7) å¯ä»¥çœ‹åˆ°ä¸ç®¡æ˜¯htmlè¿˜æ˜¯æ¥å£å“åº”æ•°æ®ï¼Œ å‹ç¼©åçš„ä½“ç§¯å˜å¾—éå¸¸å°äº†ï¼Œå‹ç¼©çš„æ•ˆæœè¿˜æ˜¯ä¸é”™çš„ï¼Œä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯å‹ç¼©åè™½ç„¶ä½“ç§¯å˜å°äº†ï¼Œä½†æ˜¯å“åº”çš„æ—¶é—´ä¼šå˜é•¿ï¼Œå› ä¸ºå‹ç¼©/è§£å‹ä¹Ÿéœ€è¦æ—¶é—´å‘€ï¼å‹ç¼©åŠŸèƒ½ä¼¼ä¹æœ‰ç‚¹ï¼š**ç”¨æ—¶é—´æ¢ç©ºé—´çš„æ„Ÿè§‰ï¼**ï¼Œå½“ç„¶å‹ç¼©çº§åˆ«å¯ä»¥è°ƒçš„ï¼Œä½ å¯ä»¥é€‰æ‹©è¾ƒä½çº§åˆ«çš„å‹ç¼©ï¼Œè¿™æ ·æ—¢èƒ½å®ç°å‹ç¼©åŠŸèƒ½ä½¿å¾—æ•°æ®åŒ…ä½“ç§¯é™ä¸‹æ¥ï¼ŒåŒæ—¶å‹ç¼©æ—¶é—´ä¹Ÿä¼šç¼©çŸ­æ˜¯æ¯”è¾ƒæŠ˜ä¸­çš„ä¸€ç§æ–¹æ¡ˆï¼ˆæˆ‘åœ¨æ¼”ç¤ºæ—¶ä¸ºäº†æ•ˆæœï¼Œé…ç½®çš„å‹ç¼©çº§åˆ«æ˜¯9 ï¼Œä¸€å…±9ä¸ªçº§åˆ«ï¼Œ 9æ˜¯æœ€é«˜çº§åˆ«çš„å‹ç¼©ç­‰çº§ï¼‰ã€‚

15ã€å…¶ä»–ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„æŒ‡ä»¤ä¸è¯´æ˜
=================

å…³äºnginxçš„æŒ‡ä»¤å…¶å®å¤ªå¤šäº†ï¼Œæœ‰äº›å¸¸ç”¨çš„æŒ‡ä»¤ä¸è¯´ä¸€ä¸‹çš„è¯ï¼Œæœ‰æ—¶å€™é‡è§äº†ä¸æ‡‚å•¥æ„æ€ï¼Œæ‰€ä»¥è¿™é‡Œè¯´ä¸€ä¸‹nginxå‡ ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„æŒ‡ä»¤ï¼ˆä¸Šè¾¹nginx.confæ–‡ä»¶è§£è¯» ä»¥åŠæŸäº›å°èŠ‚ä¸­å·²ç»è¯´äº†å¾ˆå¤šæŒ‡ä»¤äº†ï¼Œè¿™é‡Œä¹Ÿä¸ç®¡é‡ä¸é‡å¤å§ï¼Œè¯´æ˜å‡ ä¸ªæˆ‘è§‰å¾—æœ‰å¿…è¦è®²çš„å‡ ä¸ªï¼‰

15.1ã€rewrite
------------

rewriteæŒ‡ä»¤æ˜¯é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ¥æ”¹å˜URIã€‚å¯ä»¥åŒæ—¶å­˜åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡ä»¤ã€‚éœ€è¦æŒ‰ç…§é¡ºåºä¾æ¬¡å¯¹URLè¿›è¡ŒåŒ¹é…å’Œå¤„ç†ï¼Œå¸¸ç”¨äºé‡å®šå‘åŠŸèƒ½ã€‚

rewriteè¯­æ³•å¦‚ä¸‹ï¼š

| è¯­æ³•: | `rewriteÂ æ­£åˆ™è¡¨è¾¾å¼Â è¦æ›¿æ¢çš„å†…å®¹Â [flag];` |
| --- | --- |
| é»˜è®¤: | â€” |
| ä½œç”¨åŸŸ: | `server`,Â `location`,Â `if` |

å…¶ä¸­flagæœ‰å¦‚ä¸‹å‡ ä¸ªå€¼ï¼š  

**last:** Â æœ¬æ¡è§„åˆ™åŒ¹é…å®Œæˆåï¼Œç»§ç»­å‘ä¸‹åŒ¹é…æ–°çš„location URI è§„åˆ™ã€‚  
**break:** Â æœ¬æ¡è§„åˆ™åŒ¹é…å®Œæˆå³ç»ˆæ­¢ï¼Œä¸å†åŒ¹é…åé¢çš„ä»»ä½•è§„åˆ™ã€‚  
**redirect:** Â è¿”å›302ä¸´æ—¶é‡å®šå‘ï¼Œæµè§ˆå™¨åœ°å€ä¼šæ˜¾ç¤ºè·³è½¬æ–°çš„URLåœ°å€ã€‚  
**permanent:** Â è¿”å›301æ°¸ä¹…é‡å®šå‘ã€‚æµè§ˆå™¨åœ°å€ä¼šæ˜¾ç¤ºè·³è½¬æ–°çš„URLåœ°å€ã€‚

ä¸‹è¾¹æˆ‘ä»¬æ¼”ç¤ºä¸‹å››ç§é‡å†™çš„æ•ˆæœ é¦–å…ˆä¿®æ”¹nginx.confæ–‡ä»¶ï¼š

```ini
  server {
      listen 80 default;
      charset utf-8;
      server_name www.hzznb-xzll.xyz hzznb-xzll.xyz;

      # ä¸´æ—¶ï¼ˆredirectï¼‰é‡å®šå‘é…ç½®
      location /temp_redir {
          rewrite ^/(.*) https://www.baidu.com redirect;
      }
      # æ°¸ä¹…é‡å®šå‘ï¼ˆpermanentï¼‰é…ç½®
      location /forever_redir {

          rewrite ^/(.*) https://www.baidu.com permanent;
      }

      # rewrite lasté…ç½®
      location /1 {
        rewrite /1/(.*) /2/$1 last;
      }
      location /2 {
        rewrite /2/(.*) /3/$1 last;
      }
      location /3 {
        alias  '/usr/local/nginx/test/static/';
        index location_last_test.html;
      }
    }

```



![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/55494f7625da405192cdd9b1abdf29ce~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1820&h=1228&s=257959&e=png&b=000000)

**lasté…ç½®:** å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®šä¹‰ è®¿é—® [hzznb-xzll.xyz/1/](https://link.juejin.cn?target=http%3A%2F%2Fhzznb-xzll.xyz%2F1%2F "http://hzznb-xzll.xyz/1/") çš„è¯·æ±‚è¢«æ›¿æ¢ä¸º [hzznb-xzll.xyz/2/](https://link.juejin.cn?target=http%3A%2F%2Fhzznb-xzll.xyz%2F2%2F "http://hzznb-xzll.xyz/2/") ä¹‹åå†è¢«æ›¿æ¢ä¸º [hzznb-xzll.xyz/3/](https://link.juejin.cn?target=http%3A%2F%2Fhzznb-xzll.xyz%2F3%2F "http://hzznb-xzll.xyz/3/") æœ€åæ‰¾åˆ°/usr/local/nginx/test/static/location\_last\_test.html è¿™ä¸ªæ–‡ä»¶å¹¶è¿”å›ã€‚  
**redirecté…ç½®ï¼š** å½“è®¿é—® [hzznb-xzll.xyz/temp\_redir/](https://link.juejin.cn?target=http%3A%2F%2Fhzznb-xzll.xyz%2Ftemp_redir%2F "http://hzznb-xzll.xyz/temp_redir/") è¿™ä¸ªè¯·æ±‚ä¼šä¸´æ—¶ï¼ˆ302ï¼‰é‡å®šå‘åˆ°ç™¾åº¦é¡µé¢  
**permanenté…ç½®ï¼š** å½“è®¿é—® [hzznb-xzll.xyz/forever\_redâ€¦](https://link.juejin.cn?target=http%3A%2F%2Fhzznb-xzll.xyz%2Fforever_redir%2F "http://hzznb-xzll.xyz/forever_redir/") è¿™ä¸ªè¯·æ±‚ä¼šæ°¸ä¹…ï¼ˆ301ï¼‰é‡å®šå‘åˆ°ç™¾åº¦é¡µé¢

æ•ˆæœå¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/27939667cad34a9583d79f8d2f37eff0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3254&h=1778&s=1105567&e=png&b=fcfcfc)

15.2ã€if
-------

è¯¥æŒ‡ä»¤ç”¨äºæ¡ä»¶åˆ¤æ–­ï¼Œå¹¶ä¸”æ ¹æ®æ¡ä»¶åˆ¤æ–­ç»“æœæ¥é€‰æ‹©ä¸åŒçš„é…ç½®ï¼Œå…¶ä½œç”¨äºä¸ºï¼šserver/location å—ã€‚è¿™ä¸ªæŒ‡ä»¤æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºç¼–ç¨‹ä¸­ifè¯­å¥éƒ½æ˜¯éå¸¸é«˜é¢‘ä½¿ç”¨çš„ï¼Œä½†æ˜¯é‡Œè¾¹æ€ä¹ˆå†™ å°±å¾—è¯´è¯´nginxçš„å…¨å±€å˜é‡äº†ï¼Œå› ä¸ºæˆ‘ä»¬å¾ˆå¤šæ—¶å€™ï¼Œéƒ½æ˜¯åœ¨å¯¹ æ¯”å¦‚ï¼šurl å‚æ•° ip åŸŸåç­‰ç­‰åšæ¯”å¯¹æˆ–è€…åˆ¤æ–­ï¼ˆä¸€èˆ¬éƒ½ä½¿ç”¨æ­£åˆ™çš„æ–¹å¼ï¼‰,è€Œè¿™äº›éƒ½åœ¨nginxå…¨å±€å˜é‡ä¸­å¯ä»¥æ‹¿åˆ°ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªifåˆ¤æ–­å°±ç”¨åˆ°äº†å…¨å±€å˜é‡ï¼š

```bash
# æŒ‡å®š username å‚æ•°ä¸­åªè¦æœ‰å­—æ¯ å°±ä¸èµ°nginxç¼“å­˜
if ($arg_username ~ [a-z]) {
   set $cache_name "no cache";
}

```

æ­£åˆ™è¡¨è¾¾å¼å°±ä¸å¤šè¯´äº†ï¼Œå…·ä½“ä½¿ç”¨æ—¶æŸ¥ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¸‹è¾¹åˆ—ä¸€ä¸‹nginxçš„å…¨å±€å˜é‡ï¼š

15.3ã€nginxå…¨å±€å˜é‡
--------------

| å˜é‡ | è§£é‡Š |
| --- | --- |
| $time\_local | æœ¬åœ°æ—¶é—´ |
| $time\_iso8601 | ISO 8601 æ—¶é—´æ ¼å¼ |
| $arg\_name | è¯·æ±‚ä¸­çš„çš„å‚æ•°åï¼Œå³â€œ?â€åé¢çš„arg\_name=arg\_valueå½¢å¼çš„arg\_name |
| $args | ä¸$query\_stringç›¸åŒ ç­‰äºURLå½“ä¸­çš„å‚æ•°(GETè¯·æ±‚æ—¶)ï¼Œå¦‚a=1&b=2 |
| $document\_uri | ä¸uriç›¸åŒè¿™ä¸ªå˜é‡æŒ‡å½“å‰çš„è¯·æ±‚URIï¼Œä¸åŒ…æ‹¬ä»»ä½•å‚æ•°(è§uriç›¸åŒ è¿™ä¸ªå˜é‡æŒ‡å½“å‰çš„è¯·æ±‚URIï¼Œä¸åŒ…æ‹¬ä»»ä½•å‚æ•°(è§uriç›¸åŒè¿™ä¸ªå˜é‡æŒ‡å½“å‰çš„è¯·æ±‚URIï¼Œä¸åŒ…æ‹¬ä»»ä½•å‚æ•°(è§args) |
| $request\_uri | åŒ…å«è¯·æ±‚å‚æ•°çš„åŸå§‹URIï¼Œä¸åŒ…å«ä¸»æœºåï¼Œå¦‚ï¼š/aaa/bbb.html?a=1&b=2 |
| $is\_args | å¦‚æœURLåŒ…å«å‚æ•°åˆ™ä¸ºï¼Ÿï¼Œå¦åˆ™ä¸ºç©ºå­—ç¬¦ä¸² |
| $query\_string | ä¸$argsç›¸åŒ ç­‰äºURLå½“ä¸­çš„å‚æ•°(GETè¯·æ±‚æ—¶)ï¼Œå¦‚a=1&b=2 |
| $uri | å½“å‰è¯·æ±‚çš„URI,ä¸åŒ…å«ä»»ä½•å‚æ•° |
| $remote\_addr | è·å–å®¢æˆ·ç«¯ip |
| $binary\_remote\_addr | å®¢æˆ·ç«¯ipï¼ˆäºŒè¿›åˆ¶) |
| $remote\_port | å®¢æˆ·ç«¯port |
| $remote\_user | ç”¨äºåŸºæœ¬éªŒè¯çš„ç”¨æˆ·åã€‚ |
| $host | è¯·æ±‚ä¸»æœºå¤´å­—æ®µï¼Œå¦åˆ™ä¸ºæœåŠ¡å™¨åç§°ï¼Œå¦‚:[www.hzznb-xzll.xyz](https://link.juejin.cn?target=https%3A%2F%2Fwww.hzznb-xzll.xyz "https://www.hzznb-xzll.xyz") |
| $proxy\_host | proxy\_pass æŒ‡ä»¤è®¾ç½®çš„åç«¯æœåŠ¡å™¨çš„åŸŸåï¼ˆæˆ–è€…IPåœ°å€ï¼‰ |
| $proxy\_port | proxy\_pass æŒ‡ä»¤è®¾ç½®çš„åç«¯æœåŠ¡å™¨çš„ç›‘å¬ç«¯å£ã€‚ |
| $http\_host | æ˜¯hostå’Œhost å’Œ hostå’Œserver\_port ä¸¤ä¸ªå˜é‡çš„ç»“åˆ |
| $request | ç”¨æˆ·è¯·æ±‚ä¿¡æ¯ï¼Œå¦‚ï¼šGET ?a=1&b=2 HTTP/1.1 |
| $request\_time | è¯·æ±‚æ‰€ç”¨æ—¶é—´ï¼Œå•ä½æ¯«ç§’ |
| $request\_method | è¯·æ±‚çš„æ–¹æ³• æ¯”å¦‚ get post put delete update ç­‰ |
| $request\_filename | å½“å‰è¯·æ±‚çš„æ–‡ä»¶çš„è·¯å¾„åï¼Œç”±rootæˆ–aliaså’ŒURI requestç»„åˆè€Œæˆ,å¦‚ï¼š/aaa/bbb.html |
| $status | è¯·æ±‚çš„å“åº”çŠ¶æ€ç ,å¦‚ï¼š200 |
| $body\_bytes\_sent | å“åº”æ—¶é€å‡ºçš„bodyå­—èŠ‚æ•°æ•°é‡ã€‚å³ä½¿è¿æ¥ä¸­æ–­ï¼Œè¿™ä¸ªæ•°æ®ä¹Ÿæ˜¯ç²¾ç¡®çš„,å¦‚ï¼š40ï¼Œä¼ è¾“ç»™å®¢æˆ·ç«¯çš„å­—èŠ‚æ•°ï¼Œå“åº”å¤´ä¸è®¡ç®—åœ¨å†…ï¼›è¿™ä¸ªå˜é‡å’ŒApacheçš„mod\_log\_configæ¨¡å—ä¸­çš„â€œ%Bâ€å‚æ•°ä¿æŒå…¼å®¹ |
| $content\_length | ç­‰äºè¯·æ±‚è¡Œçš„â€œContent\_Lengthâ€çš„å€¼ |
| $content\_type | ç­‰äºè¯·æ±‚è¡Œçš„â€œContent\_Typeâ€çš„å€¼ |
| $http\_referer | å¼•ç”¨åœ°å€ |
| $http\_user\_agent | å®¢æˆ·ç«¯agentä¿¡æ¯,å¦‚ï¼šMozilla/5.0 (Macintosh; Intel Mac OS X 10\_15\_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36 è¿™ä¸ªå¯ä»¥ç”¨æ¥åŒºåˆ†æ‰‹æœºç«¯è¿˜æ˜¯pcç«¯ |
| $document\_root | é’ˆå¯¹å½“å‰è¯·æ±‚çš„æ ¹è·¯å¾„è®¾ç½®å€¼ |
| $hostname | ä¸»æœºåç§° |
| $http\_cookie | å®¢æˆ·ç«¯cookieä¿¡æ¯ |
| $cookie\_COOKIE | cookie COOKIEå˜é‡çš„å€¼ |
| $limit\_rate | è¿™ä¸ªå˜é‡å¯ä»¥é™åˆ¶è¿æ¥é€Ÿç‡ï¼Œ0è¡¨ç¤ºä¸é™é€Ÿ |
| $request\_body | è®°å½•POSTè¿‡æ¥çš„æ•°æ®ä¿¡æ¯ |
| $request\_body\_file | å®¢æˆ·ç«¯è¯·æ±‚ä¸»ä½“ä¿¡æ¯çš„ä¸´æ—¶æ–‡ä»¶å |
| $scheme | HTTPæ–¹æ³•ï¼ˆå¦‚httpï¼Œhttpsï¼‰ |
| $request\_completion | å¦‚æœè¯·æ±‚ç»“æŸï¼Œè®¾ç½®ä¸ºOK. å½“è¯·æ±‚æœªç»“æŸæˆ–å¦‚æœè¯¥è¯·æ±‚ä¸æ˜¯è¯·æ±‚é“¾ä¸²çš„æœ€åä¸€ä¸ªæ—¶ï¼Œä¸ºç©º(Empty)ï¼Œå¦‚ï¼šOK |
| $server\_protocol | è¯·æ±‚ä½¿ç”¨çš„åè®®ï¼Œé€šå¸¸æ˜¯HTTP/1.0æˆ–HTTP/1.1ï¼Œå¦‚ï¼šHTTP/1.1 |
| $server\_addr | æœåŠ¡å™¨IPåœ°å€ï¼Œåœ¨å®Œæˆä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨åå¯ä»¥ç¡®å®šè¿™ä¸ªå€¼ |
| $server\_name | å“åº”è¯·æ±‚çš„æœåŠ¡å™¨åç§° |
| $server\_port | è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨çš„ç«¯å£å·ï¼Œå¦‚ï¼š80 |
| $connection | è¿æ¥åºåˆ—å· |
| $connection\_requests | å½“å‰é€šè¿‡è¿æ¥å‘å‡ºçš„è¯·æ±‚æ•° |
| $nginx\_version | nginxç‰ˆæœ¬ |
| $pid | å·¥ä½œè¿›ç¨‹çš„PID |
| $pipe | å¦‚æœè¯·æ±‚æ¥è‡ªç®¡é“é€šä¿¡ï¼Œå€¼ä¸ºâ€œpâ€ï¼Œå¦åˆ™ä¸ºâ€œ.â€ |
| $proxy\_protocol\_addr | è·å–ä»£ç†è®¿é—®æœåŠ¡å™¨çš„å®¢æˆ·ç«¯åœ°å€ï¼Œå¦‚æœæ˜¯ç›´æ¥è®¿é—®ï¼Œè¯¥å€¼ä¸ºç©ºå­—ç¬¦ä¸² |
| $realpath\_root | å¯¹åº”äºå½“å‰è¯·æ±‚çš„æ ¹ç›®å½•æˆ–åˆ«åå€¼çš„ç»å¯¹è·¯å¾„åï¼Œæ‰€æœ‰ç¬¦å·è¿æ¥éƒ½è§£æä¸ºçœŸå®è·¯å¾„ã€‚ |

å¯ä»¥çœ‹åˆ°å…¨å±€å˜é‡æ¯”è¾ƒå¤šï¼Œä½†æ˜¯æ²¡å…³ç³»åœ¨ä½¿ç”¨æ—¶å†å»è¯¦æŸ¥å°±å¥½äº†ã€‚

15.4ã€auto\_index
----------------

ä¸€èˆ¬ç”¨äºå¿«é€Ÿæ­å»ºé™æ€èµ„æºç½‘ç«™ï¼Œæ¯”å¦‚æˆ‘è¦ç»™è‡ªå·±æä¸ªä¹¦ç±ç½‘ç«™é‡Œè¾¹æ”¾äº›å¥½ä¹¦ï¼Œä»¥ä¾¿éœ€è¦æ—¶æŸ¥çœ‹é˜…è¯»ï¼Œé¦–å…ˆå»ºä¸€ä¸ªbookæ–‡ä»¶å¤¹å¹¶å¾€é‡Œæ”¾å‡ æœ¬ä¹¦ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/528eb4768338439dbbb70db277f4e070~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1574&h=276&s=103591&e=png&b=010101)

ä¹‹åæˆ‘ä»¬é…ç½®nginxï¼Œ ä½¿å¾—è®¿é—® [hzznb-xzll.xyz/book/](https://link.juejin.cn?target=http%3A%2F%2Fhzznb-xzll.xyz%2Fbook%2F "http://hzznb-xzll.xyz/book/") æ—¶,è¿”å› /usr/local/nginx/test/book/ç›®å½•ä¸‹çš„ä¹¦ç±ï¼Œé…ç½®å¦‚ä¸‹ï¼š

vbnet

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

      `location /book/ {           root /usr/local/nginx/test;           autoindex on; # æ‰“å¼€ autoindexï¼Œï¼Œå¯é€‰å‚æ•°æœ‰ on | off           autoindex_format html; # ä»¥htmlçš„æ–¹å¼è¿›è¡Œæ ¼å¼åŒ–ï¼Œå¯é€‰å‚æ•°æœ‰ html | json | xml           autoindex_exact_size on; # ä¿®æ”¹ä¸ºoffï¼Œä¼šä»¥KBã€MBã€GBæ˜¾ç¤ºæ–‡ä»¶å¤§å°ï¼Œé»˜è®¤ä¸ºonä»¥bytesæ˜¾ç¤ºå‡ºâ½‚ä»¶çš„ç¡®åˆ‡â¼¤â¼©           autoindex_localtime off; # æ˜¾ç¤ºâ½‚ä»¶æ—¶é—´ GMTæ ¼å¼       }`

![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b44a714dcb3c43c78b3e95c5fe80b135~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1616&h=828&s=120547&e=png&b=010101)

é‡å¯nginxå¹¶åœ¨æµè§ˆå™¨è¾“å…¥ [hzznb-xzll.xyz/book/](https://link.juejin.cn?target=http%3A%2F%2Fhzznb-xzll.xyz%2Fbook%2F "http://hzznb-xzll.xyz/book/") ï¼ˆæ³¨æ„bookåè¾¹çš„æ–œçº¿ / ä¸èƒ½å»æ‰ï¼Œå¦åˆ™404äº†ï¼Œå…·ä½“åŸå› æˆ‘ä»¬ä¸‹è¾¹é©¬ä¸Šä¼šè¯´ï¼‰ï¼Œçœ‹ä¸‹æ•ˆæœï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8c6f9d133db64414ac7191663fcba115~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3530&h=1352&s=435859&e=png&b=ffffff)

15.5ã€root&alias
---------------

rootå’Œaliasè¿™ä¿©è´§ä¸€èˆ¬éƒ½æ˜¯ç”¨äºæŒ‡å®šé™æ€èµ„æºç›®å½•ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰æŒºå¤§åŒºåˆ«çš„ï¼Œè™½ç„¶è¿™æ˜¯ä¸ªå°çŸ¥è¯†ç‚¹ä½†æ˜¯å¦‚æœä½ ä¸æ¸…æ¥šè§„åˆ™ï¼Œå¾ˆå®¹æ˜“èµ°å¼¯è·¯ï¼Œæ‰€ä»¥è¿™é‡Œé˜æ˜å¹¶æ¼”ç¤ºè¿™ä¿©çš„åŒºåˆ«ã€‚

### 15.5.1ã€root

è¯´å…ˆè¯´rootï¼š

| è¯­æ³•: | `rootÂ path;` |
| --- | --- |
| é»˜è®¤å€¼: | `root html;` |
| ä½œç”¨åŸŸ: | `http`,Â `server`,Â `location`,Â `if in location` |

ä¸ºè¯·æ±‚è®¾ç½®æ ¹ç›®å½•ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼š

bash

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`location /static/ {     root /usr/local/nginx/test; }`

æ­¤æ—¶ï¼Œå½“ä½ è¯·æ±‚ [www.hzznb-xzll.xyz/static/imagâ€¦](https://link.juejin.cn?target=http%3A%2F%2Fwww.hzznb-xzll.xyz%2Fstatic%2Fimage2.jpg "http://www.hzznb-xzll.xyz/static/image2.jpg") æ—¶ï¼Œ/usr/local/nginx/test/static/image2.jpg æ–‡ä»¶å°†è¢«ä½œä¸ºå“åº”å†…å®¹å“åº”ç»™å®¢æˆ·ç«¯,ä¹Ÿå°±æ˜¯è¯´ :  
**rootæŒ‡ä»¤ä¼š å°† /static/ æ‹¼æ¥åˆ° /usr/local/nginx/test åè¾¹  
å³å®Œæ•´ç›®å½•è·¯å¾„ä¸ºï¼š /usr/local/nginx/test/static/** æ¼”ç¤ºæ•ˆæœå¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ea48800fdb14a909134a7b58a4df770~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3450&h=1912&s=1090431&e=png&b=fcfcfc)

### 15.5.2ã€alias

**alias** ä¸­æ–‡æ„æ€åˆ«åï¼Œè¿™ä¸ªå’Œrootæœ€å¤§åŒºåˆ«å°±æ˜¯ **ä¸ä¼šè¿›è¡Œæ‹¼æ¥**ï¼Œä¸‹è¾¹æˆ‘ä»¬æ”¹ä¸‹nginx.confæ–‡ä»¶æ¥æ¼”ç¤ºä¸‹ï¼š

bash

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`location /static { # æ³¨æ„ä¸€èˆ¬ aliasçš„ urléƒ½ä¸å¸¦åè¾¹çš„/      alias /usr/local/nginx/test/; # ä½¿ç”¨aliasæ—¶  è¿™é‡Œçš„ç›®å½•æœ€åè¾¹ä¸€å®šè¦åŠ / å¦åˆ™å°±404 }`

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/249189ce28f541e3838660b1b7fa0304~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1840&h=1052&s=176466&e=png&b=010101) ä¸Šè¾¹é…ç½®çš„æ„æ€å°±æ˜¯å½“å‰ä½ è®¿é—® [www.hzznb-xzll.xyz/static/imagâ€¦](https://link.juejin.cn?target=http%3A%2F%2Fwww.hzznb-xzll.xyz%2Fstatic%2Fimage2.jpg "http://www.hzznb-xzll.xyz/static/image2.jpg") æ—¶ï¼Œnginxä¼šå»aliasé…ç½®çš„è·¯å¾„ï¼š/usr/local/nginx/test/ç›®å½•ä¸‹æ‰¾ image2.jpg è¿™ä¸ªæ–‡ä»¶ä»è€Œè¿”å›ã€‚æ¯”å¦‚æˆ‘ç°åœ¨çš„/usr/local/nginx/test/ç›®å½•ä¸‹æ²¡æœ‰image2.jpg æ–‡ä»¶åˆ™è¿”å›404ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1ec27672ea1411eaacd9f29ddb11753~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3466&h=1592&s=681624&e=png&b=fafafa) ä¹‹åæˆ‘ä»¬copy image2.jpgæ–‡ä»¶åˆ° /usr/local/nginx/test/ ç›®å½•ï¼Œç„¶åçœ‹ä¸‹æ•ˆæœï¼š ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f8edf38a338f46c18d475ccf878ac5b7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3488&h=1642&s=1045818&e=png&b=fcfcfc) å¯ä»¥çœ‹åˆ°æˆåŠŸè¿”å›äº†ã€‚

### 15.5.3ã€proxy\_pass ä¸­çš„æ–œçº¿ä¸rootå’Œ aliasçš„ç›¸ä¼¼ä¹‹å¤„

åœ¨æˆ‘ä»¬ä¸Šè¾¹çš„è´Ÿè½½å‡è¡¡ä»¥åŠåŠ¨é™é”‹åˆ©ç­‰ç­‰æ¼”ç¤ºä¸­ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„proxy\_passçš„é…ç½®åŸºæœ¬ä¸Šéƒ½æ˜¯è¿™ä¹ˆé…çš„ï¼š

arduino

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`proxy_pass http://mybackendserver/`

è¿™é‡Œæœ‰ä¸ªä¸œè¥¿å’Œrootä¸aliasçš„è§„åˆ™å¾ˆåƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œä¹Ÿæä¸€ä¸‹ï¼Œå°±æ˜¯ [http://mybackendserver/](https://link.juejin.cn?target=http%3A%2F%2Fmybackendserver%2F "http://mybackendserver/") åè¾¹è¿™ä¸ªæ–œçº¿ /ï¼Œå¦‚æœä½ ä¸å†™ / åˆ™ä¼šå°†locationçš„urlæ‹¼æ¥åˆ°è·¯å¾„åè¾¹ï¼Œå¦‚æœä½ å†™äº†åˆ™ä¸ä¼šï¼Œä¸‹è¾¹æˆ‘ä»¬æ¼”ç¤ºä¸‹è¿™æ ·æ›´ç›´è§‚äº›ã€‚ä¿®æ”¹nginx.confå¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a7582c00a5314e2888ac4271628d0a3a~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1818&h=1176&s=283414&e=png&b=010101) interface è¿™ä¸ªlocationä¸ä¼šæ‹¼æ¥ interfaceåˆ° [http://mybackendserver/](https://link.juejin.cn?target=http%3A%2F%2Fmybackendserver%2F "http://mybackendserver/") åè¾¹ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ff6e676d27d403ca377fbe60999ab3c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3540&h=1626&s=694443&e=png&b=fafafa)

interface2 è¿™ä¸ªlocation **ä¼šæ‹¼æ¥** interface2åˆ° [http://mybackendserver/](https://link.juejin.cn?target=http%3A%2F%2Fmybackendserver%2F "http://mybackendserver/") åè¾¹ï¼ˆä»è€Œå¯¼è‡´æ¥å£404ï¼‰ï¼Œå¦‚ä¸‹ï¼š ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/211632b276484ed2a2521dea765f3521~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3544&h=1556&s=416346&e=png&b=fbfbfb)

**çœ‹å‡ºæ¥äº†å—ï¼Œproxy\_pass å€¼åè¾¹åŠ æ–œçº¿å’Œä¸åŠ æ–œçº¿ ï¼ŒåŒºåˆ«æ˜¯å¾ˆå¤§çš„ã€‚ä¸åŠ æ–œçº¿ æœ‰ç‚¹åƒrootï¼ˆä¼šæ‹¼æ¥ï¼‰ï¼ŒåŠ äº†æ–œçº¿ æœ‰ç‚¹åƒalias ï¼ˆä¸ä¼šè¿›è¡Œ æ‹¼æ¥ï¼‰ã€‚è¦ç‰¢è®°è¿™ä¸ªäº‹æƒ…ã€‚**

15.6ã€upstream ä¸­å¸¸ç”¨çš„å‡ ä¸ªæŒ‡ä»¤
----------------------

åœ¨upstreamä¸­ï¼Œæœ‰äº›æŒ‡ä»¤ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¹Ÿåˆ—ä¸€ä¸‹ï¼š

| å‚æ•° | æè¿° |
| --- | --- |
| server | åå‘æœåŠ¡åœ°å€ |
| weight | æƒé‡ |
| fail\_timeout | ä¸max\_failsç»“åˆä½¿ç”¨ã€‚ |
| max\_fails | è®¾ç½®åœ¨fail\_timeoutå‚æ•°è®¾ç½®çš„æ—¶é—´å†…æœ€å¤§å¤±è´¥æ¬¡æ•°ï¼Œå¦‚æœåœ¨è¿™ä¸ªæ—¶é—´å†…ï¼Œæ‰€æœ‰é’ˆå¯¹è¯¥æœåŠ¡å™¨çš„è¯·æ±‚éƒ½å¤±è´¥äº†ï¼Œé‚£ä¹ˆè®¤ä¸ºè¯¥æœåŠ¡å™¨ä¼šè¢«è®¤ä¸ºæ˜¯åœæœºäº†ã€‚ |
| max\_conns | å…è®¸æœ€å¤§è¿æ¥æ•° |
| fail\_time | æœåŠ¡å™¨ä¼šè¢«è®¤ä¸ºåœæœºçš„æ—¶é—´é•¿åº¦,é»˜è®¤ä¸º10s |
| backup | æ ‡è®°è¯¥æœåŠ¡å™¨ä¸ºå¤‡ç”¨æœåŠ¡å™¨ï¼Œå½“ä¸»æœåŠ¡å™¨åœæ­¢æ—¶ï¼Œè¯·æ±‚ä¼šè¢«å‘é€åˆ°å®ƒè¿™é‡Œã€‚ |
| down | æ ‡è®°æœåŠ¡å™¨æ°¸ä¹…åœæœºäº† |
| slow\_start | å½“èŠ‚ç‚¹æ¢å¤ï¼Œä¸ç«‹å³åŠ å…¥ |

16ã€é‡è¯•ç­–ç•¥
=======

16.1ã€æœåŠ¡ä¸å¯ç”¨é‡è¯•
------------

å…³äºé‡è¯•ç­–ç•¥æˆ‘ä»¬è¿™é‡Œä¹Ÿè¯´ä¸€ä¸‹ï¼Œé‡è¯•æ˜¯åœ¨å‘ç”Ÿé”™è¯¯æ—¶çš„ä¸€ç§ä¸å¯ç¼ºå°‘çš„æ‰‹æ®µï¼Œè¿™æ ·å½“æŸä¸€ä¸ªæˆ–è€…æŸå‡ ä¸ªæœåŠ¡å®•æœºæ—¶ï¼ˆå› ä¸ºæˆ‘ä»¬ç°åœ¨å¤§å¤šéƒ½æ˜¯å¤šå®ä¾‹éƒ¨ç½²ï¼‰ï¼Œå¦‚æœæœ‰æ­£å¸¸æœåŠ¡ï¼Œé‚£ä¹ˆå°†è¯·æ±‚ é‡è¯•åˆ°æ­£å¸¸æœåŠ¡çš„æœºå™¨ä¸Šå»ã€‚

ä¸‹è¾¹æˆ‘ä»¬å…ˆä¿®æ”¹ä¸‹nginx.confæ–‡ä»¶ï¼š

ini

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

    `upstream mybackendserver {         # 60ç§’å†… å¦‚æœè¯·æ±‚8081ç«¯å£è¿™ä¸ªåº”ç”¨å¤±è´¥         # 3æ¬¡ï¼Œåˆ™è®¤ä¸ºè¯¥åº”ç”¨å®•æœº æ—¶é—´åˆ°åå†æœ‰è¯·æ±‚è¿›æ¥ç»§ç»­å°è¯•è¿æ¥å®•æœºåº”ç”¨ä¸”ä»…å°è¯• 1 æ¬¡ï¼Œå¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œ         # åˆ™ç»§ç»­ç­‰å¾… 60 ç§’...ä»¥æ­¤å¾ªç¯ï¼Œç›´åˆ°æ¢å¤         server 172.30.128.64:8081 fail_timeout=60s max_fails=3;                   server 172.30.128.64:8082;         server 172.30.128.64:8083;     }`

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6183c53597d14a5bb8d8a35e46e9c5e7~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3466&h=1324&s=802033&e=png&b=020202)

16.2ã€é”™è¯¯é‡è¯•
---------

é”™è¯¯é‡è¯•æ˜¯ä½ å¯ä»¥é…ç½®å“ªäº›çŠ¶æ€ä¸‹ æ‰ä¼šæ‰§è¡Œé‡è¯•ï¼Œæ¯”å¦‚å¦‚ä¸‹è¿™ä¸ªé…ç½®ï¼š

bash

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

 `# æŒ‡å®šå“ªäº›é”™è¯¯çŠ¶æ€æ‰æ‰§è¡Œ é‡è¯• æ¯”å¦‚ä¸‹è¾¹çš„ error è¶…æ—¶ï¼Œ500,502,503 504 proxy_next_upstream error timeout http_500 http_502 http_503 http_504;`

æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨ideaå¯åŠ¨8082ç«¯å£ï¼Œç„¶åæ‰“ä¸ªæ–­ç‚¹è®©8082è¿™ä¸ªæœåŠ¡è¶…æ—¶ï¼ˆéªŒè¯ä¸‹è¶…æ—¶é‡è¯•ï¼‰ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š ![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0c5a45d2a9924e258417ca3ebff16556~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3184&h=1570&s=641853&e=png&b=fbfbfb) å¯ä»¥çœ‹åˆ°8082å› ä¸ºè¶…æ—¶ï¼Œé‡è¯•ç»™8081 ç„¶å8081ä¹Ÿä¸å¯ç”¨é‡è¯•ç»™8083 æœ€ç»ˆ8083è¿”å›æ•°æ®ã€‚

16.3ã€å…³äºbackup
-------------

Nginx æ”¯æŒè®¾ç½®å¤‡ç”¨èŠ‚ç‚¹ï¼Œå½“æ‰€æœ‰çº¿ä¸ŠèŠ‚ç‚¹éƒ½å¼‚å¸¸æ—¶ä¼šå¯ç”¨å¤‡ç”¨èŠ‚ç‚¹ï¼ŒåŒæ—¶å¤‡ç”¨èŠ‚ç‚¹ä¹Ÿä¼šå½±å“åˆ°å¤±è´¥ é‡è¯•çš„é€»è¾‘ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ backup æŒ‡ä»¤æ¥å®šä¹‰å¤‡ç”¨æœåŠ¡å™¨ï¼Œbackupæœ‰å¦‚ä¸‹ç‰¹å¾ï¼š

1.  æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¯·æ±‚ä¸ä¼šè½¬åˆ°åˆ° backup æœåŠ¡å™¨ï¼ŒåŒ…æ‹¬å¤±è´¥é‡è¯•çš„åœºæ™¯
2.  å½“æ‰€æœ‰æ­£å¸¸èŠ‚ç‚¹å…¨éƒ¨ä¸å¯ç”¨æ—¶ï¼Œbackup æœåŠ¡å™¨ç”Ÿæ•ˆï¼Œå¼€å§‹å¤„ç†è¯·æ±‚
3.  ä¸€æ—¦æœ‰æ­£å¸¸èŠ‚ç‚¹æ¢å¤ï¼Œå°±ä½¿ç”¨å·²ç»æ¢å¤çš„æ­£å¸¸èŠ‚ç‚¹
4.  backup æœåŠ¡å™¨ç”Ÿæ•ˆæœŸé—´ï¼Œä¸ä¼šå­˜åœ¨æ‰€æœ‰æ­£å¸¸èŠ‚ç‚¹ä¸€æ¬¡æ€§æ¢å¤çš„é€»è¾‘
5.  å¦‚æœå…¨éƒ¨ backup æœåŠ¡å™¨ä¹Ÿå¼‚å¸¸ï¼Œåˆ™ä¼šå°†æ‰€æœ‰èŠ‚ç‚¹ä¸€æ¬¡æ€§æ¢å¤ï¼ŒåŠ å…¥å­˜æ´»åˆ—è¡¨
6.  å¦‚æœå…¨éƒ¨èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ backupï¼‰éƒ½å¼‚å¸¸äº†ï¼Œåˆ™ Nginx è¿”å› 502 é”™è¯¯

æ¥ç€æˆ‘ä»¬ä¿®æ”¹ä¸‹nginx.confæ–‡ä»¶æ¼”ç¤ºä¸‹backupçš„ä½œç”¨ï¼š

ini

 ä»£ç è§£è¯»

å¤åˆ¶ä»£ç 

`upstream mybackendserver {     server 172.30.128.64:8081 fail_timeout=60s max_fails=3; # 60ç§’å†… å¦‚æœè¯·æ±‚æŸä¸€ä¸ªåº”ç”¨å¤±è´¥3æ¬¡ï¼Œåˆ™è®¤ä¸ºè¯¥åº”ç”¨å®•æœº æ—¶é—´åˆ°åå†æœ‰è¯·æ±‚è¿›æ¥ç»§ç»­å°è¯•è¿æ¥å®•æœºåº”ç”¨ä¸”ä»…å°è¯• 1 æ¬¡ï¼Œå¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œåˆ™ç»§ç»­ç­‰å¾… 60 ç§’...ä»¥æ­¤å¾ªç¯ï¼Œç›´åˆ°æ¢å¤     server 172.30.128.64:8082;     server 172.30.128.64:8083 backup; # è®¾ç½®8083ä½å¤‡æœº }`

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6f7717f7d6f1475cbbf666f5243dbe98~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3142&h=472&s=100351&e=png&b=000000)

ä¹‹åæˆ‘ä»¬å¯åŠ¨8081 8082 8083 ä¸‰ä¸ªæœåŠ¡ï¼Œç„¶åå…ˆåœæ‰8081 å†åœæ‰8082 çœ‹çœ‹æ•ˆæœï¼š

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/55b3edda22b947018964194635c76eec~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=3262&h=1764&s=767075&e=png&b=020202) å¯ä»¥çœ‹åˆ°å³ä½¿8081 ä¸å¯ç”¨ä¹Ÿåªæ˜¯å»8082é‡è¯•è€Œä¸ä¼šåˆ°å¤‡æœºé‡è¯•ï¼Œå¦‚æœ8081 8082éƒ½ä¸å¯ç”¨åˆ™è¯·æ±‚é‡è¯•åˆ°å¤‡æœºï¼š8083

17ã€æœ€å
=====

ä¸ºäº†æ–¹ä¾¿ç²˜è´´ä»¥åŠè§‚å¯Ÿï¼Œè¿™é‡Œè´´å‡ºæˆ‘æœºå™¨ä¸Šå®Œæ•´çš„ nginx.confæ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š

17.1ã€è´´å‡ºå®Œæ•´nginx.confæ–‡ä»¶
---------------------

```shell
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # log_format  debug  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';
    #
    log_format  debug  ' $remote_user [$time_local]  $http_x_Forwarded_for $remote_addr  $request '  
                      '$http_x_forwarded_for '  
                      '$upstream_addr '  
                      'ups_resp_time: $upstream_response_time '  
                      'request_time: $request_time'; 

    access_log  /var/log/nginx/access.log  debug;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    upstream mybackendserver {
        server 172.30.128.64:8081 fail_timeout=60s max_fails=3; # 60ç§’å†… å¦‚æœè¯·æ±‚æŸä¸€ä¸ªåº”ç”¨å¤±è´¥3æ¬¡ï¼Œåˆ™è®¤ä¸ºè¯¥åº”ç”¨å®•æœº æ—¶é—´åˆ°åå†æœ‰è¯·æ±‚è¿›æ¥ç»§ç»­å°è¯•è¿æ¥å®•æœºåº”ç”¨ä¸”ä»…å°è¯• 1 æ¬¡ï¼Œå¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œåˆ™ç»§ç»­ç­‰å¾… 60 ç§’...ä»¥æ­¤å¾ªç¯ï¼Œç›´åˆ°æ¢å¤
        server 172.30.128.64:8082;
        server 172.30.128.64:8083 backup; # è®¾ç½®8083ä½å¤‡æœº
    }

     # å¼€å¯/å…³é—­ å‹ç¼©æœºåˆ¶
    gzip on;
    # æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹© æ˜¯å¦å¼€å¯å‹ç¼©æœºåˆ¶
    gzip_types text/plain application/javascript text/css application/xml text/javascript image/jpeg image/jpg image/gif image/png  application/json;
    # è®¾ç½®å‹ç¼©çº§åˆ«ï¼Œè¶Šé«˜èµ„æºæ¶ˆè€—è¶Šå¤§è¶Šè€—æ—¶ï¼Œä½†å‹ç¼©æ•ˆæœè¶Šå¥½
    gzip_comp_level 9;
    # è®¾ç½®æ˜¯å¦æºå¸¦Vary:Accept-Encoding çš„å“åº”å¤´
    gzip_vary on;
    # å¤„ç†å‹ç¼©è¯·æ±‚çš„ ç¼“å†²åŒºæ•°é‡å’Œå¤§å°
    gzip_buffers 32 64k;
    # å¯¹äºä¸æ”¯æŒå‹ç¼©åŠŸèƒ½çš„å®¢æˆ·ç«¯è¯·æ±‚ ä¸å¼€å¯å‹ç¼©æœºåˆ¶
    gzip_disable "MSIE [1-6]\."; # æ¯”å¦‚ä½ç‰ˆæœ¬çš„IEæµè§ˆå™¨ä¸æ”¯æŒå‹ç¼©
    # è®¾ç½®å‹ç¼©åŠŸèƒ½æ‰€æ”¯æŒçš„HTTPæœ€ä½ç‰ˆæœ¬
    gzip_http_version 1.1;
    # è®¾ç½®è§¦å‘å‹ç¼©çš„æœ€å°é˜ˆå€¼
    gzip_min_length 2k;
    # off/any/expired/no-cache/no-store/private/no_last_modified/no_etag/auth æ ¹æ®ä¸åŒé…ç½®å¯¹åç«¯æœåŠ¡å™¨çš„å“åº”ç»“æœè¿›è¡Œå‹ç¼©
    gzip_proxied any;

    # æŒ‡å®šç¼“å­˜å­˜æ”¾ç›®å½•ä¸º/usr/local/nginx/test/nginx_cache_storageï¼Œå¹¶è®¾ç½®ç¼“å­˜åç§°ä¸ºmycacheï¼Œå¤§å°ä¸º64mï¼Œ 1å¤©æœªè¢«è®¿é—®è¿‡çš„ç¼“å­˜å°†è‡ªåŠ¨æ¸…é™¤ï¼Œç£ç›˜ä¸­ç¼“å­˜çš„æœ€å¤§å®¹é‡ä¸º1gb
    proxy_cache_path /usr/local/nginx/test/nginx_cache_storage levels=1:2 keys_zone=mycache:64m inactive=1d max_size=1g;
    # å¯¹è¯·æ±‚é€Ÿç‡é™æµ
    #limit_req_zone $binary_remote_addr zone=myRateLimit:10m rate=5r/s;
    # å¯¹è¯·æ±‚è¿æ¥æ•°é™æµ
    limit_conn_zone $binary_remote_addr zone=myConnLimit:10m; 
    
    # --------------------HTTP æ¼”ç¤º é…ç½®---------------------
    server {
      listen 80 default;
      charset utf-8;
      server_name www.hzznb-xzll.xyz hzznb-xzll.xyz;

      #location /static/ {
      #    root /usr/local/nginx/test;  # /usr/local/nginx/test/static/xxx.jpg
      #}

      location /static { # æ³¨æ„ä¸€èˆ¬ aliasçš„ urléƒ½ä¸å¸¦åè¾¹çš„/ 
          alias /usr/local/nginx/test/; # ä½¿ç”¨aliasæ—¶  è¿™é‡Œçš„ç›®å½•æœ€åè¾¹ä¸€å®šè¦åŠ / å¦åˆ™å°±404
      }
      # æµ‹è¯•autoindexæ•ˆæœ
      location /book/ {
          root /usr/local/nginx/test;
          autoindex on; # æ‰“å¼€ autoindexï¼Œï¼Œå¯é€‰å‚æ•°æœ‰ on | off
          autoindex_format html; # ä»¥htmlçš„æ–¹å¼è¿›è¡Œæ ¼å¼åŒ–ï¼Œå¯é€‰å‚æ•°æœ‰ html | json | xml
          autoindex_exact_size on; # ä¿®æ”¹ä¸ºoffï¼Œä¼šä»¥KBã€MBã€GBæ˜¾ç¤ºæ–‡ä»¶å¤§å°ï¼Œé»˜è®¤ä¸ºonä»¥bytesæ˜¾ç¤ºå‡ºâ½‚ä»¶çš„ç¡®åˆ‡â¼¤â¼©
          autoindex_localtime off; # æ˜¾ç¤ºâ½‚ä»¶æ—¶é—´ GMTæ ¼å¼
      }
      
      # ä¸´æ—¶é‡å®šå‘
      location /temp_redir {
          rewrite ^/(.*) https://www.baidu.com redirect;
      }
      # æ°¸ä¹…é‡å®šå‘
      location /forever_redir {
          
          rewrite ^/(.*) https://www.baidu.com permanent;
      }
      # rewrite lastè§„åˆ™æµ‹è¯•
      location /1 {
        rewrite /1/(.*) /2/$1 last;
      }
      location /2 {
        rewrite /2/(.*) /3/$1 last;
      }
      location /3 {
        alias  '/usr/local/nginx/test/static/';
        index location_last_test.html; 
      }
    }

    # --------------------HTTPé…ç½®---------------------
    server {
      listen 80;
      charset utf-8;
      #server_name www.xxxadminsystem.com;
      server_name www.hzznbc-xzll.xyz hzznbc-xzll.xyz;
      # é‡å®šå‘ï¼Œä¼šæ˜¾ç¤ºè·³è½¬çš„åœ°å€server_name,å¦‚æœè®¿é—®çš„åœ°å€æ²¡æœ‰åŒ¹é…ä¼šé»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªï¼Œå³www.likeong.icu
      return 301 https://$server_name$request_uri;

        # # æŒ‡å®š username å‚æ•°ä¸­åªè¦æœ‰å­—æ¯ å°±ä¸èµ°nginxç¼“å­˜  
        # if ($arg_username ~ [a-z]) {
        #     set $cache_name "no cache";
        # }
        # # å‰ç«¯é¡µé¢èµ„æº
        # location  /page {
        #   alias  '/usr/local/nginx/test/static/';
        #   index index_page.html; 

        #   allow all;
        # }
        # # åç«¯æœåŠ¡
        # location  /interface {
        #   proxy_pass http://mybackendserver/;
        #   # ä½¿ç”¨åä¸º mycache çš„ç¼“å­˜ç©ºé—´
        #   proxy_cache mycache;
        #   # å¯¹äº200 206 çŠ¶æ€ç çš„æ•°æ®ç¼“å­˜2åˆ†é’Ÿ
        #   proxy_cache_valid 200 206 1m;
        #   # å®šä¹‰ç”Ÿæˆç¼“å­˜é”®çš„è§„åˆ™ï¼ˆè¯·æ±‚çš„url+å‚æ•°ä½œä¸ºç¼“å­˜keyï¼‰
        #   proxy_cache_key $host$uri$is_args$args;
        #   # èµ„æºè‡³å°‘è¢«é‡å¤è®¿é—®2æ¬¡åå†åŠ å…¥ç¼“å­˜
        #   proxy_cache_min_uses 3;
        #   # å‡ºç°é‡å¤è¯·æ±‚æ—¶ï¼Œåªè®©å…¶ä¸­ä¸€ä¸ªå»åç«¯è¯»æ•°æ®ï¼Œå…¶ä»–çš„ä»ç¼“å­˜ä¸­è¯»å–
        #   proxy_cache_lock on;
        #   # ä¸Šé¢çš„é” è¶…æ—¶æ—¶é—´ä¸º4sï¼Œè¶…è¿‡4sæœªè·å–æ•°æ®ï¼Œå…¶ä»–è¯·æ±‚ç›´æ¥å»åç«¯
        #   proxy_cache_lock_timeout 4s;
        #   # å¯¹äºè¯·æ±‚å‚æ•°ä¸­æœ‰å­—æ¯çš„ ä¸èµ°nginxç¼“å­˜
        #   proxy_no_cache $cache_name; # åˆ¤æ–­è¯¥å˜é‡æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼åˆ™ä¸è¿›è¡Œç¼“å­˜ï¼Œæ²¡æœ‰å€¼åˆ™è¿›è¡Œç¼“å­˜
        #   # åœ¨å“åº”å¤´ä¸­æ·»åŠ ä¸€ä¸ªç¼“å­˜æ˜¯å¦å‘½ä¸­çš„çŠ¶æ€ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
        #   add_header Cache-status $upstream_cache_status;
          
        #   limit_conn myConnLimit 12;

        # limit_req zone=myRateLimit burst=5  nodelay;
        # limit_req_status 520;
        # limit_req_log_level info;
        #}  
    }

    # --------------------HTTPS é…ç½®---------------------
    server {
        #SSL é»˜è®¤è®¿é—®ç«¯å£å·ä¸º 443
        listen 443 ssl; 
        #å¡«å†™ç»‘å®šè¯ä¹¦çš„åŸŸå 
        server_name www.hzznb-xzll.xyz hzznb-xzll.xyz; 
        #è¯·å¡«å†™è¯ä¹¦æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„
        ssl_certificate /usr/local/nginx/certificate/hzznb-xzll.xyz_bundle.crt; 
        #è¯·å¡«å†™ç§é’¥æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„
        ssl_certificate_key /usr/local/nginx/certificate/hzznb-xzll.xyz.key; 
        #åœæ­¢é€šä¿¡æ—¶ï¼ŒåŠ å¯†ä¼šè¯çš„æœ‰æ•ˆæœŸï¼Œåœ¨è¯¥æ—¶é—´æ®µå†…ä¸éœ€è¦é‡æ–°äº¤æ¢å¯†é’¥
        ssl_session_timeout 5m;
        #æœåŠ¡å™¨æ”¯æŒçš„TLSç‰ˆæœ¬
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; 
        #è¯·æŒ‰ç…§ä»¥ä¸‹å¥—ä»¶é…ç½®ï¼Œé…ç½®åŠ å¯†å¥—ä»¶ï¼Œå†™æ³•éµå¾ª openssl æ ‡å‡†ã€‚
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; 
        #å¼€å¯ç”±æœåŠ¡å™¨å†³å®šé‡‡ç”¨çš„å¯†ç å¥—ä»¶
        ssl_prefer_server_ciphers on;
        
        # æŒ‡å®š username å‚æ•°ä¸­åªè¦æœ‰å­—æ¯ å°±ä¸èµ°nginxç¼“å­˜  
        if ($arg_username ~ [a-z]) {
            set $cache_name "no cache";
        }
        # å‰ç«¯é¡µé¢èµ„æº
        location  /page {
          alias  '/usr/local/nginx/test/static/';
          index index_page.html; 

          allow all;
        }
        # åç«¯æœåŠ¡
        location  /interface {
          proxy_pass http://mybackendserver/;

          # æŒ‡å®šå“ªäº›é”™è¯¯çŠ¶æ€æ‰æ‰§è¡Œ é‡è¯•
          proxy_next_upstream error timeout http_500 http_502 http_503 http_504 http_404;


          # ä½¿ç”¨åä¸º mycache çš„ç¼“å­˜ç©ºé—´
          proxy_cache mycache;
          # å¯¹äº200 206 çŠ¶æ€ç çš„æ•°æ®ç¼“å­˜2åˆ†é’Ÿ
          proxy_cache_valid 200 206 1m;
          # å®šä¹‰ç”Ÿæˆç¼“å­˜é”®çš„è§„åˆ™ï¼ˆè¯·æ±‚çš„url+å‚æ•°ä½œä¸ºç¼“å­˜keyï¼‰
          proxy_cache_key $host$uri$is_args$args;
          # èµ„æºè‡³å°‘è¢«é‡å¤è®¿é—®2æ¬¡åå†åŠ å…¥ç¼“å­˜
          proxy_cache_min_uses 3;
          # å‡ºç°é‡å¤è¯·æ±‚æ—¶ï¼Œåªè®©å…¶ä¸­ä¸€ä¸ªå»åç«¯è¯»æ•°æ®ï¼Œå…¶ä»–çš„ä»ç¼“å­˜ä¸­è¯»å–
          proxy_cache_lock on;
          # ä¸Šé¢çš„é” è¶…æ—¶æ—¶é—´ä¸º4sï¼Œè¶…è¿‡4sæœªè·å–æ•°æ®ï¼Œå…¶ä»–è¯·æ±‚ç›´æ¥å»åç«¯
          proxy_cache_lock_timeout 4s;
          # å¯¹äºè¯·æ±‚å‚æ•°ä¸­æœ‰å­—æ¯çš„ ä¸èµ°nginxç¼“å­˜
          proxy_no_cache $cache_name; # åˆ¤æ–­è¯¥å˜é‡æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼åˆ™ä¸è¿›è¡Œç¼“å­˜ï¼Œæ²¡æœ‰å€¼åˆ™è¿›è¡Œç¼“å­˜
          # åœ¨å“åº”å¤´ä¸­æ·»åŠ ä¸€ä¸ªç¼“å­˜æ˜¯å¦å‘½ä¸­çš„çŠ¶æ€ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
          add_header Cache-status $upstream_cache_status;
          
          limit_conn myConnLimit 12;

        # limit_req zone=myRateLimit burst=5  nodelay;
        # limit_req_status 520;
        # limit_req_log_level info;
        } 

        # åç«¯æœåŠ¡
        location  /interface2 {
          proxy_pass http://mybackendserver;
          # ä½¿ç”¨åä¸º mycache çš„ç¼“å­˜ç©ºé—´
          proxy_cache mycache;
          # å¯¹äº200 206 çŠ¶æ€ç çš„æ•°æ®ç¼“å­˜2åˆ†é’Ÿ
          proxy_cache_valid 200 206 1m;
          # å®šä¹‰ç”Ÿæˆç¼“å­˜é”®çš„è§„åˆ™ï¼ˆè¯·æ±‚çš„url+å‚æ•°ä½œä¸ºç¼“å­˜keyï¼‰
          proxy_cache_key $host$uri$is_args$args;
          # èµ„æºè‡³å°‘è¢«é‡å¤è®¿é—®2æ¬¡åå†åŠ å…¥ç¼“å­˜
          proxy_cache_min_uses 3;
          # å‡ºç°é‡å¤è¯·æ±‚æ—¶ï¼Œåªè®©å…¶ä¸­ä¸€ä¸ªå»åç«¯è¯»æ•°æ®ï¼Œå…¶ä»–çš„ä»ç¼“å­˜ä¸­è¯»å–
          proxy_cache_lock on;
          # ä¸Šé¢çš„é” è¶…æ—¶æ—¶é—´ä¸º4sï¼Œè¶…è¿‡4sæœªè·å–æ•°æ®ï¼Œå…¶ä»–è¯·æ±‚ç›´æ¥å»åç«¯
          proxy_cache_lock_timeout 4s;
          # å¯¹äºè¯·æ±‚å‚æ•°ä¸­æœ‰å­—æ¯çš„ ä¸èµ°nginxç¼“å­˜
          proxy_no_cache $cache_name; # åˆ¤æ–­è¯¥å˜é‡æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼åˆ™ä¸è¿›è¡Œç¼“å­˜ï¼Œæ²¡æœ‰å€¼åˆ™è¿›è¡Œç¼“å­˜
          # åœ¨å“åº”å¤´ä¸­æ·»åŠ ä¸€ä¸ªç¼“å­˜æ˜¯å¦å‘½ä¸­çš„çŠ¶æ€ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
          add_header Cache-status $upstream_cache_status;
          
          limit_conn myConnLimit 12;

        # limit_req zone=myRateLimit burst=5  nodelay;
        # limit_req_status 520;
        # limit_req_log_level info;
        } 

    }

    # include /etc/nginx/conf.d/*.conf;
}


```

17.2ã€ä¸ªäººçµ®å¨
---------

è¿™ç¯‡æ–‡ç« å†™äº†å‰åæœ‰20å¤©ï¼Œä¸­é—´é‡åˆ°å¾ˆå¤šçš„é—®é¢˜ï¼Œéƒ½ä¸€ä¸€è§£å†³äº†ï¼Œåˆ°è¿™é‡Œæˆ‘æ„Ÿåˆ°æ”¶è·é¢‡å¤šï¼Œå› ä¸ºæˆ‘ä¹‹å‰å¯¹nginxè¯´å®è¯äº†è§£çš„å¹¶ä¸å¤šï¼Œè¿™ç¯‡æ–‡ç« ä¹ŸåŸºæœ¬è¡¥é½äº†å¯¹nginxçš„è®¤è¯†å’Œä½¿ç”¨ã€‚å¦å¤–å€¼çš„ä¸€è¯´çš„æ˜¯ï¼Œnginxå¯ä¸æ­¢æœ¬æ–‡è¿™äº›ä¸œè¥¿ï¼ŒåŠŸèƒ½æµ·äº†å»äº†ï¼Œæ›´å¤šçš„è¯·æŸ¥é˜…nginxå®˜ç½‘ï¼Œé‡Œè¾¹æ¯ä¸€ä¸ªæ¨¡å—ï¼Œæ¯ä¸€ä¸ªæŒ‡ä»¤ä»¥åŠä½œç”¨éƒ½è¯´çš„æ¸…æ¸…æ¥šæ¥šï¼Œå®˜ç½‘æˆ³è¿™é‡Œï¼š[nginxå®˜ç½‘æ–‡æ¡£](https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2F "https://nginx.org/en/docs/") ã€‚

* * *

å¦‚æœæœ¬æ–‡å¯¹ä½ æœ‰å¸®åŠ©æˆ–å¯å‘è¯·å¸®å¿™ç‚¹ä¸ªèµğŸ‘ ğŸ‘ ï¼Œè°¢è°¢ğŸ˜‹ğŸ˜‹~~

æœ¬æ–‡è½¬è‡ª <https://juejin.cn/post/7306041273822527514>ï¼Œå¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ã€‚