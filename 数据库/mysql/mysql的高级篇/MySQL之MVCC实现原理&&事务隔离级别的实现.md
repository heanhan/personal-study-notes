

## MySQL之MVCC实现原理&&事务隔离级别的实现

#### MVCC :多版本并发控制

- 其中多版本指的是一条记录的多个版本
- 并发控制 是mvcc 是用更好的方式来提高并发性能避免加锁。

通过版本链来控制并发事务访问同一个记录是的行为就叫MVCC

#### 前置知识：当前读、快照读

```
1、加锁的读，则是当前读，另外 update、insert、delete也是当前读
2、快照读，我们平时简单的select语句就是不加锁

注意：串行化的隔离级别下，快照读会退化为当前读
```

- **当前读**

​	读取的记录是最新的，读取时还要保证其他的并发事务不能修改当前记录，会对读取的记录进行加锁，对于我们日常的操作，如：select ... lock in share mode(共享锁)，select ... for update ,insert 、delect.都是一种当前读。

- **快照读**

​	简单的select(不加锁) 就是快照读，读取的时记录数据的可见的版本，不加锁，是非阻塞的读。

- **MVCC**

​	多版本并发控制，指维护一个数据的多版本，是的读写操作没有冲突，快照读为MYSQL实现MVCC提供了一个非阻塞的读功能，mvcc的具体实现还需要依赖数据库记录中的三个隐式字段、undolog、readview

#### MVCC的作用

解决 读-写、冲突的无锁并发控制，每次对A记录的写操作，都会给A保存一个快照版本

#### MVCC实现原理

##### 1、记录中的隐藏字段

InnoDB 里面每个事务有一个唯一的事务 ID，叫作 transaction id。它是在事务开始的时候向 InnoDB 的事务系统申请的，是**按申请顺序严格递增的**。而**每行数据也都是有多个版本**的。每次事务更新数据的时候，都会生成一个新的数据版本，并且把 transaction id 赋值给这个数据版本的事务 ID，记为 **row trx_id**【也就是下图的DB_TRX_ID】。同时，旧的数据版本要保留，并且在新的数据版本中，能够有信息可以直接拿到它。