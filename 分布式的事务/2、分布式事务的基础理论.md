### 2、分布式事务的基础理论

#### 2.1 CAP理论

##### 2.1.1 理解CAP

C (一致性)、A（可用性）、P（分区容错）

**一致性**

概念：指写操作后的读操作，可以读到嘴型的数据状态，当数据分布在不同的节点上，从任意节点读到的数据都是最新的

###### 如何实现一致性？

- 写如主数据后将数据同步到从数据库
- 写入主数据库后，在向从数据库同步期间，要将从数据库锁定，待同步完成后再释放锁，一面在写新数据库成功后，向从数据库查询到旧数据。

###### 分布式系统一致性的特点

- 由于存在数据同步过程，写操作的响应应会有一定的延迟。
- 为了保证数据的一致性，会有资源暂时锁定，带数据完成同步后释放锁定的资源
- 如果有请求数据同步失败的节点，会返回错误的信息，一定不会返回旧数据。

**可用性**

**概念**：任何事务操作都可以得到响应结果，且不会出现响应超时的响应错误。

###### 如何实现可用性？

- 写入主数据后，要讲数据同步到从数据库。
- 由于要保证从数据库的可用性，不可将从数据库的资源锁定。
- 即使数据没有同步过来，从数据库也要返回查询的旧数据，哪怕是就数据，如果连旧数据也没有则可以按照约定，返回一个默认信息。凡事不能返回错误信息。

###### 分布式系统的可用性的特点

- 所有请求都有响应，且不会出现超时响应的错误。

**分区容错性**

**概念**：通常分布式系统的各个节点部署在不同的服务器，这就需要网络分区，可可避免的出现由于网络问题，而导致节点之间通信失败，此时人可以对外服务，这叫分区容错性。

###### 如何实现分区容错性？

- 尽量使用异步通信代替同步，例如使用异步方式将数据库主库同步到从库，这样节点之间能有效的实现松耦合
- 添加从数据库节点，其中一个几点挂掉其他节点仍可以服务。

**注**：分区容错性是分布式系统具备的基本能力。

**CAP组合方式**

在具备P的前提下，C和A是不能共存的。

**解释**：满足分区容错的前提 是必须的原因

- 主数据库通过网络向从数据同步数据，可以认为从数据库不是在不同的分区，通过网络进行交互。
- 当数据库和从数据库的网络出现问题，不影响主数据库和从数据库对外提供服务。
- 其中一个节点挂掉，不影响另一个节点对外提供服务。

如果实现C则必须从任意节点获取数据的一致性，在数据库主从同步时防止向主数据库添加新数据，则则需要将从数据库锁定，待同步完成后解锁，如果同步失败，从数据库返回错误信息和超时信息。

如果实现A,则必须保证任意节点的数据可用性，不管任何时候都可以向从数据库中查询数据，则不会出现响应超时或者错误信息。

###### AP或者CP

**AP**：放弃一致性，追求分区容错和可用性，这是较多分布式系统或者中间件采用的 如Eureka

**CP:** 放弃可用性，追求数据的一致性，和分区容错性。如zookeeper其实就是追求强一致性。



#### 2.2 BASE理论

##### 1、理解强一致性的最终一致性

CAP理论告诉我们一个分布式系统最多只能同时满足一致性可用性和分区容错性中的两项。

CAP中的一致性要求的强一致性，但最终一致性允许在一定时间内每个节点的数据不一致，但是经过一段时间后每个节点必须保证一致。

##### 2、Base 是 Basically Availibale(基本可用)、soft status(软状态)和Eventually Consitent(最终一致性)

Base理论是CAP理论的一个补充，通过牺牲一定的一致性，来获得可用性。当出现故障，允许部分不可用的但要保证核心功能可用，允许数据在一段时间内的一致性，但最终达到一致状态，满足Base理论，我们称为 软性事务。

**基本可用：** 分布式系统出现故障，允许损失部分可用功能，保证核心功能可用。

**软状态：**由于不要求强一致性，所有Base允许系统存在中间状态，这个状态不影响系统的可用性。

**最终一致性：**指经过一段时间后，所有的节点的数据会达到一致性。