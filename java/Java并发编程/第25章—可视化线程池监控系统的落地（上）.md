在前边的理论章节中，我们介绍了线程池的原理和使用注意点，但并没有过多地对线程池进行研究，这节课，我们将学习如何对线程池进行监控，做二次开发。

## 需求背景

随着业务系统的不断变化，系统所要接收的流量开始越来越大，代码也开始变得越来越复杂。程序员们在编程中使用到线程池去实现异步编程的频率也越来越高。例如下边几个案例：

-   用户在直播间送礼之后，需要后台异步计算礼物扣款。

<!---->

-   用户进入 App 首页时，需要拉取推荐数据、读取用户基础资料、根据不同的策略去渲染 App 的界面等等，各个环节都采用异步计算，最后合并结果的思路实现。

上述的几个场景都适合使用 JDK 自带的线程池去实现，但是在使用时可能会存在一些问题。

-   线程池的负载情况没法明确查看；

<!---->

-   线程池的属性没法动态修改；

<!---->

-   线程池负载高了之后没有预警通知；

<!---->

-   对于线程池内任务执行情况没有明确记录。

基于现存的这些技术难点，我尝试开发了一套线程池监控平台（已经有在工作中落地成功了），并且打算将它们和大家进行技术分享，希望能对大家有所帮助。



整个监控平台的前端部分是基于 element-ui + vue.js + e-chart.js + 一套网上的后台管理开源系统进行简单改造。入门门槛较低，只需要了解基础的 JS、CSS、HTML 即可上手，比较适合后端程序员开发。监控平台主要负责从指定的 Redis 机器拉取数据，只做读操作，然后将线程池上报的数据统一进行渲染。下边让我们来看看监控平台的前端实现部分逻辑吧。



### 实时数据条件查询

首先是线程池监控的一个统计图界面，该界面中记录了各个线程池的动态属性信息。并且可以根据服务的具体 IP + 端口，以及线程池的名称来进行查询。

这里我选择使用了 **应用服务名称 + 服务地址 + 线程池名称 + 日期** **，** 去定位到对应的线程池存储在 Redis 中的数据。下边我解释下这几个参数的具体含义：

-   **服务名称**：其实就是 SpringBoot 启动时候的 spring.application.name 参数值，通过它可以定位到具体的服务集群。

<!---->

-   **服务地址**：这个就是该服务实际部署起来之后的 IP 地址，还有端口号，如果是部署在 k8s 中的话，记住要使用 Pod 的 IP 地址，而不是选用 Node 的地址（其实通过 Spring 容器获取的地址默认都是 Pod 地址）。

<!---->

-   **线程池名称**：线程池名称其实很好理解，线程池其实本身也是以一个 Bean 的方式存放在 Spring 容器中，而这个 Bean 的名称就是线程池的名称。

<!---->

-   **日期**：由于线程池监控的数据是按照天来划分存储位置的，在存储到 Redis 时，将日期作为 key 的一部分。

了解了参数的作用之后，让我们来看看监控的界面，具体的监控界面如下所示：

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/50c090a743504a6a8959a1383bfd2622~tplv-k3u1fbpfcp-watermark.image?)

默认情况下，监控平台是静态加载的模式（只会拉取一次数据渲染统计图，接下来不会动态变化），如果要开启动态加载的话，需要点击下边图中框住的部分。


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7dc109512f0849778e3416ba4127dad8~tplv-k3u1fbpfcp-watermark.image?)

### 统计图页面

在实时数据页面中，我们重点需要关注的是线程池**工作中的线程数** **、** **任务队列的长度** **、** **线程池单位时间内的任务处理量** **、** **异常任务量，以及带有标签的任务记录频率。** 这方面我使用了 Echart 的统计图组件来进行数据的渲染，具体样式如下图所示：


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f1601d5fe4314dfa880c634b855b1032~tplv-k3u1fbpfcp-watermark.image?)


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a03b13956ba94c5e828e3ea13cb5f7cd~tplv-k3u1fbpfcp-watermark.image?)

如果开启实时加载功能的话，管理台会定时轮询统计图接口，从而给人一种数据在实时变化的效果。

这里我选用的是 Echart 的统计图样式，相关的 demo 地址如下：

https://echarts.apache.org/examples/zh/editor.html?c=area-simple


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/32505e5ba22a4607a46fe5dd729f4fe6~tplv-k3u1fbpfcp-watermark.image?)

如果你希望使用这些统计图去渲染具体效果的话，可能需要掌握一些前端的技巧来进行实现。不过整体难度其实并不高，只需要返回两个数组格式的参数给到统计图渲染函数中，接下来就可以看到效果了。


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/797eb029c23c431d821dc6aebd524ce1~tplv-k3u1fbpfcp-watermark.image?)

对于监控平台中展示的数据，目前是只限制7天的查询时间，对于存储的时间限制这块，可以根据具体的业务场景来设定。这一块全部记录在了 org.idea.threadpool.monitor.report.redis.RedisAsyncReporter 类中的上报函数内：


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/708ae1593cae45c7bff7a1e7dfe9df8b~tplv-k3u1fbpfcp-watermark.image?)


### 线程池配置和告警页面

在这个页面中，支持根据服务名称去查询其内部的线程池配置信息，其具体效果如下所示：


![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a71565c2575641548209a2b784cec993~tplv-k3u1fbpfcp-watermark.image?)

汇总页面中，告警阈值的含义是指，当“任务阻塞队列中 任务数 / 队列的长度”大于该值，则会发送告警邮件，通知到对应的监控人员邮箱中。邮件通知如下所示：


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6e67601afb3480e92bddfe9a2518704~tplv-k3u1fbpfcp-watermark.image?)

会有一个统一的页面查看告警信息，里面记录了不同服务和告警邮件之间的映射关系，具体页面如下：


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f3048060a80649fdb6108d3220dcec70~tplv-k3u1fbpfcp-watermark.image?)

告警这块，其实可以结合自己的业务场景进行扩展，除了邮件通知之外，我们也可以选用一些企业办公软件的通知功能，例如下图是采用企业微信通知的方式进行实现（本节的代码中使用的是邮件通知方式）。


![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7362bbce57414bd3a93e41711a5bead7~tplv-k3u1fbpfcp-watermark.image?)


### 任务执行记录页面

我们可以对执行的任务进行一个标签的划分，例如订单支付逻辑被放在了异步线程池中处理，那么可以定义一个标签，叫做“订单支付”，然后记录下线程池执行这个任务的耗时情况，执行结果状态等数据。


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fee2037614f0404f82dde0d89ae0c0f7~tplv-k3u1fbpfcp-watermark.image?)

在任务执行记录页面中，可以支持根据应用名称搜寻对应的任务列表数据。另外还支持通过任务id搜索到对应的任务记录。这里我们可以做一些扩展设计，例如当点击jobid的时候跳转到elk平台去查看该任务的执行流程。而且，如果业务服务本身带有全链路id的话，这列的jobid可以和全链路id进行统一，这样使其更具具有业务含义。


![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a84c9ce61c6a4d55a61b88539aec6394~tplv-k3u1fbpfcp-watermark.image?)

### 动态管理线程池配置

线程池对象在 Spring 容器中，本质其实还是一个 Bean 对象，因此其属性的装配是可以统一抽象出来的。在设计线程池监控的时候，我选择了 Nacos 作为配置中心进行管理，之所以选择它的原因如下：

-   Nacos 支持动态刷新 Spring 容器内部属性值，并且有良好的开源文档；

<!---->

-   Nacos 在大多数互联网企业中都有被使用，如果工作环境中本身就有搭建好的 Nacos 平台，直接拿来使用可以减少重复造轮子的时间。

下边是Nacos 中配置的动态线程池属性截图：


![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dea8ec8f437144549b2df4dea52fbe1f~tplv-k3u1fbpfcp-watermark.image?)


## 课后小结

本章节中，我主要和大家介绍了自己曾经设计过的线程池监控平台，其主要功能有：

-   动态修改线程池属性；

<!---->

-   实时监控线程池的各项指标数据；

<!---->

-   设置线程池负载瓶颈，实现监控预警功能；

<!---->

-   支持任务标签功能，给需要关注的任务打上标签，并且记录下其执行的过程信息。

这些功能都是结合自己过去工作中遇到的一些痛点而设计的，如果各位同学有什么更好的点子，也可以在评论区中提出。

在下一章节中，我们将一同深入研究如何实现这样一款线程池监控平台，并且附上相关的源代码实现。

## 课后思考

**上节课答疑**

在上节课的末尾，我留下来一道关于日志包组件冲突的思考题。这里我推荐一篇写得不错的文章和大家分享，希望能帮助到大家。文章地址如下：

https://juejin.cn/post/6844904160920354823




**本章节思考**

如果需要计算线程池中每个任务的执行耗时，你有什么思路吗，欢迎在评论区中给出你的答案。

